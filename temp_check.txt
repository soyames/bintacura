# -*- coding: utf-8 -*-
"""
Multi-Region Database Router for BINTACURA Platform
Enables multi-region architecture with AWS RDS and Render PostgreSQL databases
"""
from django.conf import settings


class RegionalDatabaseRouter:
    """
    Routes database operations to regional databases based on deployment region.
    
    Architecture:
    - AWS RDS (Stockholm): Primary database (alias: 'default')
    - Render PostgreSQL (Frankfurt): Secondary/fallback database (alias: 'frankfurt')
    
    When ENABLE_MULTI_REGION=True:
    - Migrations run on both databases
    - Read/write operations use 'default' database
    - 'frankfurt' database serves as backup and for Render deployments
    
    Usage:
    1. Set ENABLE_MULTI_REGION=True in .env
    2. Configure both DB_* and DB_FRANKFURT_* variables
    3. Run migrations: python manage.py migrate --database=default
    4. Run migrations: python manage.py migrate --database=frankfurt
    """
    
    # Apps that should always use the central database
    CENTRAL_APPS = {
        'admin',
        'auth',
        'contenttypes',
        'sessions',
        'sync',
    }
    
    # Apps that replicate across regional databases
    REGIONAL_APPS = {
        'core',
        'authentication',
        'patient',
        'doctor',
        'appointments',
        'prescriptions',
        'health_records',
        'communication',
        'payments',
        'pharmacy',
        'hospital',
        'insurance',
        'analytics',
        'ads',
        'currency_converter',
        'financial',
        'hr',
        'ai',
        'qrcode_generator',
        'queue_management',
        'transport',
    }
    
    def __init__(self):
        """Initialize router with deployment region."""
        self.deployment_region = getattr(settings, 'DEPLOYMENT_REGION', 'eu-north-1')
        self.enable_multi_region = getattr(settings, 'ENABLE_MULTI_REGION', False)
    
    def db_for_read(self, model, **hints):
        """
        Route read operations to appropriate database.
        
        Args:
            model: The model being queried
            **hints: Additional routing hints (e.g., instance, database)
        
        Returns:
            str: Database alias to use, or None for default routing
        """
        app_label = model._meta.app_label
        
        # Always use default database for admin apps
        if app_label in self.CENTRAL_APPS:
            return 'default'
        
        # Check if model explicitly specifies a database
        if hasattr(model, '_database_override'):
            return model._database_override
        
        # Check hints for explicit database
        if 'database' in hints:
            return hints['database']
        
        # For regional apps, use default database
        # Both databases have same schema due to migrations
        return 'default'
        
        Args:
            model: The model being queried
            **hints: Additional routing hints (e.g., instance)
        
        Returns:
            str: Database alias to use, or None for default routing
        """
        app_label = model._meta.app_label
        
        # Always use central database for admin apps
        if app_label in self.CENTRAL_APPS:
            return 'default'
        
        # Check if model explicitly specifies a database
        if hasattr(model, '_database_override'):
            return model._database_override
        
        # Check hints for explicit database
        if 'database' in hints:
            return hints['database']
        
        # Route regional apps to appropriate database
        if app_label in self.REGIONAL_APPS:
            region = self.get_region_from_request()
            return self.regional_databases.get(region, {}).get('alias', 'default')
        
        return 'default'
    
    def db_for_write(self, model, **hints):
        """
        Route write operations to appropriate database.
        
        Same logic as db_for_read to ensure consistency.
        """
        return self.db_for_read(model, **hints)
    
    def allow_relation(self, obj1, obj2, **hints):
        """
        Determine if a relation between obj1 and obj2 is allowed.
        
        Relations are allowed if:
        1. Both objects are in the same database
        2. One is in central DB and other in regional DB (for lookups)
        """
        db1 = self.db_for_read(obj1.__class__)
        db2 = self.db_for_read(obj2.__class__)
        
        # Same database - always allow
        if db1 == db2:
            return True
        
        # One in central, one in regional - allow (for auth, etc.)
        if 'default' in (db1, db2):
            return True
        
        # Different regional databases - disallow
        return False
    
    def allow_migrate(self, db, app_label, model_name=None, **hints):
        """
        Determine if migrations should run on a given database.
        
        When ENABLE_MULTI_REGION=True:
        - All apps migrate on both 'default' and 'frankfurt' databases
        - This keeps schemas synchronized across regions
        
        Args:
            db: Database alias ('default' or 'frankfurt')
            app_label: App being migrated
            model_name: Model being migrated (optional)
        
        Returns:
            bool: True if migration should run, None for default behavior
        """
        if not self.enable_multi_region:
            # Single database mode - allow all migrations on default
            return db == 'default'
        
        # Multi-region mode - migrate all apps on both databases
        # This ensures both AWS and Render databases have identical schemas
        return db in ('default', 'frankfurt')


class ReadReplicaRouter:
    """
    Routes read operations to read replicas for better performance.
    
    Usage:
    1. Configure read replica databases (e.g., 'default_replica')
    2. Add this router AFTER RegionalDatabaseRouter
    """
    
    def db_for_read(self, model, **hints):
        """Route reads to replica if available."""
        if hasattr(settings, 'READ_REPLICA_DB'):
            # Don't use replica for write-sensitive models
            if hasattr(model, '_no_read_replica') and model._no_read_replica:
                return None
            return settings.READ_REPLICA_DB
        return None
    
    def db_for_write(self, model, **hints):
        """Always write to primary database."""
        return None
    
    def allow_relation(self, obj1, obj2, **hints):
        """Allow all relations (defer to other routers)."""
        return None
    
    def allow_migrate(self, db, app_label, model_name=None, **hints):
        """Don't migrate on read replicas."""
        if hasattr(settings, 'R
