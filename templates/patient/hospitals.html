{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√¥pitaux - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/patient.css' %}">
    <link rel="stylesheet" href="{% static 'css/hospitals.css' %}">
    <link rel="stylesheet" href="{% static 'css/patient-theme.css' %}">
    {% include "components/translation_script.html" %}
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left">
            <button class="menu-toggle-btn" id="menuIcon">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <button class="nav-back-btn" onclick="window.location.href='/patient/dashboard/'">‚Üê</button>
        </div>
        <div class="nav-center">
            <img src="{% static 'img/logo.png' %}" alt="BINTACURA" class="nav-logo-img">
            <span class="nav-page-title">H√¥pitaux</span>
        </div>
        <div class="nav-right">
            <div class="nav-user-avatar" onclick="window.location.href='/patient/profile/'">
                {% include "components/user_avatar.html" with user=request.user %}
            </div>
        </div>
    </nav>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_patient.html" %}

    <div class="hospitals-container">
        <div class="page-hero">
            <h1>üè• Trouver un H√¥pital</h1>
            <p>D√©couvrez les meilleurs √©tablissements de sant√© pr√®s de chez vous</p>
        </div>

        <div class="search-filters-section">
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Rechercher un h√¥pital par nom, ville ou sp√©cialit√©...">
                </div>
                <button class="search-btn" onclick="searchHospitals()">üîç Rechercher</button>
            </div>

            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">Service</label>
                    <select id="serviceFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">Tous les services</option>
                        <option value="urgence">Urgence</option>
                        <option value="chirurgie">Chirurgie</option>
                        <option value="maternite">Maternit√©</option>
                        <option value="pediatrie">P√©diatrie</option>
                        <option value="cardiologie">Cardiologie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Distance</label>
                    <select id="distanceFilter" class="filter-select" onchange="applyFilters()">
                        <option value="">Toutes distances</option>
                        <option value="5">Moins de 5 km</option>
                        <option value="10">Moins de 10 km</option>
                        <option value="20">Moins de 20 km</option>
                        <option value="50">Moins de 50 km</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Trier par</label>
                    <select id="sortFilter" class="filter-select" onchange="applyFilters()">
                        <option value="distance">Distance</option>
                        <option value="rating">Note</option>
                        <option value="name">Nom</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="results-header">
            <div class="results-count">
                <span id="resultsCount">0</span> h√¥pitaux trouv√©s
            </div>
        </div>

        <div class="hospitals-grid" id="hospitalsGrid">
            <div class="loading-state">
                <div class="spinner"></div>
                <p style="color: #718096; font-weight: 600;">Chargement des h√¥pitaux...</p>
            </div>
        </div>
    </div>

    <div id="appointmentModal" class="appointment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Prendre Rendez-vous</h3>
                <button class="close-btn" onclick="closeAppointmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    {% csrf_token %}
                    <input type="hidden" id="hospitalId" name="hospital_id">
                    <input type="hidden" id="hospitalName" name="hospital_name">

                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="appointmentDate" name="date" required min="{{ today }}" onchange="loadAvailableSlots()">
                    </div>

                    <div class="form-group">
                        <label>Heure *</label>
                        <select id="appointmentTime" name="time" required disabled>
                            <option value="">S√©lectionnez d'abord une date</option>
                        </select>
                        <div id="slotsLoading" style="display:none; color:#718096; font-size:13px; margin-top:8px;">
                            üîÑ Chargement des cr√©neaux disponibles...
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Service souhait√© *</label>
                        <select id="serviceType" name="service" required>
                            <option value="">S√©lectionner un service</option>
                            <option value="consultation">Consultation</option>
                            <option value="urgence">Urgence</option>
                            <option value="chirurgie">Chirurgie</option>
                            <option value="maternite">Maternit√©</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Motif de la visite *</label>
                        <textarea id="visitReason" name="reason" rows="3" required placeholder="D√©crivez bri√®vement le motif de votre visite..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Pour qui est ce rendez-vous? *</label>
                        <select id="beneficiary" name="beneficiary" required>
                            <option value="self">Pour moi-m√™me</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAppointmentModal()">Annuler</button>
                <button class="btn-primary" onclick="submitAppointment()">Confirmer le Rendez-vous</button>
            </div>
        </div>
    </div>

    <script src="{% static 'js/api.js' %}"></script>
    <script src="{% static 'js/dashboard.js' %}"></script>
    <script>
        let allHospitals = [];
        let filteredHospitals = [];

        async function loadHospitals() {
            console.log('Loading hospitals...');
            try {
                const response = await fetch('/patient/api/hospitals/', {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success && data.hospitals) {
                    console.log('Hospitals count:', data.hospitals.length);
                    allHospitals = data.hospitals;
                    filteredHospitals = allHospitals;
                    renderHospitals(filteredHospitals);
                } else {
                    console.error('Invalid response format:', data);
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading hospitals:', error);
                document.getElementById('hospitalsGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <h3>Erreur de chargement</h3>
                        <p>Impossible de charger les h√¥pitaux. Veuillez r√©essayer.</p>
                        <p style="color: #999; font-size: 0.9em; margin-top: 10px;">Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderHospitals(hospitals) {
            const grid = document.getElementById('hospitalsGrid');
            const count = document.getElementById('resultsCount');

            count.textContent = hospitals.length;

            if (!hospitals || hospitals.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè•</div>
                        <h3>Aucun h√¥pital trouv√©</h3>
                        <p>Essayez d'ajuster vos filtres de recherche</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = hospitals.map(hospital => {
                const hospitalName = hospital.name || 'H√¥pital';
                const hospitalAddress = hospital.address || 'Adresse non disponible';
                const hospitalCity = hospital.city || '';
                const hospitalPhone = hospital.phone || 'Non disponible';
                const hospitalEmail = hospital.email || 'Non disponible';
                const hospitalServices = hospital.services || '';
                const rating = parseFloat(hospital.rating) || 0;
                const totalReviews = parseInt(hospital.total_reviews) || 0;
                const starsHtml = rating > 0 ? generateStars(rating) : '';

                // Build rating display
                let ratingDisplay = '';
                if (totalReviews > 0) {
                    ratingDisplay = `
                        <span class="stars">${starsHtml}</span>
                        <span class="rating-value">${rating.toFixed(1)}/5 ¬∑ ${totalReviews} avis</span>
                    `;
                } else {
                    ratingDisplay = '<span class="rating-value" style="color: #7f8c8d; font-size: 0.9em;">Nouvel h√¥pital</span>';
                }

                return `
                    <div class="hospital-card-modern" onclick="viewHospitalDetails('${hospital.uid}', '${hospitalName.replace(/'/g, "\\'")}', '${hospitalAddress.replace(/'/g, "\\'")}', '${hospitalCity.replace(/'/g, "\\'")}', '${hospitalPhone.replace(/'/g, "\\'")}', '${hospitalEmail.replace(/'/g, "\\'")}', '${hospitalServices.replace(/'/g, "\\'")}', ${rating}, ${totalReviews})">
                        <div class="card-image-container">
                            <div class="hospital-image">
                                <div class="image-placeholder">üè•</div>
                            </div>
                            <div class="location-badge">üìç</div>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">${hospitalName}</h3>
                            <p class="card-description">
                                Excellence en soins de sant√© ‚Ä¢ Services d'urgence 24/7 ‚Ä¢ √âquipement moderne
                            </p>
                            <div class="card-rating">
                                ${ratingDisplay}
                            </div>
                            <div class="card-address">
                                <span class="address-icon">üìç</span>
                                <span>${hospitalAddress}${hospitalCity ? ', ' + hospitalCity : ''}</span>
                            </div>
                            <button class="card-action-btn" onclick="event.stopPropagation(); openAppointmentModal('${hospital.uid}', '${hospitalName.replace(/'/g, "\\'")}')">
                                PRENDRE RENDEZ-VOUS
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            let stars = '';
            for (let i = 0; i < fullStars; i++) stars += '‚òÖ';
            if (hasHalfStar) stars += '‚òÜ';
            for (let i = 0; i < emptyStars; i++) stars += '‚òÜ';

            return stars;
        }

        async function searchHospitals() {
            await loadHospitalsWithFilters();
        }

        async function applyFilters() {
            await loadHospitalsWithFilters();
        }

        async function loadHospitalsWithFilters() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const service = document.getElementById('serviceFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            const params = new URLSearchParams();
            if (searchTerm) {
                params.append('search', searchTerm);
            }
            if (sortBy) {
                params.append('sort_by', sortBy);
            }

            const queryString = params.toString();
            const url = `/patient/api/hospitals/${queryString ? '?' + queryString : ''}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.hospitals) {
                    let hospitals = data.hospitals;

                    if (service) {
                        hospitals = hospitals.filter(hospital => {
                            const services = (hospital.services || '').toLowerCase();
                            return services.includes(service.toLowerCase());
                        });
                    }

                    filteredHospitals = hospitals;
                    renderHospitals(filteredHospitals);
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading hospitals:', error);
                document.getElementById('hospitalsGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <h3>Erreur de chargement</h3>
                        <p>Impossible de charger les h√¥pitaux. Veuillez r√©essayer.</p>
                    </div>
                `;
            }
        }

        function openAppointmentModal(hospitalId, hospitalName) {
            document.getElementById('hospitalId').value = hospitalId;
            document.getElementById('hospitalName').value = hospitalName;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').min = today;
            
            // Reset time dropdown
            const timeSelect = document.getElementById('appointmentTime');
            timeSelect.disabled = true;
            timeSelect.innerHTML = '<option value="">S√©lectionnez d\'abord une date</option>';

            document.getElementById('appointmentModal').classList.add('active');
        }

        async function loadAvailableSlots() {
            const hospitalId = document.getElementById('hospitalId').value;
            const selectedDate = document.getElementById('appointmentDate').value;
            const timeSelect = document.getElementById('appointmentTime');
            const loadingIndicator = document.getElementById('slotsLoading');

            if (!selectedDate) {
                timeSelect.disabled = true;
                timeSelect.innerHTML = '<option value="">S√©lectionnez d\'abord une date</option>';
                return;
            }

            // Show loading
            loadingIndicator.style.display = 'block';
            timeSelect.disabled = true;
            timeSelect.innerHTML = '<option value="">Chargement...</option>';

            try {
                const response = await fetch(`/patient/api/available-slots/?hospital_id=${hospitalId}&date=${selectedDate}`);
                const data = await response.json();

                console.log('Available slots:', data);

                if (data.success && data.slots && data.slots.length > 0) {
                    timeSelect.innerHTML = '<option value="">S√©lectionner une heure</option>';
                    
                    data.slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.time;
                        option.textContent = slot.time;
                        if (slot.available === false) {
                            option.disabled = true;
                            option.textContent += ' (D√©j√† r√©serv√©)';
                        }
                        timeSelect.appendChild(option);
                    });
                    
                    timeSelect.disabled = false;
                } else {
                    timeSelect.innerHTML = '<option value="">Aucun cr√©neau disponible</option>';
                }
            } catch (error) {
                console.error('Error loading slots:', error);
                timeSelect.innerHTML = '<option value="">Erreur de chargement</option>';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function closeAppointmentModal() {
            document.getElementById('appointmentModal').classList.remove('active');
            document.getElementById('appointmentForm').reset();
        }

        async function submitAppointment() {
            const form = document.getElementById('appointmentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const data = {
                hospital_id: formData.get('hospital_id'),
                appointment_date: formData.get('date'),
                appointment_time: formData.get('time'),
                service_type: formData.get('service'),
                reason: formData.get('reason'),
                beneficiary_id: formData.get('beneficiary')
            };

            console.log('Form data being sent:', data);
            console.log('Hospital ID:', data.hospital_id);

            try {
                const response = await fetch('/patient/api/hospital-appointments/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Server response:', result);
                console.log('Response status:', response.status);

                if (response.ok && result.success) {
                    alert(result.message || 'Rendez-vous confirm√© avec succ√®s!');
                    closeAppointmentModal();
                    window.location.href = '/patient/my-appointments/';
                } else {
                    console.error('Booking failed:', result);
                    const errorMsg = result.message || result.error || 'Erreur lors de la cr√©ation du rendez-vous';
                    alert(errorMsg);
                    if (result.details) {
                        console.error('Error details:', result.details);
                    }
                }
            } catch (error) {
                console.error('Error booking appointment:', error);
                alert('Une erreur est survenue lors de la r√©servation');
            }
        }

        function viewHospitalDetails(hospitalId, name, address, city, phone, email, services, rating, totalReviews) {
            const serviceBadges = services ?
                services.split(',').map(s => s.trim()).filter(s => s).map(service =>
                    `<span style="background: #e3f2fd; color: #007bff; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin: 4px;">${service}</span>`
                ).join('') :
                '<span style="background: #e3f2fd; color: #007bff; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">Services g√©n√©raux</span>';

            let ratingDisplay = '';
            if (totalReviews > 0) {
                const starsHtml = generateStars(rating);
                ratingDisplay = `
                    <span style="color: #ffd700; font-size: 18px;">${starsHtml}</span>
                    <span style="color: rgba(255,255,255,0.9); font-size: 14px;">${rating.toFixed(1)}/5 ¬∑ ${totalReviews} avis</span>
                `;
            } else {
                ratingDisplay = '<span style="color: rgba(255,255,255,0.8); font-size: 14px;">Nouvel h√¥pital</span>';
            }

            const modal = `
                <div class="modal-overlay" id="hospitalDetailsModal" onclick="if(event.target === this) this.remove()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div onclick="event.stopPropagation()" style="background: white; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="position: relative;">
                            <div style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); padding: 40px 30px; border-radius: 20px 20px 0 0; position: relative;">
                                <div style="position: absolute; top: 15px; right: 15px;">
                                    <button onclick="document.getElementById('hospitalDetailsModal').remove()" style="width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.2); color: white; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                                    <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px;">üè•</div>
                                    <div style="flex: 1;">
                                        <h2 style="margin: 0 0 8px 0; color: white; font-size: 24px; font-weight: 700;">${name}</h2>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            ${ratingDisplay}
                                        </div>
                                    </div>
                                </div>
                                <p style="margin: 0; color: rgba(255,255,255,0.95); font-size: 14px; line-height: 1.5;">Excellence en soins de sant√© ‚Ä¢ Services d'urgence 24/7 ‚Ä¢ √âquipement moderne</p>
                            </div>

                            <div style="padding: 30px;">
                                <div style="margin-bottom: 25px;">
                                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #1a202c; font-weight: 700;">üìã Informations</h3>
                                    <div style="background: #f7fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #007bff;">
                                        <div style="display: grid; gap: 12px;">
                                            <div style="display: flex; align-items: start; gap: 12px;">
                                                <span style="font-size: 20px; min-width: 24px;">üìç</span>
                                                <div>
                                                    <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">Adresse</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${address}${city ? ', ' + city : ''}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: start; gap: 12px;">
                                                <span style="font-size: 20px; min-width: 24px;">üìû</span>
                                                <div>
                                                    <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">T√©l√©phone</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${phone}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: start; gap: 12px;">
                                                <span style="font-size: 20px; min-width: 24px;">‚úâÔ∏è</span>
                                                <div>
                                                    <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">Email</div>
                                                    <div style="font-weight: 600; color: #2d3748;">${email}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; align-items: start; gap: 12px;">
                                                <span style="font-size: 20px; min-width: 24px;">üïê</span>
                                                <div>
                                                    <div style="font-size: 12px; color: #718096; margin-bottom: 2px;">Horaires</div>
                                                    <div style="font-weight: 600; color: #2d3748;">Ouvert 24h/24 ‚Ä¢ Urgences disponibles</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 25px;">
                                    <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #1a202c; font-weight: 700;">üè• Services Disponibles</h3>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${serviceBadges}
                                    </div>
                                </div>

                                <button onclick="document.getElementById('hospitalDetailsModal').remove(); openAppointmentModal('${hospitalId}', '${name.replace(/'/g, "\\'")}')" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,123,255,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,123,255,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,123,255,0.3)'">
                                    üìÖ PRENDRE RENDEZ-VOUS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modal);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('appointment-modal')) {
                closeAppointmentModal();
            }
        }

        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchHospitals();
            }
        });

        loadHospitals();
    </script>
</body>
</html>

