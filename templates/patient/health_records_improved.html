{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carnet de Sant√© - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/health_records.css' %}">
    <link rel="stylesheet" href="{% static 'css/patient-theme.css' %}">
    {% include "components/translation_script.html" %}
    
</head>

<body>
    {% include "components/top_nav.html" with user_type="patient" page_title="Dossiers m√©dicaux" %}

    {% include "layout/_sidebar_patient.html" %}

    <div class="records-container">
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon icon-blue">üè•</div>
                    <div>
                        <div class="card-title">Dossiers</div>
                        <div class="card-value">{{ total_records }}</div>
                    </div>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon icon-purple">üìÑ</div>
                    <div>
                        <div class="card-title">Documents</div>
                        <div class="card-value">{{ total_documents }}</div>
                    </div>
                </div>
            </div>

            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon icon-orange">üìù</div>
                    <div>
                        <div class="card-title">Notes</div>
                        <div class="card-value">{{ total_notes }}</div>
                    </div>
                </div>
            </div>

            {% if menstrual_cycles %}
            <div class="summary-card">
                <div class="card-header">
                    <div class="card-icon icon-pink">ü©∏</div>
                    <div>
                        <div class="card-title">Cycles</div>
                        <div class="card-value">{{ menstrual_cycles|length }}</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">üîç Rechercher et Filtrer</h3>
                <button class="download-btn" onclick="downloadAllRecords()">
                    üì• T√©l√©charger Tout
                </button>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label>Recherche</label>
                    <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="filterRecords()">
                </div>
                <div class="filter-group">
                    <label>Type</label>
                    <select id="typeFilter" onchange="filterRecords()">
                        <option value="all">Tous les types</option>
                        <option value="consultation">Consultation</option>
                        <option value="prescription">Ordonnance</option>
                        <option value="test">Examen</option>
                        <option value="vaccination">Vaccination</option>
                        <option value="note">Note personnelle</option>
                        <option value="menstruation">Menstruation</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date d√©but</label>
                    <input type="date" id="dateStart" onchange="filterRecords()">
                </div>
                <div class="filter-group">
                    <label>Date fin</label>
                    <input type="date" id="dateEnd" onchange="filterRecords()">
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="showTab('all')">
                    üìã Tout <span class="tab-badge">{{ total_records|add:total_notes }}</span>
                </button>
                <button class="tab-btn" onclick="showTab('records')">
                    üè• Dossiers M√©dicaux <span class="tab-badge">{{ total_records }}</span>
                </button>
                <button class="tab-btn" onclick="showTab('notes')">
                    üìù Notes Personnelles <span class="tab-badge">{{ total_notes }}</span>
                </button>
                {% if menstrual_cycles %}
                <button class="tab-btn" onclick="showTab('menstruation')">
                    ü©∏ Suivi Menstruel <span class="tab-badge">{{ menstrual_cycles|length }}</span>
                </button>
                {% endif %}
                <button class="tab-btn" onclick="showTab('vitals')">
                    üíì Signes Vitaux <span class="tab-badge">{{ recent_vitals|length }}</span>
                </button>
                <button class="tab-btn" onclick="showTab('documents')">
                    üìÑ Documents <span class="tab-badge">{{ total_documents }}</span>
                </button>
            </div>

            <!-- Tab: All -->
            <div id="tab-all" class="tab-content active">
                <h3>Tous les √âl√©ments</h3>
                <div id="allRecordsList"></div>
            </div>

            <!-- Tab: Medical Records -->
            <div id="tab-records" class="tab-content">
                <h3>Dossiers M√©dicaux</h3>
                <div id="medicalRecordsList">
                    {% if health_records %}
                    {% for record in health_records %}
                    <div class="record-card" data-type="medical" data-date="{{ record.date_of_record|date:'Y-m-d' }}">
                        <div class="record-header">
                            <div class="record-info">
                                <h3>{{ record.record_type|title }}</h3>
                                <div class="record-date">üìÖ {{ record.date_of_record|date:"d F Y" }}</div>
                            </div>
                            <span class="record-type type-{{ record.record_type }}">
                                {{ record.get_record_type_display }}
                            </span>
                        </div>

                        <div class="record-content">
                            <p><strong>Diagnostic:</strong> {{ record.diagnosis|default:"N/A" }}</p>
                            <p><strong>Traitement:</strong> {{ record.treatment|default:"N/A" }}</p>
                            
                            <!-- Vitals Section -->
                            {% if record.blood_pressure_systolic or record.heart_rate or record.temperature or record.weight %}
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                                <p style="font-weight: 600; color: #374151; margin-bottom: 12px;">ü©∫ Signes Vitaux</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                    {% if record.blood_pressure_systolic %}
                                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 10px; border-radius: 6px;">
                                        <div style="font-size: 11px; opacity: 0.9;">Tension</div>
                                        <div style="font-size: 16px; font-weight: 700;">{{ record.blood_pressure_systolic }}/{{ record.blood_pressure_diastolic }}</div>
                                        <div style="font-size: 10px; opacity: 0.8;">mmHg</div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if record.heart_rate %}
                                    <div style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; padding: 10px; border-radius: 6px;">
                                        <div style="font-size: 11px; opacity: 0.9;">Fr√©quence C.</div>
                                        <div style="font-size: 16px; font-weight: 700;">{{ record.heart_rate }}</div>
                                        <div style="font-size: 10px; opacity: 0.8;">bpm</div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if record.temperature %}
                                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 10px; border-radius: 6px;">
                                        <div style="font-size: 11px; opacity: 0.9;">Temp√©rature</div>
                                        <div style="font-size: 16px; font-weight: 700;">{{ record.temperature }}</div>
                                        <div style="font-size: 10px; opacity: 0.8;">¬∞C</div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if record.weight %}
                                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 10px; border-radius: 6px;">
                                        <div style="font-size: 11px; opacity: 0.9;">Poids</div>
                                        <div style="font-size: 16px; font-weight: 700;">{{ record.weight }}</div>
                                        <div style="font-size: 10px; opacity: 0.8;">kg</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Linked Prescriptions Section -->
                            {% if record.prescriptions.exists %}
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                                <p style="font-weight: 600; color: #374151; margin-bottom: 12px;">üíä Ordonnances Li√©es</p>
                                {% for prescription in record.prescriptions.all %}
                                <div style="background: #f3f4f6; border-left: 4px solid #10b981; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div>
                                            <div style="font-weight: 600; color: #059669; font-size: 14px;">
                                                Ordonnance #{{ forloop.counter }}
                                            </div>
                                            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                                                D√©livr√©e le {{ prescription.issue_date|date:"d/m/Y" }}
                                                {% if prescription.valid_until %}
                                                - Valide jusqu'au {{ prescription.valid_until|date:"d/m/Y" }}
                                                {% endif %}
                                            </div>
                                        </div>
                                        <span style="background: {% if prescription.status == 'active' %}#10b981{% elif prescription.status == 'ordered' %}#3b82f6{% else %}#6b7280{% endif %}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                                            {{ prescription.get_status_display }}
                                        </span>
                                    </div>
                                    {% if prescription.items.exists %}
                                    <div style="font-size: 13px; color: #374151;">
                                        <strong>M√©dicaments:</strong>
                                        <ul style="margin: 4px 0 0 20px; padding: 0;">
                                            {% for item in prescription.items.all %}
                                            <li style="margin: 2px 0;">
                                                {{ item.medication_name }} - {{ item.dosage }}
                                                <span style="color: #6b7280; font-size: 12px;">
                                                    ({{ item.get_frequency_display }}, {{ item.duration_days }} jours)
                                                </span>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    {% if prescription.special_instructions %}
                                    <div style="margin-top: 8px; font-size: 12px; color: #6b7280; font-style: italic;">
                                        üìù {{ prescription.special_instructions }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="record-footer">
                            <div class="doctor-name">
                                üë®‚Äç‚öïÔ∏è {{ record.created_by.get_full_name|default:"M√©decin" }}
                            </div>
                            <div class="record-actions">
                                <button class="action-icon-btn" onclick="downloadRecord('{{ record.id }}')" title="T√©l√©charger">
                                    üì•
                                </button>
                                <button class="action-icon-btn" onclick="viewRecord('{{ record.id }}')" title="Voir">
                                    üëÅÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üè•</div>
                        <p>Aucun dossier m√©dical</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab: Personal Notes -->
            <div id="tab-notes" class="tab-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                    <h3>Notes Personnelles</h3>
                    <button class="btn btn-primary" onclick="window.location.href='/patient/health-journal/'">
                        ‚ûï Nouvelle Note
                    </button>
                </div>

                {% if personal_notes %}
                {% for note in personal_notes %}
                <div class="note-card" data-type="note" data-date="{{ note.created_at|date:'Y-m-d' }}">
                    <div class="note-header">
                        <div>
                            <span class="note-category category-{{ note.category }}">
                                {{ note.get_category_display }}
                            </span>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                üìÖ {{ note.date|date:"d F Y" }}
                            </div>
                        </div>
                    </div>
                    <h4 style="margin: 12px 0 8px 0;">{{ note.title }}</h4>
                    <p style="color: #555; line-height: 1.6;">{{ note.content|truncatewords:50 }}</p>
                    
                    {% if note.tags %}
                    <div style="margin-top: 12px;">
                        {% for tag in note.tags %}
                        <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-right: 6px;">
                            #{{ tag }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <p>Aucune note personnelle</p>
                    <button class="btn btn-primary" onclick="window.location.href='/patient/health-journal/'">
                        Cr√©er votre premi√®re note
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Tab: Menstruation -->
            {% if menstrual_cycles %}
            <div id="tab-menstruation" class="tab-content">
                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                    <h3>Suivi Menstruel</h3>
                    <button class="btn btn-primary" onclick="window.location.href='/patient/menstruation/'">
                        Voir le Calendrier Complet
                    </button>
                </div>

                {% for cycle in menstrual_cycles %}
                <div class="menstrual-cycle-card" data-type="menstruation" data-date="{{ cycle.cycle_start_date|date:'Y-m-d' }}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0;">Cycle du {{ cycle.cycle_start_date|date:"d F Y" }}</h4>
                            <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 14px;">
                                Dur√©e: {{ cycle.cycle_length }} jours | 
                                Flux: {{ cycle.get_flow_intensity_display }}
                            </p>
                        </div>
                        {% if cycle.is_active_cycle %}
                        <span style="background: rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                            En cours
                        </span>
                        {% endif %}
                    </div>

                    <div class="cycle-dates">
                        <div class="date-item">
                            <div class="date-label">D√©but</div>
                            <div class="date-value">{{ cycle.cycle_start_date|date:"d/m" }}</div>
                        </div>
                        {% if cycle.predicted_ovulation_date %}
                        <div class="date-item">
                            <div class="date-label">Ovulation</div>
                            <div class="date-value">{{ cycle.predicted_ovulation_date|date:"d/m" }}</div>
                        </div>
                        {% endif %}
                        {% if cycle.cycle_end_date %}
                        <div class="date-item">
                            <div class="date-label">Fin</div>
                            <div class="date-value">{{ cycle.cycle_end_date|date:"d/m" }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Tab: Vitals -->
            <div id="tab-vitals" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3>Signes Vitaux R√©cents</h3>
                    <button class="btn btn-primary" onclick="window.location.href='/patient/wearable-devices/'">
                        ‚öôÔ∏è G√©rer les Appareils
                    </button>
                </div>
                
                {% if active_devices.exists %}
                    <div style="background: #e3f2fd; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">üì±</span>
                        <div>
                            <div style="font-weight: 600; color: #1976d2;">
                                {{ active_devices.count }} appareil{{ active_devices.count|pluralize }} connect√©{{ active_devices.count|pluralize }}
                            </div>
                            <div style="font-size: 13px; color: #555; margin-top: 2px;">
                                {% for device in active_devices %}
                                    {{ device.get_device_type_display }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                {% if recent_vitals %}
                <div class="vital-grid">
                    {% for vital in recent_vitals %}
                    <div class="vital-card {{ vital.data_type|slugify }}">
                        <div class="vital-label">
                            {% if vital.data_type == 'heart_rate' %}‚ù§Ô∏è Fr√©quence Cardiaque
                            {% elif vital.data_type == 'steps' %}üëü Pas
                            {% elif vital.data_type == 'distance' %}üìè Distance
                            {% elif vital.data_type == 'calories' %}üî• Calories
                            {% elif vital.data_type == 'sleep' %}üò¥ Sommeil
                            {% elif vital.data_type == 'blood_pressure' %}ü©∫ Tension Art√©rielle
                            {% elif vital.data_type == 'blood_oxygen' %}ü´Å Oxyg√®ne Sanguin
                            {% elif vital.data_type == 'body_temperature' %}üå°Ô∏è Temp√©rature
                            {% elif vital.data_type == 'weight' %}‚öñÔ∏è Poids
                            {% elif vital.data_type == 'bmi' %}üìä IMC
                            {% elif vital.data_type == 'body_fat' %}üí™ Masse Grasse
                            {% elif vital.data_type == 'exercise' %}üèÉ Exercice
                            {% elif vital.data_type == 'stress' %}üò∞ Stress
                            {% elif vital.data_type == 'hydration' %}üíß Hydratation
                            {% elif vital.data_type == 'respiratory_rate' %}ü´Å Rythme Respiratoire
                            {% elif vital.data_type == 'vo2_max' %}üèãÔ∏è VO2 Max
                            {% elif vital.data_type == 'hrv' %}üíì VRC
                            {% else %}{{ vital.get_data_type_display }}
                            {% endif %}
                        </div>
                        <div class="vital-value">
                            {{ vital.value|floatformat:1 }}
                            <span class="vital-unit">{{ vital.unit }}</span>
                        </div>
                        <div class="vital-date">
                            {{ vital.timestamp|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if vital_summary %}
                <div style="margin-top: 24px; padding: 16px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin-bottom: 12px; color: #333;">üìä R√©sum√© des 7 derniers jours</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                        {% for data_type, stats in vital_summary.items %}
                        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600;">
                                {% if data_type == 'heart_rate' %}Fr√©quence Cardiaque
                                {% elif data_type == 'steps' %}Pas
                                {% elif data_type == 'distance' %}Distance
                                {% elif data_type == 'calories' %}Calories
                                {% elif data_type == 'sleep' %}Sommeil
                                {% elif data_type == 'blood_pressure' %}Tension
                                {% elif data_type == 'blood_oxygen' %}Oxyg√®ne
                                {% elif data_type == 'body_temperature' %}Temp√©rature
                                {% else %}{{ data_type|title }}
                                {% endif %}
                            </div>
                            <div style="font-size: 11px; color: #888;">
                                Moy: <strong>{{ stats.avg|floatformat:1 }}</strong><br>
                                Min: {{ stats.min|floatformat:1 }} | Max: {{ stats.max|floatformat:1 }}<br>
                                <span style="color: #1976d2;">{{ stats.count }} mesure{{ stats.count|pluralize }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üíì</div>
                    {% if active_devices.exists %}
                        <p style="font-weight: 600; margin-bottom: 8px;">Aucune donn√©e vitale collect√©e r√©cemment</p>
                        <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                            Vos appareils sont connect√©s mais aucune donn√©e n'a √©t√© synchronis√©e au cours des 7 derniers jours.
                        </p>
                        <button class="btn btn-primary" onclick="syncAllDevices()">
                            üîÑ Synchroniser Maintenant
                        </button>
                    {% else %}
                        <p style="font-weight: 600; margin-bottom: 8px;">Aucun appareil connect√©</p>
                        <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                            Connectez un appareil portable pour suivre vos signes vitaux automatiquement.
                        </p>
                        <button class="btn btn-primary" onclick="window.location.href='/patient/wearable-devices/'">
                            üì± Connecter un Appareil
                        </button>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Doctor-Entered Vitals Section -->
                <div style="margin-top: 32px;">
                    <h4 style="color: #333; margin-bottom: 16px;">ü©∫ Signes Vitaux Cliniques (M√©decins)</h4>
                    
                    {% if doctor_vitals and doctor_vitals.latest_record %}
                    <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
                        Moyennes des mesures effectu√©es lors de {{ doctor_vitals.total_consultations }} consultation{{ doctor_vitals.total_consultations|pluralize }} (30 derniers jours)
                    </p>
                    
                    <div class="vital-grid">
                        {% if doctor_vitals_summary.blood_pressure.count %}
                        <div class="vital-card blood-pressure">
                            <div class="vital-label">ü©∫ Tension Art√©rielle</div>
                            <div class="vital-value">
                                {{ doctor_vitals_summary.blood_pressure.avg_systolic|floatformat:0 }}/{{ doctor_vitals_summary.blood_pressure.avg_diastolic|floatformat:0 }}
                                <span class="vital-unit">mmHg</span>
                            </div>
                            <div class="vital-date">
                                Moy. sur {{ doctor_vitals_summary.blood_pressure.count }} mesure{{ doctor_vitals_summary.blood_pressure.count|pluralize }}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if doctor_vitals_summary.heart_rate.count %}
                        <div class="vital-card heart-rate">
                            <div class="vital-label">‚ù§Ô∏è Fr√©quence Cardiaque</div>
                            <div class="vital-value">
                                {{ doctor_vitals_summary.heart_rate.avg|floatformat:0 }}
                                <span class="vital-unit">bpm</span>
                            </div>
                            <div class="vital-date">
                                Min: {{ doctor_vitals_summary.heart_rate.min }} | Max: {{ doctor_vitals_summary.heart_rate.max }}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if doctor_vitals_summary.temperature.count %}
                        <div class="vital-card body-temperature">
                            <div class="vital-label">üå°Ô∏è Temp√©rature</div>
                            <div class="vital-value">
                                {{ doctor_vitals_summary.temperature.avg|floatformat:1 }}
                                <span class="vital-unit">¬∞C</span>
                            </div>
                            <div class="vital-date">
                                Min: {{ doctor_vitals_summary.temperature.min }} | Max: {{ doctor_vitals_summary.temperature.max }}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if doctor_vitals_summary.weight.count %}
                        <div class="vital-card weight">
                            <div class="vital-label">‚öñÔ∏è Poids</div>
                            <div class="vital-value">
                                {{ doctor_vitals_summary.weight.avg|floatformat:1 }}
                                <span class="vital-unit">kg</span>
                            </div>
                            <div class="vital-date">
                                Min: {{ doctor_vitals_summary.weight.min|floatformat:1 }} | Max: {{ doctor_vitals_summary.weight.max|floatformat:1 }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 24px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">ü©∫</div>
                        <p style="color: #666; font-size: 14px; margin-bottom: 8px;">
                            Aucune mesure clinique enregistr√©e au cours des 30 derniers jours
                        </p>
                        <p style="color: #999; font-size: 12px;">
                            Les signes vitaux mesur√©s par vos m√©decins lors des consultations appara√Ætront ici
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tab: Documents -->
            <div id="tab-documents" class="tab-content">
                <h3>Documents Upload√©s</h3>
                {% if documents %}
                {% for doc in documents %}
                <div class="record-card" data-type="document" data-date="{{ doc.uploaded_at|date:'Y-m-d' }}">
                    <div class="record-header">
                        <div class="record-info">
                            <h3>üìÑ {{ doc.document_name }}</h3>
                            <div class="record-date">üìÖ {{ doc.uploaded_at|date:"d F Y" }}</div>
                        </div>
                    </div>
                    <div class="record-content">
                        <p>{{ doc.description|default:"Aucune description" }}</p>
                    </div>
                    <div class="record-footer">
                        <div class="record-actions">
                            <button class="action-icon-btn" onclick="downloadDocument('{{ doc.id }}')" title="T√©l√©charger">
                                üì• T√©l√©charger
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üìÑ</div>
                    <p>Aucun document upload√©</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="{% static 'js/api.js' %}"></script>
    <script>
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');

            // Add active to clicked button
            event.target.classList.add('active');

            // Load all records if 'all' tab
            if (tabName === 'all') {
                loadAllRecords();
            }
        }

        function loadAllRecords() {
            const container = document.getElementById('allRecordsList');
            const allItems = [];

            // Collect all items from other tabs
            document.querySelectorAll('.record-card, .note-card, .menstrual-cycle-card').forEach(item => {
                const clone = item.cloneNode(true);
                const date = clone.getAttribute('data-date');
                allItems.push({ element: clone, date: new Date(date || Date.now()) });
            });

            // Sort by date (newest first)
            allItems.sort((a, b) => b.date - a.date);

            // Render
            container.innerHTML = '';
            allItems.forEach(item => {
                container.appendChild(item.element);
            });

            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>Aucune donn√©e disponible</p>
                    </div>
                `;
            }
        }

        function filterRecords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;

            document.querySelectorAll('.record-card, .note-card, .menstrual-cycle-card').forEach(item => {
                const text = item.textContent.toLowerCase();
                const type = item.getAttribute('data-type');
                const date = item.getAttribute('data-date');

                let show = true;

                // Search filter
                if (searchTerm && !text.includes(searchTerm)) {
                    show = false;
                }

                // Type filter
                if (typeFilter !== 'all' && type !== typeFilter) {
                    show = false;
                }

                // Date range filter
                if (dateStart && date < dateStart) {
                    show = false;
                }
                if (dateEnd && date > dateEnd) {
                    show = false;
                }

                item.style.display = show ? 'block' : 'none';
            });
        }

        function downloadRecord(recordId) {
            window.location.href = `/api/v1/health-records/records/${recordId}/download/`;
        }

        function viewRecord(recordId) {
            window.location.href = `/patient/health-record/${recordId}/`;
        }

        function downloadDocument(docId) {
            window.location.href = `/api/v1/health-records/documents/${docId}/download/`;
        }

        function downloadAllRecords() {
            if (confirm('T√©l√©charger tous vos dossiers m√©dicaux en format PDF?')) {
                window.location.href = '/api/v1/health-records/records/download_all/';
            }
        }

        async function syncAllDevices() {
            try {
                // Show loading state
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥ Synchronisation...';
                btn.disabled = true;

                // Get list of active devices
                const devicesResponse = await fetch('/api/v1/wearable-devices/devices/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!devicesResponse.ok) {
                    throw new Error('Erreur lors de la r√©cup√©ration des appareils');
                }

                const devices = await devicesResponse.json();
                let syncedCount = 0;
                let errors = [];

                // Sync each device
                for (const device of devices.results || devices) {
                    if (device.status === 'active') {
                        try {
                            const syncResponse = await fetch(`/api/v1/wearable-devices/devices/${device.id}/sync/`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`,
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include'
                            });

                            if (syncResponse.ok) {
                                syncedCount++;
                            } else {
                                errors.push(device.device_name);
                            }
                        } catch (err) {
                            errors.push(device.device_name);
                        }
                    }
                }

                // Show result
                if (syncedCount > 0) {
                    alert(`‚úÖ ${syncedCount} appareil(s) synchronis√©(s) avec succ√®s!`);
                    // Reload page to show new data
                    window.location.reload();
                } else if (errors.length > 0) {
                    alert(`‚ö†Ô∏è Erreur lors de la synchronisation de: ${errors.join(', ')}`);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                } else {
                    alert('‚ÑπÔ∏è Aucun appareil actif √† synchroniser');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Sync error:', error);
                alert('‚ùå Erreur lors de la synchronisation. Veuillez r√©essayer.');
                event.target.innerHTML = 'üîÑ Synchroniser Maintenant';
                event.target.disabled = false;
            }
        }

        // Initialize
        loadAllRecords();
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
