{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assurance Sant√© - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/insurance_subscription.css' %}">
    {% include "components/translation_script.html" %}
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left">
            <button class="menu-toggle-btn" id="menuIcon">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <button class="nav-back-btn" onclick="window.location.href='/patient/dashboard/'">‚Üê</button>
        </div>
        <div class="nav-center">
            <img src="{% static 'img/logo.png' %}" alt="BINTACURA" class="nav-logo-img">
            <span class="nav-page-title">Assurance</span>
        </div>
        <div class="nav-right">
            <div class="nav-user-avatar" onclick="window.location.href='/patient/profile/'">
                {% include "components/user_avatar.html" with user=request.user %}
            </div>
        </div>
    </nav>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_patient.html" %}

    <div class="insurance-container">
        <div class="subscriptions-section" id="currentSubscriptionsSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Mes Abonnements Actifs
                </h2>
                <p class="section-description">G√©rez vos abonnements d'assurance actuels</p>
            </div>
            <div id="currentSubscriptionsList" class="subscriptions-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Chargement de vos abonnements...</p>
                </div>
            </div>
        </div>

        <div class="packages-section">
            <div class="section-header">
                <div class="header-left">
                    <h2 class="section-title">
                        <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M3 9h18"></path><path d="M9 21V9"></path></svg>
                        Offres d'Assurance Disponibles
                    </h2>
                    <p class="section-description">Explorez et souscrivez aux packages de toutes nos compagnies d'assurance partenaires</p>
                </div>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterPackages('all')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        Tous
                    </button>
                    <button class="filter-tab" onclick="filterPackages('individual')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        Individuel
                    </button>
                    <button class="filter-tab" onclick="filterPackages('family')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Famille
                    </button>
                </div>
            </div>
            <div class="packages-grid" id="packagesGrid">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Chargement des offres d'assurance...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="subscriptionDetailModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">D√©tails de l'Abonnement</h3>
                <button class="close-btn" onclick="closeModal('subscriptionDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="subscriptionDetailBody">
            </div>
        </div>
    </div>

    <div id="fileClaimModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>D√©poser une R√©clamation</h3>
                <button class="close-btn" onclick="closeModal('fileClaimModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="fileClaimForm">
                    {% csrf_token %}
                    <input type="hidden" id="claimSubscriptionId" name="subscription_id">
                    <input type="hidden" id="claimInsuranceCardId" name="insurance_card_id">

                    <div class="form-group">
                        <label>Type de Service *</label>
                        <select id="claimServiceType" name="service_type" required>
                            <option value="">S√©lectionner</option>
                            <option value="consultation">Consultation</option>
                            <option value="prescription">Ordonnance</option>
                            <option value="lab_test">Analyses de laboratoire</option>
                            <option value="hospitalization">Hospitalisation</option>
                            <option value="surgery">Chirurgie</option>
                            <option value="emergency">Urgence</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nom du Prestataire *</label>
                        <input type="text" id="claimProviderName" name="provider_name" required placeholder="Nom de l'h√¥pital ou du m√©decin">
                    </div>

                    <div class="form-group">
                        <label>Date du Service *</label>
                        <input type="date" id="claimServiceDate" name="service_date" required>
                    </div>

                    <div class="form-group">
                        <label>Montant R√©clam√© (CFA) *</label>
                        <input type="number" id="claimAmount" name="claimed_amount" required min="0" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>Diagnostic</label>
                        <textarea id="claimDiagnosis" name="diagnosis" rows="2" placeholder="D√©crivez le diagnostic..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>D√©tails du Traitement</label>
                        <textarea id="claimTreatment" name="treatment_details" rows="3" placeholder="D√©crivez le traitement re√ßu..."></textarea>
                    </div>

                    <div class="alert alert-info">
                        <strong>Note:</strong> Vous pourrez ajouter des documents justificatifs apr√®s la soumission de la r√©clamation.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('fileClaimModal')">Annuler</button>
                <button class="btn-primary" onclick="submitClaim()">Soumettre la R√©clamation</button>
            </div>
        </div>
    </div>

    <div id="cancelSubscriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Annuler l'Abonnement</h3>
                <button class="close-btn" onclick="closeModal('cancelSubscriptionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cancelSubscriptionId">
                <p>√ätes-vous s√ªr de vouloir annuler cet abonnement?</p>
                <div class="form-group">
                    <label>Raison de l'annulation (optionnel)</label>
                    <textarea id="cancelReason" rows="3" placeholder="Pourquoi annulez-vous cet abonnement?"></textarea>
                </div>
                <div class="alert alert-warning">
                    <strong>Attention:</strong> L'annulation prendra effet imm√©diatement et votre carte d'assurance sera d√©sactiv√©e.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('cancelSubscriptionModal')">Retour</button>
                <button class="btn-danger" onclick="confirmCancelSubscription()">Confirmer l'Annulation</button>
            </div>
        </div>
    </div>

    <div id="requestEnquiryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Demande de Pr√©-Approbation</h3>
                <button class="close-btn" onclick="closeModal('requestEnquiryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="enquiryForm">
                    {% csrf_token %}
                    <input type="hidden" id="enquiryInsuranceCardId" name="insurance_card_id">
                    <input type="hidden" id="enquiryInsurancePackageId" name="insurance_package_id">

                    <div class="alert alert-info">
                        <strong>√Ä propos:</strong> Demandez une pr√©-approbation pour conna√Ætre la couverture de votre assurance avant de subir un traitement ou une proc√©dure m√©dicale.
                    </div>

                    <div class="form-group">
                        <label>Type de Service *</label>
                        <select id="enquiryServiceType" name="service_type" required>
                            <option value="">S√©lectionner</option>
                            <option value="consultation">Consultation</option>
                            <option value="lab_test">Analyses de laboratoire</option>
                            <option value="surgery">Chirurgie</option>
                            <option value="hospitalization">Hospitalisation</option>
                            <option value="imaging">Imagerie m√©dicale</option>
                            <option value="dental">Soins dentaires</option>
                            <option value="optical">Soins optiques</option>
                            <option value="maternity">Maternit√©</option>
                            <option value="pharmacy">Pharmacie</option>
                            <option value="emergency">Urgence</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nom du Service *</label>
                        <input type="text" id="enquiryServiceName" name="service_name" required placeholder="Ex: IRM du genou">
                    </div>

                    <div class="form-group">
                        <label>Description du Service *</label>
                        <textarea id="enquiryServiceDescription" name="service_description" rows="3" required placeholder="D√©crivez bri√®vement le service ou la proc√©dure m√©dicale..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Co√ªt Estim√© (CFA) *</label>
                        <input type="number" id="enquiryEstimatedCost" name="estimated_cost" required min="0" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>Nom du Prestataire *</label>
                        <input type="text" id="enquiryPartnerName" name="partner_name" required placeholder="Nom de l'h√¥pital ou de la clinique">
                    </div>

                    <div class="form-group">
                        <label>Type de Prestataire</label>
                        <select id="enquiryPartnerType" name="partner_type">
                            <option value="hospital">H√¥pital</option>
                            <option value="clinic">Clinique</option>
                            <option value="pharmacy">Pharmacie</option>
                            <option value="laboratory">Laboratoire</option>
                            <option value="doctor">M√©decin</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Date Pr√©vue</label>
                        <input type="date" id="enquiryPlannedDate" name="planned_date">
                    </div>

                    <div class="form-group">
                        <label>N√©cessit√© M√©dicale *</label>
                        <textarea id="enquiryMedicalNecessity" name="medical_necessity" rows="3" required placeholder="Expliquez pourquoi ce traitement est n√©cessaire..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Recommandation du M√©decin (optionnel)</label>
                        <textarea id="enquiryDoctorRecommendation" name="doctor_recommendation" rows="2" placeholder="Recommandations ou instructions de votre m√©decin..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('requestEnquiryModal')">Annuler</button>
                <button class="btn-primary" onclick="submitEnquiry()">Soumettre la Demande</button>
            </div>
        </div>
    </div>

    <script src="{% static 'js/api.js' %}"></script>
    <script>
        let allPackages = [];
        let currentFilter = 'all';
        let mySubscriptions = [];

        async function loadMySubscriptions() {
            try {
                const response = await fetchApi('insurance/packages/my_subscriptions/');
                const data = await response.json();

                mySubscriptions = data || [];

                const section = document.getElementById('currentSubscriptionsSection');
                const listContainer = document.getElementById('currentSubscriptionsList');

                if (mySubscriptions.length > 0) {
                    section.style.display = 'block';
                    displaySubscriptions(mySubscriptions);
                } else {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>Aucun Abonnement Actif</h3>
                            <p>Explorez nos offres d'assurance ci-dessous et souscrivez √† un plan qui vous convient.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                document.getElementById('currentSubscriptionsList').innerHTML = '<p class="error-message">Erreur de chargement des abonnements</p>';
            }
        }

        function displaySubscriptions(subscriptions) {
            const container = document.getElementById('currentSubscriptionsList');

            container.innerHTML = subscriptions.map(sub => {
                const nextPayment = new Date(sub.next_payment_date);
                const formattedNextPayment = nextPayment.toLocaleDateString('fr-FR');
                const statusColors = {
                    active: '#28a745',
                    suspended: '#ffc107',
                    cancelled: '#dc3545',
                    expired: '#6c757d'
                };
                const statusColor = statusColors[sub.status] || '#6c757d';

                return `
                    <div class="subscription-card active-subscription" onclick="viewSubscriptionDetails('${sub.id}')">
                        <div class="subscription-header">
                            <div class="subscription-company">
                                ${sub.company_logo ? `<img src="${sub.company_logo}" alt="${sub.company_name}" class="company-logo-small">` : ''}
                                <div>
                                    <h3 class="subscription-title">${sub.company_name}</h3>
                                    <p class="subscription-package-name">${sub.insurance_package_name}</p>
                                </div>
                            </div>
                            <span class="subscription-status" style="background: ${statusColor};">
                                ${sub.status_display}
                            </span>
                        </div>
                        <div class="subscription-details">
                            <div class="detail-item">
                                <div class="detail-label">Prime</div>
                                <div class="detail-value">${sub.premium_amount.toLocaleString()} CFA</div>
                                <div class="detail-subtext">
                                    ${sub.payment_frequency === 'monthly' ? 'Mensuel' :
                                      sub.payment_frequency === 'quarterly' ? 'Trimestriel' :
                                      sub.payment_frequency === 'semi_annual' ? 'Semestriel' : 'Annuel'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Prochain paiement</div>
                                <div class="detail-value">${formattedNextPayment}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total pay√©</div>
                                <div class="detail-value">${sub.total_paid.toLocaleString()} CFA</div>
                                <div class="detail-subtext">${sub.payment_count} paiement(s)</div>
                            </div>
                            ${sub.insurance_card ? `
                            <div class="detail-item">
                                <div class="detail-label">Carte N¬∞</div>
                                <div class="detail-value card-number">${sub.insurance_card.card_number}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="subscription-card-footer">
                            <span class="view-details-link">Cliquez pour voir les d√©tails et g√©rer ‚Üí</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewSubscriptionDetails(subscriptionId) {
            const subscription = mySubscriptions.find(s => s.id === subscriptionId);
            if (!subscription) return;

            const modal = document.getElementById('subscriptionDetailModal');
            const body = document.getElementById('subscriptionDetailBody');

            const startDate = new Date(subscription.start_date).toLocaleDateString('fr-FR');
            const nextPaymentDate = new Date(subscription.next_payment_date).toLocaleDateString('fr-FR');

            body.innerHTML = `
                <div class="subscription-detail-content">
                    <div class="detail-section">
                        <h4>üìã Informations de l'Abonnement</h4>
                        <div class="detail-grid">
                            <div class="detail-row">
                                <span class="label">Compagnie:</span>
                                <span class="value">${subscription.company_name}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Plan:</span>
                                <span class="value">${subscription.insurance_package_name}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Statut:</span>
                                <span class="value">${subscription.status_display}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Date de d√©but:</span>
                                <span class="value">${startDate}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Prime:</span>
                                <span class="value">${subscription.premium_amount.toLocaleString()} CFA (${subscription.payment_frequency_display})</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Prochain paiement:</span>
                                <span class="value">${nextPaymentDate}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Total pay√©:</span>
                                <span class="value">${subscription.total_paid.toLocaleString()} CFA</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Paiements effectu√©s:</span>
                                <span class="value">${subscription.payment_count}</span>
                            </div>
                        </div>
                    </div>

                    ${subscription.insurance_card ? `
                    <div class="detail-section">
                        <h4>üí≥ Carte d'Assurance</h4>
                        <div class="insurance-card-display">
                            <div class="card-info">
                                <p><strong>Num√©ro de Carte:</strong> ${subscription.insurance_card.card_number}</p>
                                <p><strong>Num√©ro de Police:</strong> ${subscription.insurance_card.policy_number}</p>
                                <p><strong>Statut:</strong> <span class="badge ${subscription.insurance_card.status}">${subscription.insurance_card.status}</span></p>
                                <p><strong>Valide du:</strong> ${new Date(subscription.insurance_card.coverage_start_date).toLocaleDateString('fr-FR')}
                                   au ${new Date(subscription.insurance_card.coverage_end_date).toLocaleDateString('fr-FR')}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="detail-section">
                        <h4>‚ö° Actions Rapides</h4>
                        <div class="action-buttons">
                            ${subscription.status === 'active' ? `
                                <button class="btn-primary" onclick="openRequestEnquiryModal('${subscription.insurance_card?.id || ''}', '${subscription.insurance_package}')">
                                    üîç Demander une Pr√©-Approbation
                                </button>
                                <button class="btn-primary" onclick="openFileClaimModal('${subscription.id}', '${subscription.insurance_card?.id || ''}')">
                                    üìÑ D√©poser une R√©clamation
                                </button>
                                <button class="btn-secondary" onclick="viewInvoices('${subscription.id}')">
                                    üßæ Voir les Factures
                                </button>
                                <button class="btn-secondary" onclick="viewClaims('${subscription.id}')">
                                    üìã Mes R√©clamations
                                </button>
                                <button class="btn-danger" onclick="openCancelSubscriptionModal('${subscription.id}')">
                                    ‚ùå Annuler l'Abonnement
                                </button>
                            ` : `
                                <p class="text-muted">Cet abonnement n'est plus actif.</p>
                            `}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üìû Support</h4>
                        <p>Pour toute question concernant votre assurance, contactez directement votre compagnie d'assurance: <strong>${subscription.company_name}</strong></p>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function openFileClaimModal(subscriptionId, insuranceCardId) {
            closeModal('subscriptionDetailModal');

            document.getElementById('claimSubscriptionId').value = subscriptionId;
            document.getElementById('claimInsuranceCardId').value = insuranceCardId;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('claimServiceDate').max = today;

            document.getElementById('fileClaimModal').classList.add('active');
        }

        async function submitClaim() {
            const form = document.getElementById('fileClaimForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const subscriptionId = formData.get('subscription_id');
            const subscription = mySubscriptions.find(s => s.id === subscriptionId);

            if (!subscription || !subscription.insurance_card) {
                alert('Erreur: Carte d\'assurance non trouv√©e');
                return;
            }

            const data = {
                insurance_card_id: subscription.insurance_card.id,
                insurance_package_id: subscription.insurance_package,
                service_type: formData.get('service_type'),
                provider_name: formData.get('provider_name'),
                service_date: formData.get('service_date'),
                claimed_amount: parseInt(formData.get('claimed_amount')),
                diagnosis: formData.get('diagnosis'),
                treatment_details: formData.get('treatment_details')
            };

            try {
                const response = await fetchApi('insurance/claims/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('R√©clamation soumise avec succ√®s! Num√©ro de r√©clamation: ' + result.claim_number);
                    closeModal('fileClaimModal');
                    form.reset();
                } else {
                    alert('Erreur: ' + (result.error || 'Impossible de soumettre la r√©clamation'));
                }
            } catch (error) {
                console.error('Error submitting claim:', error);
                alert('Erreur de connexion lors de la soumission');
            }
        }

        function openCancelSubscriptionModal(subscriptionId) {
            closeModal('subscriptionDetailModal');
            document.getElementById('cancelSubscriptionId').value = subscriptionId;
            document.getElementById('cancelSubscriptionModal').classList.add('active');
        }

        async function confirmCancelSubscription() {
            const subscriptionId = document.getElementById('cancelSubscriptionId').value;
            const reason = document.getElementById('cancelReason').value || 'Patient requested cancellation';

            try {
                const response = await fetchApi('insurance/packages/cancel_subscription/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        subscription_id: subscriptionId,
                        reason: reason
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Abonnement annul√© avec succ√®s!');
                    closeModal('cancelSubscriptionModal');
                    loadMySubscriptions();
                } else {
                    alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
                }
            } catch (error) {
                console.error('Error cancelling subscription:', error);
                alert('Erreur de connexion');
            }
        }

        function viewInvoices(subscriptionId) {
            window.location.href = `/patient/insurance/invoices/?subscription=${subscriptionId}`;
        }

        function viewClaims(subscriptionId) {
            window.location.href = `/patient/insurance/claims/?subscription=${subscriptionId}`;
        }

        function openRequestEnquiryModal(insuranceCardId, insurancePackageId) {
            closeModal('subscriptionDetailModal');

            document.getElementById('enquiryInsuranceCardId').value = insuranceCardId;
            document.getElementById('enquiryInsurancePackageId').value = insurancePackageId;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('enquiryPlannedDate').min = today;

            document.getElementById('requestEnquiryModal').classList.add('active');
        }

        async function submitEnquiry() {
            const form = document.getElementById('enquiryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);

            const data = {
                insurance_card_id: formData.get('insurance_card_id'),
                insurance_package_id: formData.get('insurance_package_id'),
                service_type: formData.get('service_type'),
                service_name: formData.get('service_name'),
                service_description: formData.get('service_description'),
                estimated_cost: parseInt(formData.get('estimated_cost')),
                partner_name: formData.get('partner_name'),
                partner_type: formData.get('partner_type'),
                planned_date: formData.get('planned_date') || null,
                medical_necessity: formData.get('medical_necessity'),
                doctor_recommendation: formData.get('doctor_recommendation') || ''
            };

            try {
                const response = await fetchApi('insurance/enquiries/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Demande de pr√©-approbation soumise avec succ√®s!\n\nNum√©ro de demande: ${result.enquiry_number}\n\nVotre compagnie d'assurance examinera votre demande et vous informera de sa d√©cision.`);
                    closeModal('requestEnquiryModal');
                    form.reset();
                } else {
                    alert('Erreur: ' + (result.error || result.detail || 'Impossible de soumettre la demande'));
                }
            } catch (error) {
                console.error('Error submitting enquiry:', error);
                alert('Erreur de connexion lors de la soumission');
            }
        }

        async function loadInsurancePackages() {
            try {
                const response = await fetchApi('insurance/packages/');
                const data = await response.json();
                allPackages = data.results || data;
                renderPackages();
            } catch (error) {
                console.error('Error loading insurance packages:', error);
                document.getElementById('packagesGrid').innerHTML = '<p class="error-message">Erreur de chargement des packages</p>';
            }
        }

        function renderPackages() {
            const grid = document.getElementById('packagesGrid');

            let filtered = allPackages;
            if (currentFilter !== 'all') {
                filtered = allPackages.filter(p => p.package_type === currentFilter);
            }

            if (!filtered || filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><p>Aucun plan disponible</p></div>';
                return;
            }

            grid.innerHTML = filtered.map((pkg, index) => {
                const isFeatured = pkg.is_featured || index === 1;
                const frequencyText = pkg.payment_frequency === 'monthly' ? 'par mois' :
                    pkg.payment_frequency === 'quarterly' ? 'par trimestre' :
                    pkg.payment_frequency === 'semi_annual' ? 'par semestre' : 'par an';

                return `
                    <div class="package-card ${isFeatured ? 'featured' : ''}">
                        ${isFeatured ? '<div class="featured-badge">Recommand√©</div>' : ''}

                        <div class="package-header">
                            <div class="company-info">
                                ${pkg.company_logo ? `<img src="${pkg.company_logo}" alt="${pkg.company_name}" class="company-logo">` : ''}
                                <div class="company-name">${pkg.company_name}</div>
                            </div>
                            <h3 class="package-name">${pkg.name}</h3>
                            <div class="package-type-badge">${pkg.package_type === 'family' ? 'Famille' : 'Individuel'}</div>
                            <div class="package-price">CFA ${pkg.premium_amount?.toLocaleString() || '0'}</div>
                            <div class="package-period">${frequencyText}</div>
                        </div>

                        <ul class="package-features">
                            <li class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span class="feature-text">Couverture jusqu'√† CFA ${pkg.max_coverage_amount?.toLocaleString() || 'Illimit√©e'}</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span class="feature-text">${pkg.description || 'Protection compl√®te'}</span>
                            </li>
                            ${pkg.is_consultation_free ? `
                            <li class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span class="feature-text">Consultations gratuites</span>
                            </li>
                            ` : pkg.consultation_discount_percentage > 0 ? `
                            <li class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span class="feature-text">R√©duction consultations: ${pkg.consultation_discount_percentage}%</span>
                            </li>
                            ` : ''}
                            <li class="feature-item">
                                <span class="feature-icon">‚úì</span>
                                <span class="feature-text">Paiement ${frequencyText}</span>
                            </li>
                        </ul>

                        <button class="subscribe-btn" onclick="subscribeToPackage('${pkg.id}')">
                            Souscrire
                        </button>
                    </div>
                `;
            }).join('');
        }

        function filterPackages(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderPackages();
        }

        async function subscribeToPackage(packageId) {
            const pkg = allPackages.find(p => p.id === packageId);
            if (!pkg) return;

            const hasActiveSubscription = mySubscriptions.some(s =>
                s.insurance_package === packageId && s.status === 'active'
            );

            if (hasActiveSubscription) {
                alert('Vous avez d√©j√† un abonnement actif √† ce plan d\'assurance.');
                return;
            }

            const frequencyText = pkg.payment_frequency === 'monthly' ? 'mensuel' :
                pkg.payment_frequency === 'quarterly' ? 'trimestriel' :
                pkg.payment_frequency === 'semi_annual' ? 'semestriel' : 'annuel';

            if (!confirm(`Voulez-vous souscrire √† ce plan d'assurance?\n\nPackage: ${pkg.name}\nPrix: ${pkg.premium_amount.toLocaleString()} CFA (${frequencyText})\n\nLe premier paiement sera d√©bit√© imm√©diatement de votre portefeuille. Les paiements suivants seront automatiques selon la fr√©quence choisie.`)) {
                return;
            }

            try {
                const walletResponse = await fetchApi('payments/wallet/');
                const walletData = await walletResponse.json();
                const walletBalance = walletData.results?.[0]?.balance || 0;

                if (walletBalance < pkg.premium_amount) {
                    if (confirm(`Solde insuffisant!\n\nSolde actuel: ${walletBalance.toLocaleString()} CFA\nMontant requis: ${pkg.premium_amount.toLocaleString()} CFA\n\nVoulez-vous voir vos factures?`)) {
                        window.location.href = '/patient/invoices/';
                    }
                    return;
                }
            } catch (error) {
                console.error('Error checking wallet:', error);
            }

            try {
                const response = await fetchApi(`insurance/packages/${packageId}/subscribe/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        payment_method: 'wallet'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`Souscription r√©ussie!\n\nMontant pay√©: ${data.amount_paid?.toLocaleString()} CFA\nR√©f√©rence: ${data.transaction_ref}\nProchain paiement: ${data.next_payment_date}\nFacture: ${data.invoice_number}`);
                    loadMySubscriptions();
                    loadInsurancePackages();
                } else {
                    alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
                }
            } catch (error) {
                console.error('Error subscribing:', error);
                alert('Erreur de connexion');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        loadMySubscriptions();
        loadInsurancePackages();
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>
</html>

