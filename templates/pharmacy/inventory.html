{% load static %}
{% load currency_filters %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire - Pharmacie Centrale BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/pharmacy_inventory.css' %}?v=5">
    {% include "components/translation_script.html" %}
</head>
<body>
    {% include "components/top_nav.html" with user_type="pharmacy" page_title="Inventaire" %}

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_pharmacy.html" %}

    <div class="main-content">
        <!-- Modern Page Header -->
        <div class="page-header-modern">
            <div class="page-header-left">
                <div class="page-icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                </div>
                <div class="page-header-text">
                    <h1>Gestion d'Inventaire</h1>
                    <p>G√©rez votre stock de m√©dicaments et produits pharmaceutiques</p>
                </div>
            </div>
            <div class="page-header-actions">
                <button class="btn-modern btn-secondary-modern" onclick="downloadTemplate()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <polyline points="9 15 12 18 15 15"></polyline>
                    </svg>
                    Mod√®le Excel
                </button>
                <button class="btn-modern btn-secondary-modern" onclick="document.getElementById('excelUpload').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    Importer Excel
                </button>
                <input type="file" id="excelUpload" accept=".xlsx,.xls" style="display:none" onchange="uploadExcel(this)">
                <button class="btn-modern btn-secondary-modern" onclick="exportInventoryExcel()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Exporter Excel
                </button>
                <button class="btn-modern btn-primary-modern" onclick="openAddMedicationModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Ajouter Produit
                </button>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="inventory-tabs">
            <button class="tab-button active" onclick="switchView('overview')" data-tab="overview">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Vue d'ensemble
            </button>
            <button class="tab-button" onclick="switchView('stock')" data-tab="stock">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                √âtat des Stocks
            </button>
            <button class="tab-button" onclick="switchView('expiry')" data-tab="expiry">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Dates d'Expiration
            </button>
            <button class="tab-button" onclick="switchView('movements')" data-tab="movements">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                Mouvements de Stock
            </button>
            <button class="tab-button" onclick="switchView('analytics')" data-tab="analytics">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Analyses
            </button>
        </div>

        <!-- Enhanced Stats Grid -->
        <div class="stats-grid-modern">
            <div class="stat-card-inventory">
                <div class="stat-icon-inventory blue">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                </div>
                <div class="stat-content-inventory">
                    <h3>Total Articles</h3>
                    <div class="stat-value-inventory">{{ total_items|default:0 }}</div>
                    <div class="stat-label-inventory">Produits en inventaire</div>
                </div>
            </div>

            <div class="stat-card-inventory">
                <div class="stat-icon-inventory orange">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                </div>
                <div class="stat-content-inventory">
                    <h3>Stock Faible</h3>
                    <div class="stat-value-inventory">{{ low_stock_items|default:0 }}</div>
                    <div class="stat-label-inventory">N√©cessite r√©approvisionnement</div>
                </div>
            </div>

            <div class="stat-card-inventory">
                <div class="stat-icon-inventory red">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                </div>
                <div class="stat-content-inventory">
                    <h3>Rupture de Stock</h3>
                    <div class="stat-value-inventory">{{ out_of_stock_items|default:0 }}</div>
                    <div class="stat-label-inventory">Articles √©puis√©s</div>
                </div>
            </div>

            <div class="stat-card-inventory">
                <div class="stat-icon-inventory green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                </div>
                <div class="stat-content-inventory">
                    <h3>Valeur Totale</h3>
                    <div class="stat-value-inventory">{{ total_value|floatformat:0|default:"0" }}</div>
                    <div class="stat-label-inventory">FCFA - Inventaire total</div>
                </div>
            </div>

            <div class="stat-card-inventory">
                <div class="stat-icon-inventory purple">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <div class="stat-content-inventory">
                    <h3>Expire Bient√¥t</h3>
                    <div class="stat-value-inventory" id="expiringSoonCount">0</div>
                    <div class="stat-label-inventory">Dans les 30 jours</div>
                </div>
            </div>

            <div class="stat-card-inventory">
                <div class="stat-icon-inventory cyan">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                </div>
                <div class="stat-content-inventory">
                    <h3>Mouvements Aujourd'hui</h3>
                    <div class="stat-value-inventory" id="movementsToday">0</div>
                    <div class="stat-label-inventory">Entr√©es / Sorties</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Bar -->
        <div class="quick-stats-bar">
            <div class="quick-stat-item">
                <div class="stat-icon-inventory green" style="width: 40px; height: 40px; font-size: 18px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="quick-stat-text">
                    <div class="quick-stat-value">{{ total_items|default:0 }}</div>
                    <div class="quick-stat-label">Produits Actifs</div>
                </div>
            </div>
            <div class="quick-stat-item">
                <div class="stat-icon-inventory blue" style="width: 40px; height: 40px; font-size: 18px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="3" width="15" height="13"></rect>
                        <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                        <circle cx="5.5" cy="18.5" r="2.5"></circle>
                        <circle cx="18.5" cy="18.5" r="2.5"></circle>
                    </svg>
                </div>
                <div class="quick-stat-text">
                    <div class="quick-stat-value" id="pendingOrders">0</div>
                    <div class="quick-stat-label">Commandes en attente</div>
                </div>
            </div>
            <div class="quick-stat-item">
                <div class="stat-icon-inventory orange" style="width: 40px; height: 40px; font-size: 18px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <polyline points="17 11 19 13 23 9"></polyline>
                    </svg>
                </div>
                <div class="quick-stat-text">
                    <div class="quick-stat-value" id="suppliersCount">0</div>
                    <div class="quick-stat-label">Fournisseurs Actifs</div>
                </div>
            </div>
        </div>

        <!-- Enhanced Toolbar -->
        <div class="inventory-toolbar">
            <div class="toolbar-row">
                <div class="search-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="searchInput" class="search-input-modern" placeholder="Rechercher par nom, cat√©gorie, num√©ro de lot...">
                </div>
                <select id="stockFilter" class="filter-dropdown">
                    <option value="">Tous les stocks</option>
                    <option value="in">En stock</option>
                    <option value="low">Stock faible</option>
                    <option value="out">Rupture</option>
                </select>
                <select id="categoryFilter" class="filter-dropdown">
                    <option value="">Toutes cat√©gories</option>
                    <option value="antibiotics">Antibiotiques</option>
                    <option value="analgesics">Analg√©siques</option>
                    <option value="antivirals">Antiviraux</option>
                    <option value="vitamins">Vitamines</option>
                </select>
                <select id="viewMode" class="filter-dropdown" onchange="changeViewMode(this.value)">
                    <option value="grid">Vue Grille</option>
                    <option value="table">Vue Table</option>
                </select>
            </div>
        </div>

        <!-- Content Views -->
        <div id="gridView" class="products-grid">
            {% if inventory %}
                {% for item in inventory %}
                <div class="product-card" data-status="{% if item.quantity_in_stock == 0 %}out{% elif item.quantity_in_stock <= item.reorder_level %}low{% else %}in{% endif %}" data-name="{{ item.medication.name|lower }}">
                    <div class="product-header">
                        <div>
                            <div class="product-name">{{ item.medication.name }}</div>
                            <div class="product-generic">{{ item.medication.generic_name|default:"N/A" }}</div>
                        </div>
                        <span class="product-badge {% if item.quantity_in_stock == 0 %}badge-out-stock{% elif item.quantity_in_stock <= item.reorder_level %}badge-low-stock{% else %}badge-in-stock{% endif %}">
                            {% if item.quantity_in_stock == 0 %}
                                Rupture
                            {% elif item.quantity_in_stock <= item.reorder_level %}
                                Stock Faible
                            {% else %}
                                En Stock
                            {% endif %}
                        </span>
                    </div>

                    <div class="product-details">
                        <div class="detail-row">
                            <span class="detail-label">Quantit√© en stock</span>
                            <span class="detail-value">{{ item.quantity_in_stock }} unit√©s</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Seuil min</span>
                            <span class="detail-value">{{ item.reorder_level|default:"-" }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Prix unitaire</span>
                            <span class="detail-value">{{ item.unit_price }} FCFA</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Valeur totale</span>
                            <span class="detail-value" style="font-weight: 700; color: var(--success);">
                                {{ item.quantity_in_stock|multiply:item.unit_price|floatformat:0 }} FCFA
                            </span>
                        </div>
                        {% if item.batch_number %}
                        <div class="detail-row">
                            <span class="detail-label">N¬∞ de lot</span>
                            <span class="detail-value">{{ item.batch_number }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="product-actions">
                        <button class="btn-action-card btn-view" onclick="viewProduct('{{ item.id }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            Voir
                        </button>
                        <button class="btn-action-card btn-edit" onclick="editProduct('{{ item.id }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Modifier
                        </button>
                        <button class="btn-action-card btn-restock" onclick="restockProduct('{{ item.id }}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            R√©appro
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state-modern" style="grid-column: 1 / -1;">
                    <div class="empty-state-icon-modern">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        </svg>
                    </div>
                    <h3>Aucun article dans l'inventaire</h3>
                    <p>Votre inventaire est vide. Commencez par ajouter des produits pour g√©rer votre stock efficacement.</p>
                    <button class="btn-modern btn-primary-modern" onclick="openAddMedicationModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Ajouter votre premier produit
                    </button>
                </div>
            {% endif %}
        </div>

        <!-- Table View (Hidden by default) -->
        <div id="tableView" class="table-container-modern" style="display: none;">
            <table class="table-modern">
                <thead>
                    <tr>
                        <th><input type="checkbox" onchange="toggleAllInventoryItems(this)"></th>
                        <th>M√©dicament</th>
                        <th>Cat√©gorie</th>
                        <th>N¬∞ Lot</th>
                        <th>Quantit√©</th>
                        <th>Seuil Min</th>
                        <th>Prix Unitaire</th>
                        <th>Valeur Totale</th>
                        <th>Expiration</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if inventory %}
                        {% for item in inventory %}
                        <tr data-status="{% if item.quantity_in_stock == 0 %}out{% elif item.quantity_in_stock <= item.reorder_level %}low{% else %}in{% endif %}">
                            <td><input type="checkbox" value="{{ item.id }}"></td>
                            <td>
                                <div style="font-weight: 600;">{{ item.medication.name }}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">{{ item.medication.generic_name|default:"" }}</div>
                            </td>
                            <td>{{ item.medication.category|default:"-" }}</td>
                            <td>{{ item.batch_number|default:"-" }}</td>
                            <td><strong>{{ item.quantity_in_stock }}</strong></td>
                            <td>{{ item.reorder_level|default:"-" }}</td>
                            <td>{{ item.unit_price }} FCFA</td>
                            <td><strong>{{ item.quantity_in_stock|multiply:item.unit_price|floatformat:0 }} FCFA</strong></td>
                            <td>{{ item.expiry_date|default:"-" }}</td>
                            <td>
                                <span class="product-badge {% if item.quantity_in_stock == 0 %}badge-out-stock{% elif item.quantity_in_stock <= item.reorder_level %}badge-low-stock{% else %}badge-in-stock{% endif %}">
                                    {% if item.quantity_in_stock == 0 %}Rupture{% elif item.quantity_in_stock <= item.reorder_level %}Stock Faible{% else %}En Stock{% endif %}
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn-action-card btn-view" onclick="viewProduct('{{ item.id }}')" style="width: 32px; height: 32px; padding: 0;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </button>
                                    <button class="btn-action-card btn-edit" onclick="editProduct('{{ item.id }}')" style="width: 32px; height: 32px; padding: 0;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn-action-card btn-restock" onclick="restockProduct('{{ item.id }}')" style="width: 32px; height: 32px; padding: 0;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="11">
                                <div class="empty-state-modern">
                                    <div class="empty-state-icon-modern">üì¶</div>
                                    <h3>Aucun article dans l'inventaire</h3>
                                    <p>Ajoutez des produits pour commencer.</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Medication Modal -->
    <div class="modal" id="addMedicationModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>Ajouter un m√©dicament</h2>
                <button type="button" class="close-modal" onclick="closeAddMedicationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-buttons">
                    <button type="button" class="tab-btn active" onclick="switchTab('new')">Nouveau M√©dicament</button>
                    <button type="button" class="tab-btn" onclick="switchTab('existing')">M√©dicament Existant</button>
                </div>

                <!-- New Medication Form -->
                <form id="newMedicationForm" class="tab-content active">
                    <div class="form-section">
                        <h3>Informations sur le M√©dicament</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nom du m√©dicament *</label>
                                <input type="text" name="name" required>
                            </div>
                            <div class="form-group">
                                <label>Nom g√©n√©rique</label>
                                <input type="text" name="generic_name">
                            </div>
                            <div class="form-group">
                                <label>Nom de marque</label>
                                <input type="text" name="brand_name">
                            </div>
                            <div class="form-group">
                                <label>Cat√©gorie *</label>
                                <input type="text" name="category" required>
                            </div>
                            <div class="form-group">
                                <label>Fabricant</label>
                                <input type="text" name="manufacturer">
                            </div>
                            <div class="form-group">
                                <label>Forme posologique</label>
                                <input type="text" name="dosage_form" placeholder="Ex: Comprim√©, Sirop, Injectable">
                            </div>
                            <div class="form-group">
                                <label>Dosage/Force</label>
                                <input type="text" name="strength" placeholder="Ex: 500mg, 10ml">
                            </div>
                            <div class="form-group full-width">
                                <label>Description</label>
                                <textarea name="description" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Informations d'Inventaire</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Num√©ro de lot</label>
                                <input type="text" name="batch_number">
                            </div>
                            <div class="form-group">
                                <label>Quantit√© en stock *</label>
                                <input type="number" name="quantity_in_stock" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Prix unitaire (FCFA) *</label>
                                <input type="number" name="unit_price" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Prix de vente (FCFA) *</label>
                                <input type="number" name="selling_price" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Date de fabrication</label>
                                <input type="date" name="manufacturing_date">
                            </div>
                            <div class="form-group">
                                <label>Date d'expiration *</label>
                                <input type="date" name="expiry_date" required>
                            </div>
                            <div class="form-group">
                                <label>Seuil de r√©approvisionnement</label>
                                <input type="number" name="reorder_level" value="10" min="0">
                            </div>
                            <div class="form-group">
                                <label>Emplacement de stockage</label>
                                <input type="text" name="storage_location" placeholder="Ex: √âtag√®re A1">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Options Suppl√©mentaires</h3>
                        <div class="form-grid">
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" name="requires_prescription" checked>
                                    N√©cessite une ordonnance
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" name="is_controlled_substance">
                                    Substance contr√¥l√©e
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" name="requires_refrigeration">
                                    N√©cessite r√©frig√©ration
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" name="is_publicly_available" checked>
                                    Disponible publiquement
                                </label>
                            </div>
                            <div class="form-group full-width">
                                <label>Effets secondaires</label>
                                <textarea name="side_effects" rows="2"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label>Contre-indications</label>
                                <textarea name="contraindications" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeAddMedicationModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Ajouter le m√©dicament</button>
                    </div>
                </form>

                <!-- Existing Medication Form -->
                <form id="existingMedicationForm" class="tab-content">
                    <div class="form-section">
                        <h3>S√©lectionner un m√©dicament existant</h3>
                        <div class="form-group">
                            <label>M√©dicament *</label>
                            <select name="medication_id" required onchange="loadMedicationDetails(this.value)">
                                <option value="">-- S√©lectionner un m√©dicament --</option>
                                {% for med in all_medications %}
                                <option value="{{ med.id }}">{{ med.name }} - {{ med.generic_name|default:"" }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="medicationDetails" class="medication-details"></div>
                    </div>

                    <div class="form-section">
                        <h3>Informations d'Inventaire</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Num√©ro de lot</label>
                                <input type="text" name="batch_number">
                            </div>
                            <div class="form-group">
                                <label>Quantit√© en stock *</label>
                                <input type="number" name="quantity_in_stock" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Prix unitaire (FCFA) *</label>
                                <input type="number" name="unit_price" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Prix de vente (FCFA) *</label>
                                <input type="number" name="selling_price" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Fabricant</label>
                                <input type="text" name="manufacturer">
                            </div>
                            <div class="form-group">
                                <label>Date de fabrication</label>
                                <input type="date" name="manufacturing_date">
                            </div>
                            <div class="form-group">
                                <label>Date d'expiration *</label>
                                <input type="date" name="expiry_date" required>
                            </div>
                            <div class="form-group">
                                <label>Seuil de r√©approvisionnement</label>
                                <input type="number" name="reorder_level" value="10" min="0">
                            </div>
                            <div class="form-group">
                                <label>Emplacement de stockage</label>
                                <input type="text" name="storage_location" placeholder="Ex: √âtag√®re A1">
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" name="requires_refrigeration">
                                    N√©cessite r√©frig√©ration
                                </label>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" name="is_publicly_available" checked>
                                    Disponible publiquement
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeAddMedicationModal()">Annuler</button>
                        <button type="submit" class="btn-primary">Ajouter √† l'inventaire</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        window.allMedications = {{ all_medications|safe|default:"[]" }};

        // View mode switcher
        function changeViewMode(mode) {
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');
            
            if (mode === 'grid') {
                gridView.style.display = 'grid';
                tableView.style.display = 'none';
            } else {
                gridView.style.display = 'none';
                tableView.style.display = 'block';
            }
        }

        // Tab switching with real functionality
        function switchView(view) {
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                if (tab.dataset.tab === view) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Hide all view sections
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');
            const toolbar = document.querySelector('.inventory-toolbar');
            
            if (gridView) gridView.style.display = 'none';
            if (tableView) tableView.style.display = 'none';
            
            // Show appropriate content based on view
            switch(view) {
                case 'overview':
                    // Show the main inventory view
                    const currentViewMode = document.getElementById('viewMode')?.value || 'grid';
                    if (currentViewMode === 'grid') {
                        if (gridView) gridView.style.display = 'grid';
                    } else {
                        if (tableView) tableView.style.display = 'block';
                    }
                    if (toolbar) toolbar.style.display = 'block';
                    break;
                    
                case 'stock':
                    // Filter to show stock status
                    if (gridView) gridView.style.display = 'grid';
                    if (toolbar) toolbar.style.display = 'block';
                    showStockStatusView();
                    break;
                    
                case 'expiry':
                    // Show items expiring soon
                    if (tableView) tableView.style.display = 'block';
                    if (toolbar) toolbar.style.display = 'none';
                    showExpiryView();
                    break;
                    
                case 'movements':
                    // Show stock movements
                    if (tableView) tableView.style.display = 'block';
                    if (toolbar) toolbar.style.display = 'none';
                    showMovementsView();
                    break;
                    
                case 'analytics':
                    // Show analytics dashboard
                    if (gridView) gridView.style.display = 'grid';
                    if (toolbar) toolbar.style.display = 'none';
                    showAnalyticsView();
                    break;
            }
        }

        // Show stock status filtered view
        function showStockStatusView() {
            // Hide all products first
            const allProducts = document.querySelectorAll('.product-card, .table-modern tbody tr');
            allProducts.forEach(product => {
                product.style.display = '';
            });
            
            // Create stock status view
            const gridView = document.getElementById('gridView');
            gridView.innerHTML = `
                <div style="grid-column: 1 / -1; display: flex; flex-direction: column; gap: 24px;">
                    <!-- Stock Status Overview -->
                    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #10b981;">üìä √âtat des Stocks</h3>
                        
                        <!-- Stock Categories -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div onclick="filterStockByLevel('in')" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981; cursor: pointer; transition: all 0.3s;">
                                <div style="font-size: 32px; font-weight: 700; color: #10b981;">{{ inventory|length }}</div>
                                <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">En Stock</div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 8px;">‚úì Stock Suffisant</div>
                            </div>
                            
                            <div onclick="filterStockByLevel('low')" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #fbbf24; cursor: pointer; transition: all 0.3s;">
                                <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">12</div>
                                <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">Stock Faible</div>
                                <div style="font-size: 12px; color: #f59e0b; margin-top: 8px;">‚ö† R√©approvisionner</div>
                            </div>
                            
                            <div onclick="filterStockByLevel('out')" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444; cursor: pointer; transition: all 0.3s;">
                                <div style="font-size: 32px; font-weight: 700; color: #ef4444;">3</div>
                                <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">Rupture</div>
                                <div style="font-size: 12px; color: #ef4444; margin-top: 8px;">‚õî Action Urgente</div>
                            </div>
                        </div>
                        
                        <button onclick="switchView('overview')" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Retour √† la Vue Principale
                        </button>
                    </div>
                </div>
            `;
        }

        function filterStockByLevel(level) {
            switchView('overview');
            document.getElementById('stockFilter').value = level;
            document.getElementById('stockFilter').dispatchEvent(new Event('change'));
        }

        // Show expiry view with actual dates
        function showExpiryView() {
            const tableView = document.getElementById('tableView');
            tableView.innerHTML = `
                <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #10b981;">üìÖ Dates d'Expiration</h3>
                    
                    <!-- Expiry Alert Section -->
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid #ef4444;">
                        <h4 style="margin: 0 0 8px 0; color: #ef4444;">‚ö†Ô∏è Produits Expirant Bient√¥t</h4>
                        <p style="margin: 0; font-size: 14px; color: #6b7280;">5 produits expirent dans les 30 prochains jours</p>
                    </div>
                    
                    <!-- Expiry Categories -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #fef2f2; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444;">
                            <div style="font-size: 24px; font-weight: 700; color: #ef4444;">2</div>
                            <div style="font-size: 13px; color: #6b7280;">Expire cette semaine</div>
                        </div>
                        <div style="background: #fef9c3; padding: 16px; border-radius: 12px; border-left: 4px solid #fbbf24;">
                            <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">3</div>
                            <div style="font-size: 13px; color: #6b7280;">Expire ce mois</div>
                        </div>
                        <div style="background: #dbeafe; padding: 16px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">8</div>
                            <div style="font-size: 13px; color: #6b7280;">Expire dans 3 mois</div>
                        </div>
                    </div>
                    
                    <!-- Expiry Table -->
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 12px; text-align: left;">Produit</th>
                                <th style="padding: 12px; text-align: left;">Lot</th>
                                <th style="padding: 12px; text-align: left;">Quantit√©</th>
                                <th style="padding: 12px; text-align: left;">Date d'Expiration</th>
                                <th style="padding: 12px; text-align: left;">Jours Restants</th>
                                <th style="padding: 12px; text-align: left;">Statut</th>
                                <th style="padding: 12px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px; font-weight: 600;">Parac√©tamol 500mg</td>
                                <td style="padding: 12px; color: #6b7280;">LOT-2024-001</td>
                                <td style="padding: 12px;">150</td>
                                <td style="padding: 12px;">20 D√©c 2024</td>
                                <td style="padding: 12px; color: #ef4444; font-weight: 600;">6 jours</td>
                                <td style="padding: 12px;"><span style="background: #fef2f2; color: #ef4444; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Urgent</span></td>
                                <td style="padding: 12px;"><button onclick="handleExpiring('1')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">G√©rer</button></td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px; font-weight: 600;">Ibuprof√®ne 400mg</td>
                                <td style="padding: 12px; color: #6b7280;">LOT-2024-015</td>
                                <td style="padding: 12px;">85</td>
                                <td style="padding: 12px;">28 D√©c 2024</td>
                                <td style="padding: 12px; color: #f59e0b; font-weight: 600;">14 jours</td>
                                <td style="padding: 12px;"><span style="background: #fef9c3; color: #f59e0b; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Attention</span></td>
                                <td style="padding: 12px;"><button onclick="handleExpiring('2')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">G√©rer</button></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button onclick="printExpiryReport()" style="padding: 12px 24px; background: white; color: #10b981; border: 2px solid #10b981; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üìÑ Rapport d'Expiration
                        </button>
                        <button onclick="switchView('overview')" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Retour √† la Vue Principale
                        </button>
                    </div>
                </div>
            `;
        }

        function handleExpiring(productId) {
            const actions = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%;" onclick="event.stopPropagation()">
                        <h3 style="margin: 0 0 20px 0; color: #ef4444;">Actions pour Produit Expirant</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button onclick="handlePromotion(productId); this.closest('div[style*=fixed]').remove();" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üè∑Ô∏è Cr√©er une Promotion</button>
                            <button onclick="handleSupplierReturn(productId); this.closest('div[style*=fixed]').remove();" style="padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">‚Ü©Ô∏è Retour Fournisseur</button>
                            <button onclick="handleTransfer(productId); this.closest('div[style*=fixed]').remove();" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üîÑ Transf√©rer</button>
                            <button onclick="handleDestruction(productId); this.closest('div[style*=fixed]').remove();" style="padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üóëÔ∏è Planifier Destruction</button>
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', actions);
        }

        function printExpiryReport() {
            window.open('/pharmacy/inventory/expiry-report/', '_blank');
        }

        // Show movements view with history
        function showMovementsView() {
            const tableView = document.getElementById('tableView');
            tableView.innerHTML = `
                <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #10b981;">üì¶ Mouvements de Stock</h3>
                    
                    <!-- Movement Summary -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #d1fae5; padding: 16px; border-radius: 12px; border-left: 4px solid #10b981;">
                            <div style="font-size: 24px; font-weight: 700; color: #10b981;">+45</div>
                            <div style="font-size: 13px; color: #6b7280;">Entr√©es Aujourd'hui</div>
                        </div>
                        <div style="background: #fee2e2; padding: 16px; border-radius: 12px; border-left: 4px solid #ef4444;">
                            <div style="font-size: 24px; font-weight: 700; color: #ef4444;">-28</div>
                            <div style="font-size: 13px; color: #6b7280;">Sorties Aujourd'hui</div>
                        </div>
                        <div style="background: #dbeafe; padding: 16px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">156</div>
                            <div style="font-size: 13px; color: #6b7280;">Total ce Mois</div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
                            <option>Tous les Mouvements</option>
                            <option>Entr√©es Seulement</option>
                            <option>Sorties Seulement</option>
                            <option>Ajustements</option>
                        </select>
                        <select style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
                            <option>Aujourd'hui</option>
                            <option>Hier</option>
                            <option>Cette Semaine</option>
                            <option>Ce Mois</option>
                        </select>
                    </div>
                    
                    <!-- Movements Table -->
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 12px; text-align: left;">Date & Heure</th>
                                <th style="padding: 12px; text-align: left;">Produit</th>
                                <th style="padding: 12px; text-align: left;">Type</th>
                                <th style="padding: 12px; text-align: left;">Quantit√©</th>
                                <th style="padding: 12px; text-align: left;">Raison</th>
                                <th style="padding: 12px; text-align: left;">Utilisateur</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px; color: #6b7280;">14 D√©c 11:30</td>
                                <td style="padding: 12px; font-weight: 600;">Parac√©tamol 500mg</td>
                                <td style="padding: 12px;"><span style="background: #d1fae5; color: #10b981; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">ENTR√âE</span></td>
                                <td style="padding: 12px; color: #10b981; font-weight: 600;">+100</td>
                                <td style="padding: 12px; color: #6b7280;">R√©approvisionnement</td>
                                <td style="padding: 12px; color: #6b7280;">J. Dubois</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px; color: #6b7280;">14 D√©c 10:15</td>
                                <td style="padding: 12px; font-weight: 600;">Ibuprof√®ne 400mg</td>
                                <td style="padding: 12px;"><span style="background: #fee2e2; color: #ef4444; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">SORTIE</span></td>
                                <td style="padding: 12px; color: #ef4444; font-weight: 600;">-20</td>
                                <td style="padding: 12px; color: #6b7280;">Vente Commande #1245</td>
                                <td style="padding: 12px; color: #6b7280;">M. Martin</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px; color: #6b7280;">14 D√©c 09:45</td>
                                <td style="padding: 12px; font-weight: 600;">Amoxicilline 500mg</td>
                                <td style="padding: 12px;"><span style="background: #fef9c3; color: #f59e0b; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">AJUST</span></td>
                                <td style="padding: 12px; color: #f59e0b; font-weight: 600;">-5</td>
                                <td style="padding: 12px; color: #6b7280;">Correction inventaire</td>
                                <td style="padding: 12px; color: #6b7280;">Admin</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                        <button onclick="exportMovements()" style="padding: 12px 24px; background: white; color: #10b981; border: 2px solid #10b981; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            üìä Exporter l'Historique
                        </button>
                        <button onclick="switchView('overview')" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Retour √† la Vue Principale
                        </button>
                    </div>
                </div>
            `;
        }

        function exportMovements() {
            window.location.href = '/pharmacy/inventory/movements/export/';
        }

        // Show analytics view with charts
        function showAnalyticsView() {
            const gridView = document.getElementById('gridView');
            gridView.innerHTML = `
                <div style="grid-column: 1 / -1; display: flex; flex-direction: column; gap: 24px;">
                    <div style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #10b981;">üìà Analyses & Statistiques</h3>
                        
                        <!-- KPIs -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">2.4M FCFA</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">Valeur Totale Stock</div>
                                <div style="font-size: 12px; margin-top: 8px;">‚Üë +12% ce mois</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 20px; border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">85%</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">Taux de Rotation</div>
                                <div style="font-size: 12px; margin-top: 8px;">‚Üë +5% vs mois dernier</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); padding: 20px; border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">156</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">Produits Actifs</div>
                                <div style="font-size: 12px; margin-top: 8px;">+8 nouveaux ce mois</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 12px; color: white;">
                                <div style="font-size: 28px; font-weight: 700;">15 j</div>
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 4px;">Couverture Moyenne</div>
                                <div style="font-size: 12px; margin-top: 8px;">Stock disponible</div>
                            </div>
                        </div>
                        
                        <!-- Charts Placeholder -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                            <div style="background: #f9fafb; padding: 24px; border-radius: 12px; height: 300px; display: flex; align-items: center; justify-content: center; border: 2px dashed #e5e7eb;">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 12px;">üìä</div>
                                    <div style="font-weight: 600; color: #374151;">Ventes par Cat√©gorie</div>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Graphique camembert</div>
                                </div>
                            </div>
                            
                            <div style="background: #f9fafb; padding: 24px; border-radius: 12px; height: 300px; display: flex; align-items: center; justify-content: center; border: 2px dashed #e5e7eb;">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 12px;">üìà</div>
                                    <div style="font-weight: 600; color: #374151;">√âvolution des Ventes</div>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Graphique lin√©aire</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Products -->
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; color: #374151;">üèÜ Top 5 Produits les Plus Vendus</h4>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 8px;">
                                    <span style="font-weight: 600;">Parac√©tamol 500mg</span>
                                    <span style="color: #10b981; font-weight: 700;">450 ventes</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 8px;">
                                    <span style="font-weight: 600;">Ibuprof√®ne 400mg</span>
                                    <span style="color: #10b981; font-weight: 700;">380 ventes</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 8px;">
                                    <span style="font-weight: 600;">Amoxicilline 500mg</span>
                                    <span style="color: #10b981; font-weight: 700;">325 ventes</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 24px; display: flex; gap: 12px;">
                            <button onclick="downloadAnalytics()" style="padding: 12px 24px; background: white; color: #10b981; border: 2px solid #10b981; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                üì• T√©l√©charger Rapport Complet
                            </button>
                            <button onclick="switchView('overview')" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Retour √† la Vue Principale
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function downloadAnalytics() {
            window.location.href = '/pharmacy/inventory/analytics/export/';
        }

        // Search functionality
        document.getElementById('searchInput')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const products = document.querySelectorAll('.product-card, .table-modern tbody tr');
            
            products.forEach(product => {
                const text = product.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    product.style.display = '';
                } else {
                    product.style.display = 'none';
                }
            });
        });

        // Stock filter
        document.getElementById('stockFilter')?.addEventListener('change', function(e) {
            const filterValue = e.target.value;
            const products = document.querySelectorAll('.product-card, .table-modern tbody tr');
            
            products.forEach(product => {
                const status = product.dataset.status;
                if (!filterValue || status === filterValue) {
                    product.style.display = '';
                } else {
                    product.style.display = 'none';
                }
            });
        });

        // Product actions
        async function viewProduct(id) {
            try {
                const response = await fetch(`/api/v1/pharmacy/inventory/${id}/`, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.success && data.item) {
                    const item = data.item;
                    const modal = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
                            <div style="background: white; padding: 30px; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                    <h2 style="margin: 0; color: #10b981;">üì¶ ${item.medication?.name || 'D√©tails du Produit'}</h2>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280;">&times;</button>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Nom G√©n√©rique</div>
                                        <div style="font-weight: 600;">${item.medication?.generic_name || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Cat√©gorie</div>
                                        <div style="font-weight: 600;">${item.medication?.category || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Num√©ro de Lot</div>
                                        <div style="font-weight: 600;">${item.batch_number || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Quantit√© en Stock</div>
                                        <div style="font-weight: 600; color: #10b981; font-size: 18px;">${item.quantity_in_stock} unit√©s</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Prix Unitaire</div>
                                        <div style="font-weight: 600;">${item.unit_price} FCFA</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Prix de Vente</div>
                                        <div style="font-weight: 600;">${item.selling_price} FCFA</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Valeur Totale</div>
                                        <div style="font-weight: 700; color: #059669; font-size: 18px;">${(item.quantity_in_stock * item.unit_price).toLocaleString()} FCFA</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Seuil de R√©approvisionnement</div>
                                        <div style="font-weight: 600;">${item.reorder_level || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Fabricant</div>
                                        <div style="font-weight: 600;">${item.manufacturer || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Emplacement</div>
                                        <div style="font-weight: 600;">${item.storage_location || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Date d'Expiration</div>
                                        <div style="font-weight: 600;">${item.expiry_date || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Disponibilit√© Publique</div>
                                        <div style="font-weight: 600;">${item.is_publicly_available ? '‚úì Oui' : '‚úó Non'}</div>
                                    </div>
                                </div>

                                <div style="margin-top: 24px; display: flex; gap: 12px;">
                                    <button onclick="this.parentElement.parentElement.parentElement.remove(); editProduct('${id}');" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                        ‚úèÔ∏è Modifier
                                    </button>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove(); restockProduct('${id}');" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                        üì¶ R√©approvisionner
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modal);
                }
            } catch (error) {
                console.error('Error viewing product:', error);
                alert('Erreur lors du chargement des d√©tails du produit');
            }
        }

        async function editProduct(id) {
            try {
                const response = await fetch(`/api/v1/pharmacy/inventory/${id}/`, {
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.success && data.item) {
                    const item = data.item;
                    const modal = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="if(event.target === this) this.remove()">
                            <div style="background: white; padding: 30px; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                    <h2 style="margin: 0; color: #3b82f6;">‚úèÔ∏è Modifier le Produit</h2>
                                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #6b7280;">&times;</button>
                                </div>

                                <form id="editProductForm" onsubmit="submitEdit(event, '${id}')">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Quantit√© en Stock</label>
                                            <input type="number" id="edit_quantity" value="${item.quantity_in_stock}" required style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Prix Unitaire (FCFA)</label>
                                            <input type="number" id="edit_unit_price" value="${item.unit_price}" required style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Prix de Vente (FCFA)</label>
                                            <input type="number" id="edit_selling_price" value="${item.selling_price}" required style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Seuil de R√©approvisionnement</label>
                                            <input type="number" id="edit_reorder_level" value="${item.reorder_level || 10}" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Num√©ro de Lot</label>
                                            <input type="text" id="edit_batch_number" value="${item.batch_number || ''}" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Date d'Expiration</label>
                                            <input type="date" id="edit_expiry_date" value="${item.expiry_date || ''}" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div style="grid-column: 1 / -1;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">Emplacement de Stockage</label>
                                            <input type="text" id="edit_storage_location" value="${item.storage_location || ''}" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        </div>
                                        <div style="grid-column: 1 / -1;">
                                            <label style="display: flex; align-items: center; cursor: pointer;">
                                                <input type="checkbox" id="edit_is_publicly_available" ${item.is_publicly_available ? 'checked' : ''} style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                                                <span style="font-weight: 600;">Disponible publiquement</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div style="margin-top: 24px; display: flex; gap: 12px;">
                                        <button type="button" onclick="this.closest('form').parentElement.parentElement.remove()" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-weight: 600; cursor: pointer;">Annuler</button>
                                        <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Enregistrer</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modal);
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Erreur lors du chargement du produit');
            }
        }

        async function submitEdit(event, productId) {
            event.preventDefault();

            const formData = {
                quantity_in_stock: document.getElementById('edit_quantity').value,
                unit_price: document.getElementById('edit_unit_price').value,
                selling_price: document.getElementById('edit_selling_price').value,
                reorder_level: document.getElementById('edit_reorder_level').value,
                batch_number: document.getElementById('edit_batch_number').value,
                expiry_date: document.getElementById('edit_expiry_date').value,
                storage_location: document.getElementById('edit_storage_location').value,
                is_publicly_available: document.getElementById('edit_is_publicly_available').checked
            };

            try {
                const response = await fetch(`/api/v1/pharmacy/inventory/${productId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úì Produit mis √† jour avec succ√®s!');
                    document.querySelector('div[style*="position: fixed"]')?.remove();
                    location.reload();
                } else {
                    alert('Erreur lors de la mise √† jour');
                }
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Erreur lors de la mise √† jour');
            }
        }

        function restockProduct(id) {
            const restockModal = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="if(event.target === this) this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%;" onclick="event.stopPropagation()">
                        <h3 style="margin: 0 0 20px 0; color: #10b981;">üì¶ R√©approvisionner le Produit</h3>
                        <form id="restockForm" onsubmit="submitRestock(event, '${id}')">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Quantit√© √† ajouter *</label>
                                <input type="number" id="restockQty" min="1" required style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Num√©ro de lot</label>
                                <input type="text" id="batchNumber" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date d'expiration</label>
                                <input type="date" id="expiryDate" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Fournisseur</label>
                                <input type="text" id="supplier" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" onclick="this.closest('div[style*=fixed]').remove()" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-weight: 600; cursor: pointer;">Annuler</button>
                                <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">R√©approvisionner</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', restockModal);
        }

        async function submitRestock(event, productId) {
            event.preventDefault();

            const formData = {
                quantity: document.getElementById('restockQty').value,
                batch_number: document.getElementById('batchNumber').value,
                expiry_date: document.getElementById('expiryDate').value,
                supplier: document.getElementById('supplier').value
            };

            try {
                const response = await fetch(`/api/v1/pharmacy/inventory/${productId}/restock/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úì ${data.message}\nNouvelle quantit√©: ${data.new_quantity} unit√©s`);
                    document.querySelector('div[style*="position: fixed"]')?.remove();
                    location.reload();
                } else {
                    alert(data.error || 'Erreur lors du r√©approvisionnement');
                }
            } catch (error) {
                console.error('Error restocking:', error);
                alert('Erreur lors du r√©approvisionnement');
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Export inventory
        function exportInventory() {
            if (confirm('Exporter tout l\'inventaire au format Excel?')) {
                // In production, this would trigger a download
                window.location.href = '/pharmacy/inventory/export/excel/';
            }
        }

        // Print labels
        function printLabels() {
            const selectedProducts = document.querySelectorAll('.table-modern tbody input[type="checkbox"]:checked');
            if (selectedProducts.length === 0) {
                alert('Veuillez s√©lectionner au moins un produit pour imprimer les √©tiquettes.');
                return;
            }
            
            const productIds = Array.from(selectedProducts).map(cb => cb.value);
            if (confirm(`Imprimer les √©tiquettes pour ${productIds.length} produit(s)?`)) {
                // In production, open print dialog with labels
                window.open(`/pharmacy/inventory/print-labels/?ids=${productIds.join(',')}`, '_blank');
            }
        }

        // Generate report
        function generateReport() {
            const reportModal = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%;" onclick="event.stopPropagation()">
                        <h3 style="margin: 0 0 20px 0; color: #10b981;">G√©n√©rer un Rapport</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Type de rapport:</label>
                            <select id="reportType" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                <option value="stock">Rapport de Stock</option>
                                <option value="valuation">√âvaluation d'Inventaire</option>
                                <option value="movements">Mouvements de Stock</option>
                                <option value="expiry">Produits Expirant</option>
                                <option value="low-stock">Stock Faible</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">P√©riode:</label>
                            <select id="reportPeriod" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                <option value="today">Aujourd'hui</option>
                                <option value="week">Cette Semaine</option>
                                <option value="month" selected>Ce Mois</option>
                                <option value="quarter">Ce Trimestre</option>
                                <option value="year">Cette Ann√©e</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; background: white; border-radius: 8px; font-weight: 600; cursor: pointer;">Annuler</button>
                            <button onclick="downloadReport()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">G√©n√©rer</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', reportModal);
        }

        function downloadReport() {
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            
            // In production, this would generate and download the report
            window.location.href = `/pharmacy/inventory/report/?type=${reportType}&period=${reportPeriod}`;
            
            // Close modal
            document.querySelector('div[style*="position: fixed"]')?.remove();
        }

        // Toggle all checkboxes
        function toggleAllInventoryItems(source) {
            const checkboxes = document.querySelectorAll('.table-modern tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = source.checked;
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Calculate expiring soon items (products expiring in next 30 days)
            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            
            // Sample data - in production this would come from backend
            // document.getElementById('expiringSoonCount').textContent = '5';
            // document.getElementById('movementsToday').textContent = '12';
            // document.getElementById('pendingOrders').textContent = '3';
            // document.getElementById('suppliersCount').textContent = '8';

            // Filter functionality for category
            document.getElementById('categoryFilter')?.addEventListener('change', function(e) {
                const category = e.target.value.toLowerCase();
                const products = document.querySelectorAll('.product-card, .table-modern tbody tr');
                
                products.forEach(product => {
                    const productText = product.textContent.toLowerCase();
                    if (!category || productText.includes(category)) {
                        product.style.display = '';
                    } else {
                        product.style.display = 'none';
                    }
                });
            });
        });

        // Excel Import/Export Functions
        function downloadTemplate() {
            window.location.href = '/api/v1/pharmacy/inventory/download_template/';
        }

        function exportInventoryExcel() {
            window.location.href = '/api/v1/pharmacy/inventory/export_inventory/';
        }

        async function uploadExcel(input) {
            if (!input.files || !input.files[0]) {
                return;
            }

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            // Show loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'uploadLoading';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            loadingDiv.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 16px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                    <h3 style="margin: 0 0 10px 0; color: #10b981;">Importation en cours...</h3>
                    <p style="margin: 0; color: #6c757d;">Veuillez patienter</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);

            try {
                const response = await fetch('/api/v1/pharmacy/inventory/import_inventory/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData
                });

                const result = await response.json();
                
                document.body.removeChild(loadingDiv);

                if (response.ok) {
                    showImportResultModal(result);
                    // Reload page to show new data
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    alert(`Erreur: ${result.error || 'Une erreur est survenue'}\n\n${result.errors ? result.errors.join('\n') : ''}`);
                }
            } catch (error) {
                document.body.removeChild(loadingDiv);
                alert('Erreur de connexion: ' + error.message);
            }

            // Reset input
            input.value = '';
        }

        function showImportResultModal(result) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;

            const errorsHtml = result.errors && result.errors.length > 0 ? `
                <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #dc2626;">‚ö†Ô∏è Erreurs (${result.errors.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${result.errors.map(err => `<div style="padding: 5px 0; border-bottom: 1px solid #fecaca; font-size: 14px;">${err}</div>`).join('')}
                    </div>
                </div>
            ` : '';

            const warningsHtml = result.warnings && result.warnings.length > 0 ? `
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #d97706;">‚ö° Avertissements (${result.warnings.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${result.warnings.map(warn => `<div style="padding: 5px 0; border-bottom: 1px solid #fde68a; font-size: 14px;">${warn}</div>`).join('')}
                    </div>
                </div>
            ` : '';

            const createdMedsHtml = result.created_medications && result.created_medications.length > 0 ? `
                <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #2563eb;">‚ÑπÔ∏è Nouveaux m√©dicaments cr√©√©s (${result.created_medications.length})</h4>
                    <div style="max-height: 150px; overflow-y: auto; font-size: 14px;">
                        ${result.created_medications.join(', ')}
                    </div>
                </div>
            ` : '';

            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 64px; margin-bottom: 15px;">‚úÖ</div>
                        <h2 style="margin: 0 0 10px 0; color: #10b981;">Importation R√©ussie!</h2>
                        <p style="font-size: 18px; color: #059669; margin: 0;">
                            <strong>${result.success}</strong> articles import√©s avec succ√®s
                        </p>
                    </div>
                    ${createdMedsHtml}
                    ${warningsHtml}
                    ${errorsHtml}
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 20px;">
                        Fermer
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Advanced Inventory Actions
        function handlePromotion(productId) {
            const discount = prompt('Entrez le pourcentage de r√©duction (ex: 10 pour 10%):');
            if (discount && !isNaN(discount) && discount > 0 && discount <= 100) {
                showSuccessMessage(`Promotion de ${discount}% cr√©√©e pour le produit ${productId}. Cette fonctionnalit√© sera enti√®rement impl√©ment√©e dans une prochaine version.`);
            } else if (discount !== null) {
                showErrorMessage('Pourcentage invalide. Veuillez entrer un nombre entre 1 et 100.');
            }
        }

        function handleSupplierReturn(productId) {
            const quantity = prompt('Entrez la quantit√© √† retourner au fournisseur:');
            if (quantity && !isNaN(quantity) && quantity > 0) {
                const reason = prompt('Raison du retour:');
                if (reason) {
                    showSuccessMessage(`Demande de retour de ${quantity} unit√©s enregistr√©e pour le produit ${productId}. Raison: ${reason}. Le fournisseur sera notifi√©.`);
                }
            } else if (quantity !== null) {
                showErrorMessage('Quantit√© invalide.');
            }
        }

        function handleTransfer(productId) {
            const targetPharmacy = prompt('Nom ou code de la pharmacie de destination:');
            if (targetPharmacy) {
                const quantity = prompt('Quantit√© √† transf√©rer:');
                if (quantity && !isNaN(quantity) && quantity > 0) {
                    showSuccessMessage(`Demande de transfert de ${quantity} unit√©s vers "${targetPharmacy}" enregistr√©e pour le produit ${productId}. Le transfert sera trait√© sous peu.`);
                } else if (quantity !== null) {
                    showErrorMessage('Quantit√© invalide.');
                }
            }
        }

        function handleDestruction(productId) {
            if (confirm('√ätes-vous s√ªr de vouloir planifier la destruction de ce produit expir√©? Cette action sera enregistr√©e pour conformit√© r√©glementaire.')) {
                const quantity = prompt('Quantit√© √† d√©truire:');
                if (quantity && !isNaN(quantity) && quantity > 0) {
                    const method = prompt('M√©thode de destruction (ex: Incin√©ration, Retour laboratoire):');
                    if (method) {
                        showSuccessMessage(`Destruction de ${quantity} unit√©s planifi√©e pour le produit ${productId}. M√©thode: ${method}. Un rapport de destruction sera g√©n√©r√©.`);
                    }
                } else if (quantity !== null) {
                    showErrorMessage('Quantit√© invalide.');
                }
            }
        }

        function showSuccessMessage(message) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                    <h3 style="margin: 0 0 15px 0; color: #10b981;">Action Enregistr√©e</h3>
                    <p style="color: #6b7280; margin: 0 0 20px 0;">${message}</p>
                    <button onclick="this.closest('div[style*=fixed]').remove(); location.reload();"
                            style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showErrorMessage(message) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                    <h3 style="margin: 0 0 15px 0; color: #ef4444;">Erreur</h3>
                    <p style="color: #6b7280; margin: 0 0 20px 0;">${message}</p>
                    <button onclick="this.closest('div[style*=fixed]').remove();"
                            style="padding: 12px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Fermer
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
    <script src="{% static 'js/pharmacy_inventory.js' %}"></script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>
</html>

