{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports - Assurance Santé BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/reports.css' %}">
    <link rel="stylesheet" href="{% static 'css/insurance-theme.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    {% include "components/top_nav.html" with user_type="insurance" page_title="Rapports" %}

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_insurance.html" %}

    <div class="main-content">
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div
                style="background: linear-gradient(135deg, #6366f1, #4f46e5); padding: 25px; border-radius: 15px; color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Revenus Mensuels</div>
                <div style="font-size: 28px; font-weight: bold;" id="monthlyRevenue">0 FCFA</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Ce mois</div>
            </div>
            <div
                style="background: linear-gradient(135deg, #10b981, #059669); padding: 25px; border-radius: 15px; color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Demandes Approuvées</div>
                <div style="font-size: 28px; font-weight: bold;" id="approvedClaims">0</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Ce mois</div>
            </div>
            <div
                style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 25px; border-radius: 15px; color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Taux d'Approbation</div>
                <div style="font-size: 28px; font-weight: bold;" id="approvalRate">0%</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Ce mois</div>
            </div>
            <div
                style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 25px; border-radius: 15px; color: white;">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Dépenses Claims</div>
                <div style="font-size: 28px; font-weight: bold;" id="claimsExpense">0 FCFA</div>
                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Ce mois</div>
            </div>
        </div>

        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="content-section">
                <h3 style="margin: 0 0 20px 0;">Demandes par Statut</h3>
                <div id="claimsChart"
                    style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #718096;">Graphique des demandes par statut</p>
                </div>
            </div>
            <div class="content-section">
                <h3 style="margin: 0 0 20px 0;">Évolution Mensuelle</h3>
                <div id="monthlyChart"
                    style="height: 300px; display: flex; align-items: center; justify-content: center; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #718096;">Évolution des inscriptions et demandes</p>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h2 style="margin: 0 0 20px 0;">Rapports Détaillés</h2>
            <div style="display: grid; gap: 15px;">
                <div style="padding: 20px; background: #f9fafb; border-radius: 10px; border-left: 4px solid #6366f1;">
                    <h3 style="margin: 0 0 10px 0; color: #2d3748;">Rapport de Demandes</h3>
                    <p style="margin: 0 0 15px 0; color: #718096; font-size: 14px;">Analyse complète de toutes les
                        demandes traitées</p>
                    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                        <div>
                            <div style="font-size: 12px; color: #718096;">Total Demandes</div>
                            <div style="font-size: 20px; font-weight: bold; color: #2d3748;" id="totalClaims">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096;">Approuvées</div>
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;" id="reportApproved">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096;">Rejetées</div>
                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;" id="rejectedClaims">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096;">En Attente</div>
                            <div style="font-size: 20px; font-weight: bold; color: #f59e0b;" id="reportPending">0</div>
                        </div>
                    </div>
                </div>

                <div style="padding: 20px; background: #f9fafb; border-radius: 10px; border-left: 4px solid #10b981;">
                    <h3 style="margin: 0 0 10px 0; color: #2d3748;">Rapport Financier</h3>
                    <p style="margin: 0 0 15px 0; color: #718096; font-size: 14px;">Analyse des revenus et dépenses</p>
                    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                        <div>
                            <div style="font-size: 12px; color: #718096;">Revenus Totaux</div>
                            <div style="font-size: 20px; font-weight: bold; color: #2d3748;" id="totalRevenue">0 FCFA
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096;">Dépenses Totales</div>
                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;" id="totalExpenses">0 FCFA
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096;">Solde Net</div>
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;" id="netBalance">0 FCFA
                            </div>
                        </div>
                    </div>
                </div>

                <div style="padding: 20px; background: #f9fafb; border-radius: 10px; border-left: 4px solid #8b5cf6;">
                    <h3 style="margin: 0 0 10px 0; color: #2d3748;">Rapport Membres</h3>
                    <p style="margin: 0 0 15px 0; color: #718096; font-size: 14px;">Statistiques des abonnements actifs
                    </p>
                    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                        <div>
                            <div style="font-size: 12px; color: #718096;">Membres Actifs</div>
                            <div style="font-size: 20px; font-weight: bold; color: #2d3748;" id="reportActiveMembers">0
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096;">Nouvelles Inscriptions</div>
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;" id="newMembers">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #718096;">Taux Rétention</div>
                            <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;" id="retentionRate">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const menuIcon = document.getElementById('menuIcon');

        function toggleSidebar() {
            const isOpen = sidebar.classList.contains('active');
            if (isOpen) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                menuIcon.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                menuIcon.classList.add('active');
            }
        }

        menuIcon.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        async function loadReports() {
            try {
                const [claimsRes, membersRes, invoicesRes] = await Promise.all([
                    fetch('/api/v1/insurance/claims/'),
                    fetch('/api/v1/insurance/subscriptions/'),
                    fetch('/api/v1/insurance/invoices/')
                ]);

                const claimsData = await claimsRes.json();
                const membersData = await membersRes.json();
                const invoicesData = await invoicesRes.json();

                const claims = claimsData.results || claimsData;
                const members = membersData.results || membersData;
                const invoices = invoicesData.results || invoicesData;

                calculateMetrics(claims, members, invoices);
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        function calculateMetrics(claims, members, invoices) {
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();

            const claimsThisMonth = claims.filter(c => {
                const date = new Date(c.created_at || c.claim_date);
                return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
            });

            const approvedClaims = claimsThisMonth.filter(c => c.status === 'approved');
            const approvalRate = claimsThisMonth.length > 0 ?
                Math.round((approvedClaims.length / claimsThisMonth.length) * 100) : 0;

            const claimsExpense = claims
                .filter(c => c.status === 'paid')
                .reduce((sum, c) => sum + (c.approved_amount || 0), 0);

            const monthlyRevenue = invoices
                .filter(inv => {
                    if (!inv.paid_date) return false;
                    const date = new Date(inv.paid_date);
                    return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
                })
                .reduce((sum, inv) => sum + (inv.total_amount || 0), 0);

            document.getElementById('monthlyRevenue').textContent = monthlyRevenue.toLocaleString() + ' FCFA';
            document.getElementById('approvedClaims').textContent = approvedClaims.length;
            document.getElementById('approvalRate').textContent = approvalRate + '%';
            document.getElementById('claimsExpense').textContent = claimsExpense.toLocaleString() + ' FCFA';

            document.getElementById('totalClaims').textContent = claims.length;
            document.getElementById('reportApproved').textContent = claims.filter(c => c.status === 'approved').length;
            document.getElementById('rejectedClaims').textContent = claims.filter(c => c.status === 'rejected').length;
            document.getElementById('reportPending').textContent = claims.filter(c => c.status === 'submitted' || c.status === 'under_review').length;

            const totalRevenue = invoices
                .filter(inv => inv.status === 'paid')
                .reduce((sum, inv) => sum + (inv.total_amount || 0), 0);

            const netBalance = totalRevenue - claimsExpense;

            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' FCFA';
            document.getElementById('totalExpenses').textContent = claimsExpense.toLocaleString() + ' FCFA';
            document.getElementById('netBalance').textContent = netBalance.toLocaleString() + ' FCFA';

            const activeMembers = members.filter(m => m.status === 'active');
            const newMembers = members.filter(m => {
                const date = new Date(m.start_date);
                return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
            });
            const retentionRate = members.length > 0 ?
                Math.round((activeMembers.length / members.length) * 100) : 0;

            document.getElementById('reportActiveMembers').textContent = activeMembers.length;
            document.getElementById('newMembers').textContent = newMembers.length;
            document.getElementById('retentionRate').textContent = retentionRate + '%';
        }

        loadReports();
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
