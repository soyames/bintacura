{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services - BINTACURA Hospital</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/hospital-theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/hospital/services.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    {% include "components/top_nav.html" with user_type="hospital" page_title="Services M√©dicaux" %}
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_hospital.html" %}
    
    <main class="main-content">
        <div class="services-stats">
            <div class="services-stat-card">
                <div class="stat-value total">{{ total_services|default:0 }}</div>
                <div class="stat-label">Services Totaux</div>
            </div>
            <div class="services-stat-card">
                <div class="stat-value active">{{ active_services|default:0 }}</div>
                <div class="stat-label">Services Actifs</div>
            </div>
        </div>
        <div class="services-list-container">
            <div class="services-list-header">
                <h2>Liste des Services</h2>
                <button onclick="showAddServiceModal()" class="btn-add-service">
                    ‚ûï Ajouter Service
                </button>
            </div>
            <div class="services-grid">
                {% if services %}
                {% for service in services %}
                <div class="service-item" data-id="{{ service.id }}" data-name="{{ service.name }}"
                    data-category="{{ service.category }}" data-description="{{ service.description }}"
                    data-price="{{ service.price }}" data-currency="{{ service.currency }}"
                    data-duration="{{ service.duration_minutes }}" data-available="{{ service.is_available }}">
                    <div class="service-item-content">
                        <div class="service-item-details">
                            <div class="service-item-header">
                                <div class="service-item-name">{{ service.name }}</div>
                                <div class="service-badge category">{{ service.get_category_display }}</div>
                                {% if not service.is_available %}<div class="service-badge unavailable">Indisponible</div>{% endif %}
                            </div>
                            {% if service.description %}<div class="service-item-description">{{ service.description }}</div>{% endif %}
                            <div class="service-item-info">
                                <div>
                                    <div class="service-info-label">PRIX</div>
                                    <div class="service-info-value">{{ service.price }} {{ service.currency }}</div>
                                </div>
                                {% if service.duration_minutes %}<div>
                                    <div class="service-info-label">DUR√âE</div>
                                    <div class="service-info-value duration">{{ service.duration_minutes }} min</div>
                                </div>{% endif %}
                            </div>
                        </div>
                        <div class="service-item-actions">
                            <button onclick="editService('{{ service.id }}')" class="btn-edit-service">
                                ‚úèÔ∏è Modifier
                            </button>
                            <button onclick="deleteService('{{ service.id }}')" class="btn-delete-service">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üè•</div>
                    <div class="empty-state-title">Aucun service trouv√©</div>
                    <div class="empty-state-description">Commencez par ajouter un service m√©dical</div>
                </div>
                {% endif %}
            </div>
        </div>
    </main>
    
    <!-- Add Service Modal -->
    <div id="addServiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Ajouter Service</h2>
                <button onclick="closeAddServiceModal()" class="modal-close">√ó</button>
            </div>
            <form id="addServiceForm" onsubmit="submitAddService(event)" class="modal-form">
                <div class="form-group">
                    <label>Nom du service *</label>
                    <input type="text" id="add_name" required>
                </div>
                <div class="form-group">
                    <label>Cat√©gorie *</label>
                    <select id="add_category" required>
                        <option value="">-- S√©lectionner --</option>
                        <option value="emergency">Service d'Urgence</option>
                        <option value="surgery">Chirurgie</option>
                        <option value="maternity">Maternit√©</option>
                        <option value="pediatric">P√©diatrie</option>
                        <option value="imaging">Imagerie M√©dicale</option>
                        <option value="laboratory">Laboratoire</option>
                        <option value="diagnostic">Service de Diagnostic</option>
                        <option value="therapy">R√©√©ducation/Th√©rapie</option>
                        <option value="consultation">Consultation Sp√©cialis√©e</option>
                        <option value="hospitalization">Hospitalisation</option>
                        <option value="icu">Soins Intensifs</option>
                        <option value="dental">Service Dentaire</option>
                        <option value="vaccination">Centre de Vaccination</option>
                        <option value="other">Autre Service</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="add_description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Prix *</label>
                    <input type="number" id="add_price" required min="0" step="0.01" placeholder="Prix en {{ default_currency|default:'XOF' }}">
                </div>
                <div class="form-group">
                    <label>Dur√©e (minutes)</label>
                    <input type="number" id="add_duration" min="0">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-submit">Ajouter</button>
                    <button type="button" onclick="closeAddServiceModal()" class="btn-cancel">Annuler</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Service Modal -->
    <div id="editServiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Modifier Service</h2>
                <button onclick="closeEditServiceModal()" class="modal-close">√ó</button>
            </div>
            <form id="editServiceForm" onsubmit="submitEditService(event)" class="modal-form">
                <input type="hidden" id="edit_service_id">
                <div class="form-group">
                    <label>Nom du service *</label>
                    <input type="text" id="edit_name" required>
                </div>
                <div class="form-group">
                    <label>Cat√©gorie *</label>
                    <select id="edit_category" required>
                        <option value="emergency">Service d'Urgence</option>
                        <option value="surgery">Chirurgie</option>
                        <option value="maternity">Maternit√©</option>
                        <option value="pediatric">P√©diatrie</option>
                        <option value="imaging">Imagerie M√©dicale</option>
                        <option value="laboratory">Laboratoire</option>
                        <option value="diagnostic">Service de Diagnostic</option>
                        <option value="therapy">R√©√©ducation/Th√©rapie</option>
                        <option value="consultation">Consultation Sp√©cialis√©e</option>
                        <option value="hospitalization">Hospitalisation</option>
                        <option value="icu">Soins Intensifs</option>
                        <option value="dental">Service Dentaire</option>
                        <option value="vaccination">Centre de Vaccination</option>
                        <option value="other">Autre Service</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit_description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Prix *</label>
                    <input type="number" id="edit_price" required min="0" step="0.01" placeholder="Prix en {{ default_currency|default:'XOF' }}">
                </div>
                <div class="form-group">
                    <label>Dur√©e (minutes)</label>
                    <input type="number" id="edit_duration" min="0">
                </div>
                <div class="form-group">
                    <label class="form-checkbox-group">
                        <input type="checkbox" id="edit_available">
                        <span>Service disponible</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-update">Mettre √† jour</button>
                    <button type="button" onclick="closeEditServiceModal()" class="btn-cancel">Annuler</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const DEFAULT_CURRENCY = '{{ default_currency|default:"XOF" }}';
        
        function showAddServiceModal() {
            document.getElementById('addServiceModal').style.display = 'flex';
            document.getElementById('addServiceForm').reset();
        }
        
        function closeAddServiceModal() {
            document.getElementById('addServiceModal').style.display = 'none';
        }
        
        function closeEditServiceModal() {
            document.getElementById('editServiceModal').style.display = 'none';
        }
        
        async function submitAddService(event) {
            event.preventDefault();
            const data = {
                action: 'create',
                name: document.getElementById('add_name').value,
                category: document.getElementById('add_category').value,
                description: document.getElementById('add_description').value,
                price: document.getElementById('add_price').value,
                currency: DEFAULT_CURRENCY,
                duration_minutes: document.getElementById('add_duration').value || null
            };
            
            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    closeAddServiceModal();
                    location.reload();
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur lors de l\'ajout: ' + error.message);
            }
        }
        
        function editService(id) {
            const card = document.querySelector(`.service-item[data-id="${id}"]`);
            if (!card) return;
            
            document.getElementById('edit_service_id').value = id;
            document.getElementById('edit_name').value = card.dataset.name;
            document.getElementById('edit_category').value = card.dataset.category;
            document.getElementById('edit_description').value = card.dataset.description;
            document.getElementById('edit_price').value = card.dataset.price;
            document.getElementById('edit_duration').value = card.dataset.duration || '';
            document.getElementById('edit_available').checked = card.dataset.available === 'True';
            document.getElementById('editServiceModal').style.display = 'flex';
        }
        
        async function submitEditService(event) {
            event.preventDefault();
            const data = {
                action: 'update',
                service_id: document.getElementById('edit_service_id').value,
                name: document.getElementById('edit_name').value,
                category: document.getElementById('edit_category').value,
                description: document.getElementById('edit_description').value,
                price: document.getElementById('edit_price').value,
                currency: DEFAULT_CURRENCY,
                duration_minutes: document.getElementById('edit_duration').value || null,
                is_available: document.getElementById('edit_available').checked
            };
            
            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    closeEditServiceModal();
                    location.reload();
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur lors de la modification: ' + error.message);
            }
        }
        
        async function deleteService(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir d√©sactiver ce service ?')) return;
            
            const data = {
                action: 'delete',
                service_id: id
            };
            
            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                alert('Erreur lors de la suppression: ' + error.message);
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
