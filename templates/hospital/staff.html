{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion du Personnel - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/hospital_staff.css' %}">
    <link rel="stylesheet" href="{% static 'css/hospital-theme.css' %}">
    {% include "components/translation_script.html" %}
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left">
            <button class="menu-toggle-btn" id="menuIcon">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <button class="nav-back-btn" onclick="window.location.href='/hospital/dashboard/'">‚Üê</button>
        </div>
        <div class="nav-center">
            <img src="{% static 'img/logo.png' %}" alt="BINTACURA" class="nav-logo-img">
            <span class="nav-page-title">Gestion du Personnel</span>
        </div>
        <div class="nav-right">
            <div class="nav-user-avatar" onclick="window.location.href='/hospital/profile/'">
                {% include "components/user_avatar.html" with user=request.user %}
            </div>
        </div>
    </nav>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_hospital.html" %}

    <div class="main-content">
        <div class="staff-container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <span class="stat-label">Total Personnel</span>
                        <span class="stat-value" id="totalStaff">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë®‚Äç‚öïÔ∏è</div>
                    <div class="stat-info">
                        <span class="stat-label">M√©decins</span>
                        <span class="stat-value" id="doctorsCount">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë©‚Äç‚öïÔ∏è</div>
                    <div class="stat-info">
                        <span class="stat-label">Infirmiers</span>
                        <span class="stat-value" id="nursesCount">0</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <span class="stat-label">Actifs</span>
                        <span class="stat-value" id="activeStaff">0</span>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Rechercher par nom ou email..." class="search-input">
                </div>
                <div class="filters">
                    <select id="roleFilter" class="filter-select" onchange="filterStaff()">
                        <option value="">Tous les r√¥les</option>
                        <option value="administrator">Administrateur</option>
                        <option value="doctor">M√©decin</option>
                        <option value="nurse">Infirmier(√®re)</option>
                        <option value="surgeon">Chirurgien</option>
                        <option value="anesthesiologist">Anesth√©siste</option>
                        <option value="radiologist">Radiologue</option>
                        <option value="lab_technician">Technicien labo</option>
                        <option value="pharmacist">Pharmacien</option>
                        <option value="receptionist">R√©ceptionniste</option>
                    </select>
                    <select id="departmentFilter" class="filter-select" onchange="filterStaff()">
                        <option value="">Tous les d√©partements</option>
                    </select>
                    <select id="statusFilter" class="filter-select" onchange="filterStaff()">
                        <option value="">Tous les statuts</option>
                        <option value="active">Actif</option>
                        <option value="inactive">Inactif</option>
                    </select>
                </div>
            </div>

            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>Chargement du personnel...</p>
            </div>

            <div id="staffTable" class="staff-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>T√©l√©phone</th>
                            <th>R√¥le</th>
                            <th>D√©partement</th>
                            <th>Type</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffTableBody">
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">üë®‚Äç‚öïÔ∏è</div>
                <h3>Aucun membre du personnel</h3>
                <p>Commencez par ajouter des membres √† votre √©quipe hospitali√®re</p>
                <button class="btn-primary" onclick="openStaffModal()">
                    ‚ûï Ajouter un membre
                </button>
            </div>
        </div>
    </div>

    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ajouter un membre</h2>
                <button class="close-btn" onclick="closeStaffModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    {% csrf_token %}
                    <input type="hidden" id="staffId" name="staff_id">

                    <div class="form-group">
                        <label for="fullName">Nom complet *</label>
                        <input type="text" id="fullName" name="full_name" required placeholder="Ex: Dr. Jean Dupont">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required placeholder="jean.dupont@example.com">
                        </div>
                        <div class="form-group">
                            <label for="phone_number">T√©l√©phone *</label>
                            <input type="tel" id="phone_number" name="phone_number" required placeholder="Ex: +229 97000000">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="role">R√¥le *</label>
                            <select id="role" name="role" required onchange="updatePermissions()">
                                <option value="">S√©lectionner un r√¥le</option>
                                <option value="administrator">Administrateur</option>
                                <option value="doctor">M√©decin</option>
                                <option value="nurse">Infirmier(√®re)</option>
                                <option value="surgeon">Chirurgien</option>
                                <option value="anesthesiologist">Anesth√©siste</option>
                                <option value="radiologist">Radiologue</option>
                                <option value="lab_technician">Technicien de laboratoire</option>
                                <option value="pharmacist">Pharmacien</option>
                                <option value="receptionist">R√©ceptionniste</option>
                                <option value="janitor">Agent d'entretien</option>
                                <option value="security">S√©curit√©</option>
                                <option value="it_staff">Personnel IT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="department">D√©partement</label>
                            <select id="department" name="department">
                                <option value="">Aucun d√©partement</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="employmentType">Type d'emploi *</label>
                            <select id="employmentType" name="employment_type" required>
                                <option value="full_time">Temps plein</option>
                                <option value="part_time">Temps partiel</option>
                                <option value="contract">Contractuel</option>
                                <option value="intern">Stagiaire</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hireDate">Date d'embauche *</label>
                            <input type="date" id="hireDate" name="hire_date" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="licenseNumber">Num√©ro de licence</label>
                            <input type="text" id="licenseNumber" name="license_number" placeholder="Ex: MED-12345">
                        </div>
                        <div class="form-group">
                            <label for="specialization">Sp√©cialisation</label>
                            <input type="text" id="specialization" name="specialization" placeholder="Ex: Cardiologie">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="shiftSchedule">Horaire de travail</label>
                        <input type="text" id="shiftSchedule" name="shift_schedule" placeholder="Ex: 8h-16h">
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isActive" name="is_active" checked>
                            Actif
                        </label>
                    </div>

                    <div class="permissions-section">
                        <h3>Permissions</h3>
                        <div class="permissions-grid">
                            <label class="permission-label">
                                <input type="checkbox" id="canAdmitPatients" name="can_admit_patients">
                                <span>Admettre des patients</span>
                            </label>
                            <label class="permission-label">
                                <input type="checkbox" id="canDischargePatients" name="can_discharge_patients">
                                <span>Sortir des patients</span>
                            </label>
                            <label class="permission-label">
                                <input type="checkbox" id="canPrescribe" name="can_prescribe">
                                <span>Prescrire des m√©dicaments</span>
                            </label>
                            <label class="permission-label">
                                <input type="checkbox" id="canPerformSurgery" name="can_perform_surgery">
                                <span>Effectuer des chirurgies</span>
                            </label>
                            <label class="permission-label">
                                <input type="checkbox" id="canManageEquipment" name="can_manage_equipment">
                                <span>G√©rer l'√©quipement</span>
                            </label>
                            <label class="permission-label">
                                <input type="checkbox" id="canManageStaff" name="can_manage_staff">
                                <span>G√©rer le personnel</span>
                            </label>
                            <label class="permission-label">
                                <input type="checkbox" id="canViewAllRecords" name="can_view_all_records">
                                <span>Voir tous les dossiers</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeStaffModal()">Annuler</button>
                <button class="btn-primary" onclick="saveStaff()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <script src="{% static 'js/dashboard.js' %}"></script>
    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let staffData = [];
        let departmentsData = [];

        document.getElementById('hireDate').valueAsDate = new Date();

        loadDepartments();
        loadStaff();

        async function loadDepartments() {
            try {
                const response = await fetch('/api/v1/hospital/departments/', {
                    headers: {'X-CSRFToken': csrfToken}
                });
                const data = await response.json();
                departmentsData = data;

                const selects = [document.getElementById('department'), document.getElementById('departmentFilter')];
                selects.forEach(select => {
                    data.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = dept.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        async function loadStaff() {
            const loading = document.getElementById('loadingState');
            const table = document.getElementById('staffTable');
            const empty = document.getElementById('emptyState');

            loading.style.display = 'block';
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                const response = await fetch('/api/v1/hospital/staff/', {
                    headers: {'X-CSRFToken': csrfToken}
                });
                const data = await response.json();

                staffData = data;
                updateStats(data);

                loading.style.display = 'none';

                if (data.length > 0) {
                    renderStaffTable(data);
                    table.style.display = 'block';
                } else {
                    empty.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading staff:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
            }
        }

        function updateStats(data) {
            document.getElementById('totalStaff').textContent = data.length;
            document.getElementById('activeStaff').textContent = data.filter(s => s.is_active).length;
            document.getElementById('doctorsCount').textContent = data.filter(s => s.role === 'doctor').length;
            document.getElementById('nursesCount').textContent = data.filter(s => s.role === 'nurse').length;
        }

        const roleLabels = {
            'administrator': 'Administrateur', 'doctor': 'M√©decin', 'nurse': 'Infirmier(√®re)',
            'surgeon': 'Chirurgien', 'anesthesiologist': 'Anesth√©siste', 'radiologist': 'Radiologue',
            'lab_technician': 'Technicien labo', 'pharmacist': 'Pharmacien', 'receptionist': 'R√©ceptionniste',
            'janitor': 'Agent d\'entretien', 'security': 'S√©curit√©', 'it_staff': 'Personnel IT'
        };

        const employmentTypeLabels = {
            'full_time': 'Temps plein', 'part_time': 'Temps partiel',
            'contract': 'Contractuel', 'intern': 'Stagiaire'
        };

        function renderStaffTable(staff) {
            const tbody = document.getElementById('staffTableBody');

            tbody.innerHTML = staff.map(member => `
                <tr>
                    <td>${escapeHtml(member.full_name)}</td>
                    <td>${escapeHtml(member.email)}</td>
                    <td>${escapeHtml(member.phone_number)}</td>
                    <td><span class="role-badge role-${member.role}">${roleLabels[member.role] || member.role}</span></td>
                    <td>${escapeHtml(member.department_name || 'Aucun')}</td>
                    <td>${employmentTypeLabels[member.employment_type] || member.employment_type}</td>
                    <td>
                        <span class="status-badge ${member.is_active ? 'status-active' : 'status-inactive'}">
                            ${member.is_active ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td class="actions-cell">
                        <button class="btn-icon" onclick='editStaff(${JSON.stringify(member)})' title="Modifier">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="toggleStaffStatus('${member.id}', ${!member.is_active})" title="${member.is_active ? 'D√©sactiver' : 'Activer'}">${member.is_active ? 'üö´' : '‚úÖ'}</button>
                    </td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        function openStaffModal() {
            document.getElementById('modalTitle').textContent = 'Ajouter un membre';
            document.getElementById('staffForm').reset();
            document.getElementById('staffId').value = '';
            document.getElementById('hireDate').valueAsDate = new Date();
            document.getElementById('isActive').checked = true;
            document.getElementById('staffModal').classList.add('active');
        }

        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('active');
            document.getElementById('staffForm').reset();
        }

        function editStaff(member) {
            document.getElementById('modalTitle').textContent = 'Modifier un membre';
            document.getElementById('staffId').value = member.id;
            document.getElementById('fullName').value = member.full_name;
            document.getElementById('email').value = member.email;
            document.getElementById('phone_number').value = member.phone_number;
            document.getElementById('role').value = member.role;
            document.getElementById('department').value = member.department || '';
            document.getElementById('employmentType').value = member.employment_type;
            document.getElementById('hireDate').value = member.hire_date;
            document.getElementById('licenseNumber').value = member.license_number || '';
            document.getElementById('specialization').value = member.specialization || '';
            document.getElementById('shiftSchedule').value = member.shift_schedule || '';
            document.getElementById('isActive').checked = member.is_active;
            document.getElementById('canAdmitPatients').checked = member.can_admit_patients;
            document.getElementById('canDischargePatients').checked = member.can_discharge_patients;
            document.getElementById('canPrescribe').checked = member.can_prescribe;
            document.getElementById('canPerformSurgery').checked = member.can_perform_surgery;
            document.getElementById('canManageEquipment').checked = member.can_manage_equipment;
            document.getElementById('canManageStaff').checked = member.can_manage_staff;
            document.getElementById('canViewAllRecords').checked = member.can_view_all_records;

            document.getElementById('staffModal').classList.add('active');
        }

        function updatePermissions() {
            const role = document.getElementById('role').value;
            const permissions = {
                'administrator': {can_admit_patients: true, can_discharge_patients: true, can_prescribe: false, can_perform_surgery: false, can_manage_equipment: true, can_manage_staff: true, can_view_all_records: true},
                'doctor': {can_admit_patients: true, can_discharge_patients: true, can_prescribe: true, can_perform_surgery: false, can_manage_equipment: false, can_manage_staff: false, can_view_all_records: true},
                'surgeon': {can_admit_patients: true, can_discharge_patients: true, can_prescribe: true, can_perform_surgery: true, can_manage_equipment: false, can_manage_staff: false, can_view_all_records: true},
                'nurse': {can_admit_patients: false, can_discharge_patients: false, can_prescribe: false, can_perform_surgery: false, can_manage_equipment: false, can_manage_staff: false, can_view_all_records: false}
            };

            if (permissions[role]) {
                Object.entries(permissions[role]).forEach(([key, value]) => {
                    const field = key.replace(/_([a-z])/g, (m, p1) => p1.toUpperCase());
                    const capitalizedField = field.charAt(0).toUpperCase() + field.slice(1);
                    const checkbox = document.getElementById(capitalizedField);
                    if (checkbox) checkbox.checked = value;
                });
            }
        }

        async function saveStaff() {
            const form = document.getElementById('staffForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const staffId = document.getElementById('staffId').value;
            const formData = new FormData(form);
            const data = {
                full_name: formData.get('full_name'),
                email: formData.get('email'),
                phone_number: formData.get('phone_number'),
                role: formData.get('role'),
                department: formData.get('department') || null,
                employment_type: formData.get('employment_type'),
                hire_date: formData.get('hire_date'),
                license_number: formData.get('license_number'),
                specialization: formData.get('specialization'),
                shift_schedule: formData.get('shift_schedule'),
                is_active: document.getElementById('isActive').checked,
                can_admit_patients: document.getElementById('canAdmitPatients').checked,
                can_discharge_patients: document.getElementById('canDischargePatients').checked,
                can_prescribe: document.getElementById('canPrescribe').checked,
                can_perform_surgery: document.getElementById('canPerformSurgery').checked,
                can_manage_equipment: document.getElementById('canManageEquipment').checked,
                can_manage_staff: document.getElementById('canManageStaff').checked,
                can_view_all_records: document.getElementById('canViewAllRecords').checked
            };

            try {
                const url = staffId ? `/api/v1/hospital/staff/${staffId}/` : '/api/v1/hospital/staff/';
                const method = staffId ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(staffId ? 'Membre modifi√© avec succ√®s!' : 'Membre ajout√© avec succ√®s!');
                    closeStaffModal();
                    loadStaff();
                } else {
                    alert('Erreur: ' + (result.message || JSON.stringify(result)));
                }
            } catch (error) {
                console.error('Error saving staff:', error);
                alert('Une erreur est survenue');
            }
        }

        async function toggleStaffStatus(staffId, newStatus) {
            if (!confirm(newStatus ? 'Activer ce membre?' : 'D√©sactiver ce membre?')) return;

            try {
                const response = await fetch(`/api/v1/hospital/staff/${staffId}/`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({is_active: newStatus})
                });

                if (response.ok) {
                    alert('Statut mis √† jour!');
                    loadStaff();
                } else {
                    alert('Erreur');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Une erreur est survenue');
            }
        }

        function filterStaff() {
            const roleFilter = document.getElementById('roleFilter').value;
            const deptFilter = document.getElementById('departmentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = staffData;

            if (roleFilter) filtered = filtered.filter(s => s.role === roleFilter);
            if (deptFilter) filtered = filtered.filter(s => s.department === deptFilter);
            if (statusFilter) filtered = filtered.filter(s => s.is_active === (statusFilter === 'active'));
            if (searchTerm) filtered = filtered.filter(s => s.full_name.toLowerCase().includes(searchTerm) || s.email.toLowerCase().includes(searchTerm));

            renderStaffTable(filtered);
        }

        document.getElementById('searchInput').addEventListener('input', filterStaff);
    </script>
</body>
</html>

