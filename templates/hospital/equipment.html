{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âquipements - BINTACURA Hospital</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/hospital-theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/hospital_equipement.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    {% include "components/top_nav.html" with user_type="hospital" page_title="√âquipements" return_url="/hospital/dashboard/" %}

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_hospital.html" %}

    <main class="main-content">

        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterEquipment('all')">Tous les √âquipements</button>
            <button class="filter-tab" onclick="filterEquipment('available')">Disponibles</button>
            <button class="filter-tab" onclick="filterEquipment('in_use')">En Utilisation</button>
            <button class="filter-tab" onclick="filterEquipment('maintenance')">Maintenance</button>
            <button class="filter-tab" onclick="filterEquipment('out_of_order')">Hors Service</button>
        </div>

        <div class="action-bar">
            <input type="text" class="search-bar" id="searchEquipment"
                placeholder="Rechercher par nom, ID ou emplacement..." onkeyup="searchEquipment()">
            <button onclick="showAddEquipmentModal()">‚ûï Ajouter √âquipement</button>
            <button onclick="generateReport()">üìä G√©n√©rer Rapport</button>
        </div>

        <div class="equipment-grid" id="equipmentGrid">
            {% if equipment_list %}
            {% for equipment in equipment_list %}
            <div class="equipment-card" data-status="{{ equipment.status }}" data-id="{{ equipment.id }}"
                data-name="{{ equipment.name }}" data-equipment-id="{{ equipment.equipment_id }}"
                data-category="{{ equipment.category }}" data-manufacturer="{{ equipment.manufacturer }}"
                data-model="{{ equipment.model_number }}" data-location="{{ equipment.location }}"
                data-department="{{ equipment.department }}" data-notes="{{ equipment.notes }}"
                data-problem="{{ equipment.problem_description }}">
                <div class="equipment-header">
                    <div>
                        <h3>{{ equipment.name }}</h3>
                        <div class="equipment-id">ID: {{ equipment.equipment_id }}</div>
                    </div>
                    {% if equipment.status == 'available' %}
                    <span
                        style="padding: 6px 12px; background: #28a74515; color: #28a745; border-radius: 6px; font-size: 13px; font-weight: 600;">Disponible</span>
                    {% elif equipment.status == 'in_use' %}
                    <span
                        style="padding: 6px 12px; background: #17a2b815; color: #17a2b8; border-radius: 6px; font-size: 13px; font-weight: 600;">En
                        Utilisation</span>
                    {% elif equipment.status == 'maintenance' %}
                    <span
                        style="padding: 6px 12px; background: #ffc10715; color: #ffc107; border-radius: 6px; font-size: 13px; font-weight: 600;">Maintenance</span>
                    {% elif equipment.status == 'out_of_order' %}
                    <span
                        style="padding: 6px 12px; background: #dc354515; color: #dc3545; border-radius: 6px; font-size: 13px; font-weight: 600;">Hors
                        Service</span>
                    {% endif %}
                </div>
                <div style="color: #718096; margin-bottom: 15px;">
                    <div style="margin-bottom: 8px;">
                        üìç Emplacement: {{ equipment.location|default:"Non sp√©cifi√©" }}
                        {% if equipment.department %} - {{ equipment.department }}{% endif %}
                    </div>
                    {% if equipment.status == 'in_use' and equipment.assigned_to_patient %}
                    <div style="margin-bottom: 8px;">üë§ Patient: {{ equipment.assigned_to_patient.get_full_name }}</div>
                    <div style="margin-bottom: 8px;">‚è∞ Utilis√© depuis: {{ equipment.assigned_date|date:"d M Y" }}</div>
                    {% elif equipment.last_maintenance_date %}
                    <div style="margin-bottom: 8px;">üóìÔ∏è Dernier entretien: {{ equipment.last_maintenance_date|date:"d M
                        Y" }}</div>
                    {% if equipment.next_maintenance_date %}
                    <div style="margin-bottom: 8px;">‚è∞ Prochain entretien: {{ equipment.next_maintenance_date|date:"d M
                        Y" }}</div>
                    {% endif %}
                    {% endif %}
                    {% if equipment.problem_description %}
                    <div style="margin-bottom: 8px;">üîß Probl√®me: {{ equipment.problem_description }}</div>
                    {% endif %}
                </div>
                <div class="equipment-actions" style="display: flex; gap: 10px;">
                    <button class="btn-view" onclick="viewEquipment('{{ equipment.id }}')">üëÅÔ∏è D√©tails</button>
                    <button class="btn-edit" onclick="editEquipment('{{ equipment.id }}')">‚úèÔ∏è Modifier</button>
                    <button class="btn-delete" onclick="deleteEquipment('{{ equipment.id }}')"
                        style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">üóëÔ∏è</button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #718096;">
                <p style="font-size: 18px; margin-bottom: 10px;">Aucun √©quipement enregistr√©</p>
                <p>Cliquez sur "Ajouter √âquipement" pour commencer</p>
            </div>
            {% endif %}
        </div>

        <div id="addEquipmentModal" class="modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h2 style="margin: 0 0 20px 0; color: #dc3545;">‚ûï Ajouter un √âquipement</h2>
                <form id="addEquipmentForm" onsubmit="submitAddEquipment(event)">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nom de l'√©quipement
                            *</label>
                        <input type="text" name="name" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cat√©gorie *</label>
                        <select name="category" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="diagnostic">Diagnostic</option>
                            <option value="surgical">Chirurgical</option>
                            <option value="life_support">Support Vital</option>
                            <option value="monitoring">Surveillance</option>
                            <option value="therapeutic">Th√©rapeutique</option>
                            <option value="laboratory">Laboratoire</option>
                            <option value="vehicle">V√©hicule</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Fabricant</label>
                        <input type="text" name="manufacturer"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Num√©ro de mod√®le</label>
                        <input type="text" name="model_number"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Emplacement</label>
                        <input type="text" name="location"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">D√©partement</label>
                        <input type="text" name="department"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes</label>
                        <textarea name="notes" rows="3"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeAddEquipmentModal()"
                            style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Annuler</button>
                        <button type="submit"
                            style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Ajouter</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editEquipmentModal" class="modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h2 style="margin: 0 0 20px 0; color: #dc3545;">‚úèÔ∏è Modifier l'√âquipement</h2>
                <form id="editEquipmentForm" onsubmit="submitEditEquipment(event)">
                    <input type="hidden" name="equipment_id" id="editEquipmentId">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nom de l'√©quipement
                            *</label>
                        <input type="text" name="name" id="editEquipmentName" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cat√©gorie *</label>
                        <select name="category" id="editEquipmentCategory" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="diagnostic">Diagnostic</option>
                            <option value="surgical">Chirurgical</option>
                            <option value="life_support">Support Vital</option>
                            <option value="monitoring">Surveillance</option>
                            <option value="therapeutic">Th√©rapeutique</option>
                            <option value="laboratory">Laboratoire</option>
                            <option value="vehicle">V√©hicule</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Emplacement</label>
                        <input type="text" name="location" id="editEquipmentLocation"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">D√©partement</label>
                        <input type="text" name="department" id="editEquipmentDepartment"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Statut *</label>
                        <select name="status" id="editEquipmentStatus" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="available">Disponible</option>
                            <option value="in_use">En Utilisation</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="out_of_order">Hors Service</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes</label>
                        <textarea name="notes" id="editEquipmentNotes" rows="3"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditEquipmentModal()"
                            style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Annuler</button>
                        <button type="submit"
                            style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="viewEquipmentModal" class="modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div
                style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <h2 style="margin: 0 0 20px 0; color: #dc3545;">üëÅÔ∏è D√©tails de l'√âquipement</h2>
                <div id="viewEquipmentContent" style="line-height: 1.8;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" onclick="closeViewEquipmentModal()"
                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Fermer</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const menuIcon = document.getElementById('menuIcon');

        function toggleSidebar() {
            const isOpen = sidebar.classList.contains('active');
            if (isOpen) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                menuIcon.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                menuIcon.classList.add('active');
            }
        }

        menuIcon.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        function filterEquipment(status) {
            const cards = document.querySelectorAll('.equipment-card');
            const tabs = document.querySelectorAll('.filter-tab');

            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            cards.forEach(card => {
                if (status === 'all' || card.dataset.status === status) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function searchEquipment() {
            const searchValue = document.getElementById('searchEquipment').value.toLowerCase();
            const cards = document.querySelectorAll('.equipment-card');

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchValue)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function showAddEquipmentModal() {
            document.getElementById('addEquipmentModal').style.display = 'flex';
        }

        function closeAddEquipmentModal() {
            document.getElementById('addEquipmentModal').style.display = 'none';
            document.getElementById('addEquipmentForm').reset();
        }

        function submitAddEquipment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                action: 'create',
                name: formData.get('name'),
                category: formData.get('category'),
                manufacturer: formData.get('manufacturer') || '',
                model_number: formData.get('model_number') || '',
                location: formData.get('location') || '',
                department: formData.get('department') || '',
                notes: formData.get('notes') || '',
                status: 'available'
            };

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('√âquipement ajout√© avec succ√®s!');
                        location.reload();
                    } else {
                        alert('Erreur: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de l\'ajout de l\'√©quipement');
                });
        }

        function generateReport() {
            const cards = document.querySelectorAll('.equipment-card');
            if (cards.length === 0) {
                alert('Aucun √©quipement √† exporter');
                return;
            }

            const statusLabels = {
                'available': 'Disponible',
                'in_use': 'En Utilisation',
                'maintenance': 'Maintenance',
                'out_of_order': 'Hors Service'
            };

            const categoryLabels = {
                'diagnostic': 'Diagnostic',
                'surgical': 'Chirurgical',
                'life_support': 'Support Vital',
                'monitoring': 'Surveillance',
                'therapeutic': 'Th√©rapeutique',
                'laboratory': 'Laboratoire',
                'vehicle': 'V√©hicule',
                'other': 'Autre'
            };

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID √âquipement,Nom,Cat√©gorie,Statut,Fabricant,Mod√®le,Emplacement,D√©partement,Notes\n";

            cards.forEach(card => {
                const row = [
                    card.dataset.equipmentId || '',
                    card.dataset.name || '',
                    categoryLabels[card.dataset.category] || '',
                    statusLabels[card.dataset.status] || '',
                    card.dataset.manufacturer || '',
                    card.dataset.model || '',
                    card.dataset.location || '',
                    card.dataset.department || '',
                    (card.dataset.notes || '').replace(/,/g, ';')
                ].map(field => `"${field}"`).join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `rapport_equipements_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function viewEquipment(id) {
            const card = document.querySelector(`.equipment-card[data-id="${id}"]`);
            if (!card) return;

            const statusLabels = {
                'available': 'Disponible',
                'in_use': 'En Utilisation',
                'maintenance': 'Maintenance',
                'out_of_order': 'Hors Service'
            };

            const categoryLabels = {
                'diagnostic': 'Diagnostic',
                'surgical': 'Chirurgical',
                'life_support': 'Support Vital',
                'monitoring': 'Surveillance',
                'therapeutic': 'Th√©rapeutique',
                'laboratory': 'Laboratoire',
                'vehicle': 'V√©hicule',
                'other': 'Autre'
            };

            const content = `
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">ID √âquipement:</strong> ${card.dataset.equipmentId || 'N/A'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Nom:</strong> ${card.dataset.name || 'N/A'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Cat√©gorie:</strong> ${categoryLabels[card.dataset.category] || 'N/A'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Statut:</strong> ${statusLabels[card.dataset.status] || 'N/A'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Fabricant:</strong> ${card.dataset.manufacturer || 'Non sp√©cifi√©'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Mod√®le:</strong> ${card.dataset.model || 'Non sp√©cifi√©'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Emplacement:</strong> ${card.dataset.location || 'Non sp√©cifi√©'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">D√©partement:</strong> ${card.dataset.department || 'Non sp√©cifi√©'}
                </div>
                ${card.dataset.notes ? `<div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Notes:</strong> ${card.dataset.notes}
                </div>` : ''}
                ${card.dataset.problem ? `<div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">Probl√®me:</strong> ${card.dataset.problem}
                </div>` : ''}
            `;

            document.getElementById('viewEquipmentContent').innerHTML = content;
            document.getElementById('viewEquipmentModal').style.display = 'flex';
        }

        function closeViewEquipmentModal() {
            document.getElementById('viewEquipmentModal').style.display = 'none';
        }

        function editEquipment(id) {
            const card = document.querySelector(`.equipment-card[data-id="${id}"]`);
            if (!card) return;

            document.getElementById('editEquipmentId').value = id;
            document.getElementById('editEquipmentName').value = card.dataset.name || '';
            document.getElementById('editEquipmentCategory').value = card.dataset.category || 'other';
            document.getElementById('editEquipmentLocation').value = card.dataset.location || '';
            document.getElementById('editEquipmentDepartment').value = card.dataset.department || '';
            document.getElementById('editEquipmentStatus').value = card.dataset.status || 'available';
            document.getElementById('editEquipmentNotes').value = card.dataset.notes || '';

            document.getElementById('editEquipmentModal').style.display = 'flex';
        }

        function closeEditEquipmentModal() {
            document.getElementById('editEquipmentModal').style.display = 'none';
            document.getElementById('editEquipmentForm').reset();
        }

        function submitEditEquipment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                action: 'update',
                equipment_id: formData.get('equipment_id'),
                name: formData.get('name'),
                category: formData.get('category'),
                location: formData.get('location') || '',
                department: formData.get('department') || '',
                status: formData.get('status'),
                notes: formData.get('notes') || ''
            };

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('√âquipement mis √† jour avec succ√®s!');
                        location.reload();
                    } else {
                        alert('Erreur: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de la mise √† jour');
                });
        }

        function deleteEquipment(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet √©quipement?')) return;

            const data = {
                action: 'delete',
                equipment_id: id
            };

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('√âquipement supprim√© avec succ√®s!');
                        location.reload();
                    } else {
                        alert('Erreur: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de la suppression');
                });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
