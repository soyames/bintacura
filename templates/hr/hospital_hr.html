{% extends "layout/dashboard_base.html" %}
{% load static %}

{% block title %}Ressources Humaines & Paie - BINTACURA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/BINTACURA-common.css' %}">
<link rel="stylesheet" href="{% static 'css/hospital-theme.css' %}">
<style>
:root {
    --primary-color: #1e88e5;
    --success-color: #66bb6a;
    --danger-color: #ef5350;
    --warning-color: #ffca28;
    --info-color: #29b6f6;
}

.page-content {
    padding: 20px;
    min-height: calc(100vh - 60px);
}

.page-header {
    background: white;
    padding: 30px 40px;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.page-header h1 {
    font-size: 28px;
    color: #2d3748;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.page-header p {
    color: #718096;
    font-size: 16px;
}

.info-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.info-banner h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.info-banner p {
    margin: 0;
    opacity: 0.95;
    line-height: 1.6;
}

.info-banner a {
    color: white;
    text-decoration: underline;
    font-weight: 600;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s, box-shadow 0.3s;
    cursor: pointer;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
}

.stat-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-icon.blue { background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); }
.stat-icon.green { background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); }
.stat-icon.orange { background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%); }
.stat-icon.purple { background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%); }
.stat-icon.red { background: linear-gradient(135deg, #ef5350 0%, #e53935 100%); }

.stat-label {
    font-size: 14px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: #333;
    margin: 10px 0;
}

.stat-link {
    font-size: 13px;
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 600;
}

.content-section {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.action-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    text-decoration: none;
    color: inherit;
    transition: all 0.3s;
    text-align: center;
    cursor: pointer;
    border: 2px solid transparent;
}

.action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    border-color: var(--primary-color);
}

.action-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.action-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3);
}

.btn-primary:hover {
    background: #1976d2;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #57a35b;
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #e53935;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    margin-top: 20px;
}

.data-table th {
    text-align: left;
    padding: 12px 15px;
    background: #f8f9fa;
    font-weight: 600;
    color: #666;
    font-size: 14px;
    text-transform: uppercase;
    border-bottom: 2px solid #dee2e6;
}

.data-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.data-table tr:hover {
    background: #f8f9fa;
}

.badge {
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-block;
}

.badge-success {
    background: #d4edda;
    color: #155724;
}

.badge-warning {
    background: #fff3cd;
    color: #856404;
}

.badge-info {
    background: #d1ecf1;
    color: #0c5460;
}

.badge-primary {
    background: #cce5ff;
    color: #004085;
}

.badge-danger {
    background: #f8d7da;
    color: #721c24;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.empty-state-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s;
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    padding: 25px 30px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #1565c0 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 22px;
}

.close {
    color: white;
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s;
}

.close:hover {
    transform: scale(1.2);
}

.modal-body {
    padding: 30px;
}

.modal-footer {
    padding: 20px 30px;
    background: #f8f9fa;
    border-radius: 0 0 15px 15px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.3s;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .page-header {
        padding: 20px;
    }

    .page-header h1 {
        font-size: 22px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
}

@media (max-width: 576px) {
    .actions-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block sidebar %}
{% include "layout/_sidebar_hospital.html" %}
{% endblock %}

{% block mobile_header %}
{% include "layout/_mobile_header.html" with role_label="H√îPITAL" %}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üëî Ressources Humaines & Paie</h1>
    <p>Gestion Unifi√©e du Personnel, Paie, Cong√©s et Pointage</p>
</div>

<div class="info-banner">
    <h3>üí° Centre RH Unifi√©</h3>
    <p>Cette page centralise toutes vos fonctions RH. Pour g√©rer vos employ√©s (ajouter, modifier, supprimer du personnel),
    visitez votre <a href="/hospital/staff/">page de gestion du personnel</a>. Ici, vous pouvez traiter la paie,
    g√©rer les cong√©s, et consulter les pointages.</p>
</div>

<div class="stats-grid">
    <div class="stat-card" onclick="window.location.href='/hospital/staff/'">
        <div class="stat-card-header">
            <div class="stat-icon blue">üë•</div>
        </div>
        <div class="stat-label">Employ√©s Actifs</div>
        <div class="stat-value">{{ total_employees|default:0 }}</div>
        <a href="/hospital/staff/" class="stat-link">G√©rer le personnel ‚Üí</a>
    </div>

    <div class="stat-card" onclick="showPayrollPeriods()">
        <div class="stat-card-header">
            <div class="stat-icon green">üìÖ</div>
        </div>
        <div class="stat-label">P√©riode de Paie</div>
        <div class="stat-value" style="font-size: 18px;">
            {% if current_payroll_period %}
            {{ current_payroll_period.period_name|truncatewords:3 }}
            {% else %}
            Aucune
            {% endif %}
        </div>
        <span class="stat-link">Voir toutes les p√©riodes ‚Üí</span>
    </div>

    <div class="stat-card" onclick="showLeaveRequests()">
        <div class="stat-card-header">
            <div class="stat-icon orange">üèñÔ∏è</div>
        </div>
        <div class="stat-label">Demandes en Attente</div>
        <div class="stat-value">{{ pending_leave_requests|default:0 }}</div>
        <span class="stat-link">G√©rer les demandes ‚Üí</span>
    </div>

    <div class="stat-card" onclick="showLeaveTypes()">
        <div class="stat-card-header">
            <div class="stat-icon purple">üìã</div>
        </div>
        <div class="stat-label">Types de Cong√©s</div>
        <div class="stat-value">{{ leave_types.count|default:0 }}</div>
        <span class="stat-link">Voir les types ‚Üí</span>
    </div>
</div>

<!-- AI Insights Section (Phase 8) -->
<div class="content-section" id="ai-insights-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 25px; margin-bottom: 30px; color: white;">
    <h2 class="section-title" style="color: white; display: flex; align-items: center; gap: 10px;">
        ü§ñ AI Insights & Analytics
        <button class="btn btn-secondary" onclick="loadAIInsights()" style="margin-left: auto; font-size: 14px;">üîÑ Refresh</button>
    </h2>
    <div id="ai-insights-container">
        <div style="text-align: center; padding: 20px;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px; opacity: 0.9;">Loading AI insights...</p>
        </div>
    </div>
</div>

<div class="content-section">
    <h2 class="section-title">Gestion de la Paie</h2>
    <div class="actions-grid">
        <div class="action-card" onclick="showPayrollPeriods()">
            <div class="action-icon">üìÖ</div>
            <div class="action-title">P√©riodes de Paie</div>
        </div>
        <div class="action-card" onclick="showPayrollRuns()">
            <div class="action-icon">üíµ</div>
            <div class="action-title">Bulletins de Paie</div>
        </div>
        <div class="action-card" onclick="processPayroll()">
            <div class="action-icon">‚öôÔ∏è</div>
            <div class="action-title">Traiter la Paie</div>
        </div>
    </div>
</div>

<div class="content-section">
    <h2 class="section-title">
        Gestion des Cong√©s
        <button class="btn btn-primary" onclick="openLeaveRequestModal()">+ Nouvelle Demande</button>
    </h2>
    <div class="actions-grid">
        <div class="action-card" onclick="showLeaveRequests()">
            <div class="action-icon">üèñÔ∏è</div>
            <div class="action-title">Demandes de Cong√©</div>
        </div>
        <div class="action-card" onclick="showLeaveBalances()">
            <div class="action-icon">üìä</div>
            <div class="action-title">Soldes de Cong√©s</div>
        </div>
        <div class="action-card" onclick="showLeaveTypes()">
            <div class="action-icon">üìã</div>
            <div class="action-title">Types de Cong√©s</div>
        </div>
    </div>
</div>

<div class="content-section">
    <h2 class="section-title">Pointage & Avantages</h2>
    <div class="actions-grid">
        <div class="action-card" onclick="showAttendance()">
            <div class="action-icon">‚è∞</div>
            <div class="action-title">Pointage</div>
        </div>
        <div class="action-card" onclick="showBenefits()">
            <div class="action-icon">üéÅ</div>
            <div class="action-title">Avantages</div>
        </div>
    </div>
</div>

<!-- Modal for Data Display -->
<div id="dataModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Donn√©es</h2>
            <span class="close" onclick="closeDataModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Dynamic content will be inserted here -->
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDataModal()">Fermer</button>
        </div>
    </div>
</div>

<!-- Modal for Leave Request Creation -->
<div id="leaveRequestModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Nouvelle Demande de Cong√©</h2>
            <span class="close" onclick="closeLeaveRequestModal()">&times;</span>
        </div>
        <form id="leaveRequestForm" onsubmit="submitLeaveRequest(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="leaveType">Type de Cong√© *</label>
                    <select class="form-control" id="leaveType" required>
                        <option value="">S√©lectionner un type</option>
                        {% for leave_type in leave_types %}
                        <option value="{{ leave_type.id }}">{{ leave_type.name }} ({{ leave_type.days_per_year }} jours/an)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Date de D√©but *</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">Date de Fin *</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reason">Raison</label>
                    <textarea class="form-control" id="reason" rows="3" placeholder="Motif de la demande de cong√©..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeLeaveRequestModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">
                    <span id="submitBtnText">Soumettre</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// CSRF Token handling
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Modal Functions
function closeDataModal() {
    document.getElementById('dataModal').style.display = 'none';
}

function openLeaveRequestModal() {
    document.getElementById('leaveRequestModal').style.display = 'block';
}

function closeLeaveRequestModal() {
    document.getElementById('leaveRequestModal').style.display = 'none';
    document.getElementById('leaveRequestForm').reset();
}

function displayDataModal(title, content) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('dataModal').style.display = 'block';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const dataModal = document.getElementById('dataModal');
    const leaveModal = document.getElementById('leaveRequestModal');
    if (event.target === dataModal) {
        closeDataModal();
    }
    if (event.target === leaveModal) {
        closeLeaveRequestModal();
    }
}

// Payroll Functions
async function showPayrollPeriods() {
    try {
        const response = await fetch('/api/v1/hr/payroll-periods/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const content = data.length > 0 ? formatPayrollPeriods(data) : '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><h3>Aucune p√©riode de paie</h3></div>';
            displayDataModal('P√©riodes de Paie', content);
        } else {
            alert('Erreur lors du chargement des p√©riodes de paie');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

function formatPayrollPeriods(periods) {
    let html = '<table class="data-table"><thead><tr><th>P√©riode</th><th>D√©but</th><th>Fin</th><th>Statut</th><th>Actions</th></tr></thead><tbody>';
    periods.forEach(period => {
        const status = period.is_processed ? '<span class="badge badge-success">Trait√©</span>' : '<span class="badge badge-warning">En attente</span>';
        const action = !period.is_processed ?
            `<button class="btn btn-primary btn-sm" onclick="processSinglePayroll(${period.id})">Traiter</button>` :
            '<span class="badge badge-info">Termin√©</span>';
        html += `<tr>
            <td>${period.period_name}</td>
            <td>${new Date(period.start_date).toLocaleDateString('fr-FR')}</td>
            <td>${new Date(period.end_date).toLocaleDateString('fr-FR')}</td>
            <td>${status}</td>
            <td>${action}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

async function showPayrollRuns() {
    try {
        const response = await fetch('/api/v1/hr/payroll-runs/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const content = data.length > 0 ? formatPayrollRuns(data) : '<div class="empty-state"><div class="empty-state-icon">üíµ</div><h3>Aucun bulletin de paie</h3></div>';
            displayDataModal('Bulletins de Paie', content);
        } else {
            alert('Erreur lors du chargement des bulletins');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

function formatPayrollRuns(runs) {
    let html = '<table class="data-table"><thead><tr><th>Employ√©</th><th>P√©riode</th><th>Salaire Brut</th><th>Salaire Net</th><th>Statut</th></tr></thead><tbody>';
    runs.forEach(run => {
        const statusBadge = run.status === 'approved' ? 'badge-success' :
                           run.status === 'pending' ? 'badge-warning' : 'badge-info';
        html += `<tr>
            <td>${run.employee_name || 'N/A'}</td>
            <td>${run.period_name || 'N/A'}</td>
            <td>${run.gross_pay ? run.gross_pay.toLocaleString('fr-FR') + ' FCFA' : 'N/A'}</td>
            <td>${run.net_pay ? run.net_pay.toLocaleString('fr-FR') + ' FCFA' : 'N/A'}</td>
            <td><span class="badge ${statusBadge}">${run.status}</span></td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

async function processPayroll() {
    if (!confirm('Voulez-vous traiter la paie pour la p√©riode en cours?')) {
        return;
    }

    try {
        // Get current period first
        const periodsResponse = await fetch('/api/v1/hr/payroll-periods/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (!periodsResponse.ok) {
            alert('Impossible de charger les p√©riodes de paie');
            return;
        }

        const periods = await periodsResponse.json();
        const currentPeriod = periods.find(p => !p.is_processed);

        if (!currentPeriod) {
            alert('Aucune p√©riode de paie en attente de traitement');
            return;
        }

        processSinglePayroll(currentPeriod.id);
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

async function processSinglePayroll(periodId) {
    try {
        const response = await fetch(`/api/v1/hr/payroll-periods/${periodId}/process/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        });

        if (response.ok) {
            alert('Paie trait√©e avec succ√®s!');
            closeDataModal();
            location.reload();
        } else {
            const error = await response.json();
            alert('Erreur: ' + (error.error || error.detail || 'Impossible de traiter la paie'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

// Leave Management Functions
async function showLeaveRequests() {
    try {
        const response = await fetch('/api/v1/hr/leave-requests/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const content = data.length > 0 ? formatLeaveRequests(data) : '<div class="empty-state"><div class="empty-state-icon">üèñÔ∏è</div><h3>Aucune demande de cong√©</h3></div>';
            displayDataModal('Demandes de Cong√©', content);
        } else {
            alert('Erreur lors du chargement des demandes');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

function formatLeaveRequests(requests) {
    let html = '<table class="data-table"><thead><tr><th>Employ√©</th><th>Type</th><th>D√©but</th><th>Fin</th><th>Jours</th><th>Statut</th><th>Actions</th></tr></thead><tbody>';
    requests.forEach(request => {
        const statusBadge = request.status === 'approved' ? 'badge-success' :
                           request.status === 'pending' ? 'badge-warning' :
                           request.status === 'rejected' ? 'badge-danger' : 'badge-info';
        const actions = request.status === 'pending' ?
            `<button class="btn btn-success btn-sm" onclick="approveLeaveRequest(${request.id})">Approuver</button>
             <button class="btn btn-danger btn-sm" onclick="rejectLeaveRequest(${request.id})">Rejeter</button>` :
            '<span class="badge badge-info">Trait√©</span>';
        html += `<tr>
            <td>${request.employee_name || 'N/A'}</td>
            <td>${request.leave_type_name || 'N/A'}</td>
            <td>${new Date(request.start_date).toLocaleDateString('fr-FR')}</td>
            <td>${new Date(request.end_date).toLocaleDateString('fr-FR')}</td>
            <td>${request.total_days || 0}</td>
            <td><span class="badge ${statusBadge}">${request.status}</span></td>
            <td>${actions}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

async function submitLeaveRequest(event) {
    event.preventDefault();

    const data = {
        leave_type: document.getElementById('leaveType').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        reason: document.getElementById('reason').value || ''
    };

    const submitBtn = document.getElementById('submitBtnText');
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Envoi...';

    try {
        const response = await fetch('/api/v1/hr/leave-requests/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert('Demande de cong√© cr√©√©e avec succ√®s!');
            closeLeaveRequestModal();
            location.reload();
        } else {
            const error = await response.json();
            alert('Erreur: ' + (error.detail || error.error || 'Impossible de cr√©er la demande'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    } finally {
        submitBtn.textContent = 'Soumettre';
    }
}

async function approveLeaveRequest(id) {
    if (!confirm('Approuver cette demande de cong√©?')) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/hr/leave-requests/${id}/approve/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        });

        if (response.ok) {
            alert('Demande approuv√©e!');
            showLeaveRequests(); // Refresh the list
        } else {
            const error = await response.json();
            alert('Erreur: ' + (error.error || error.detail || 'Impossible d\'approuver'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

async function rejectLeaveRequest(id) {
    const reason = prompt('Raison du rejet:');
    if (!reason) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/hr/leave-requests/${id}/reject/`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ reason })
        });

        if (response.ok) {
            alert('Demande rejet√©e');
            showLeaveRequests(); // Refresh the list
        } else {
            const error = await response.json();
            alert('Erreur: ' + (error.error || error.detail || 'Impossible de rejeter'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

async function showLeaveBalances() {
    try {
        const response = await fetch('/api/v1/hr/leave-balances/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const content = data.length > 0 ? formatLeaveBalances(data) : '<div class="empty-state"><div class="empty-state-icon">üìä</div><h3>Aucun solde de cong√©</h3></div>';
            displayDataModal('Soldes de Cong√©s', content);
        } else {
            alert('Erreur lors du chargement des soldes');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

function formatLeaveBalances(balances) {
    let html = '<table class="data-table"><thead><tr><th>Employ√©</th><th>Type de Cong√©</th><th>Jours Disponibles</th><th>Jours Utilis√©s</th><th>Total</th></tr></thead><tbody>';
    balances.forEach(balance => {
        html += `<tr>
            <td>${balance.employee_name || 'N/A'}</td>
            <td>${balance.leave_type_name || 'N/A'}</td>
            <td><strong>${balance.days_available || 0}</strong></td>
            <td>${balance.days_used || 0}</td>
            <td>${balance.total_days || 0}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

async function showLeaveTypes() {
    try {
        const response = await fetch('/api/v1/hr/leave-types/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const content = data.length > 0 ? formatLeaveTypes(data) : '<div class="empty-state"><div class="empty-state-icon">üìã</div><h3>Aucun type de cong√©</h3></div>';
            displayDataModal('Types de Cong√©s', content);
        } else {
            alert('Erreur lors du chargement des types de cong√©s');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

function formatLeaveTypes(types) {
    let html = '<table class="data-table"><thead><tr><th>Nom</th><th>Description</th><th>Jours/An</th><th>Pay√©</th><th>Statut</th></tr></thead><tbody>';
    types.forEach(type => {
        const paid = type.is_paid ? '<span class="badge badge-success">Oui</span>' : '<span class="badge badge-warning">Non</span>';
        const active = type.is_active ? '<span class="badge badge-success">Actif</span>' : '<span class="badge badge-danger">Inactif</span>';
        html += `<tr>
            <td><strong>${type.name}</strong></td>
            <td>${type.description || '-'}</td>
            <td>${type.days_per_year}</td>
            <td>${paid}</td>
            <td>${active}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

// Attendance Functions
async function showAttendance() {
    try {
        const response = await fetch('/api/v1/hr/attendance/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const content = data.length > 0 ? formatAttendance(data) : '<div class="empty-state"><div class="empty-state-icon">‚è∞</div><h3>Aucun enregistrement de pointage</h3></div>';
            displayDataModal('Pointage', content);
        } else {
            alert('Erreur lors du chargement des pointages');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

function formatAttendance(records) {
    let html = '<table class="data-table"><thead><tr><th>Employ√©</th><th>Date</th><th>Arriv√©e</th><th>D√©part</th><th>Heures</th><th>Statut</th></tr></thead><tbody>';
    records.forEach(record => {
        const statusBadge = record.status === 'present' ? 'badge-success' :
                           record.status === 'absent' ? 'badge-danger' :
                           record.status === 'late' ? 'badge-warning' : 'badge-info';
        html += `<tr>
            <td>${record.employee_name || 'N/A'}</td>
            <td>${new Date(record.date).toLocaleDateString('fr-FR')}</td>
            <td>${record.check_in_time || '-'}</td>
            <td>${record.check_out_time || '-'}</td>
            <td>${record.hours_worked || 0}h</td>
            <td><span class="badge ${statusBadge}">${record.status}</span></td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

// Benefits Functions
async function showBenefits() {
    try {
        const response = await fetch('/api/v1/hr/benefits/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            const content = data.length > 0 ? formatBenefits(data) : '<div class="empty-state"><div class="empty-state-icon">üéÅ</div><h3>Aucun avantage</h3></div>';
            displayDataModal('Avantages Employ√©s', content);
        } else {
            alert('Erreur lors du chargement des avantages');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion au serveur');
    }
}

function formatBenefits(benefits) {
    let html = '<table class="data-table"><thead><tr><th>Employ√©</th><th>Type</th><th>Description</th><th>Valeur</th><th>D√©but</th></tr></thead><tbody>';
    benefits.forEach(benefit => {
        html += `<tr>
            <td>${benefit.employee_name || 'N/A'}</td>
            <td>${benefit.benefit_type || 'N/A'}</td>
            <td>${benefit.description || '-'}</td>
            <td>${benefit.value ? benefit.value.toLocaleString('fr-FR') + ' FCFA' : 'N/A'}</td>
            <td>${new Date(benefit.start_date).toLocaleDateString('fr-FR')}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    return html;
}

// AI Insights Functions (Phase 8)
async function loadAIInsights() {
    const container = document.getElementById('ai-insights-container');
    container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p style="margin-top: 15px; opacity: 0.9;">Loading AI insights...</p></div>';

    try {
        const response = await fetch('/api/v1/hr/employees/ml_churn_prediction/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            displayAIInsights(data);
        } else {
            container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;"><p>‚ö†Ô∏è Unable to load AI insights. Please try again later.</p></div>';
        }
    } catch (error) {
        console.error('AI Insights Error:', error);
        container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;"><p>‚ö†Ô∏è Error loading AI insights.</p></div>';
    }
}

function displayAIInsights(data) {
    const container = document.getElementById('ai-insights-container');
    const predictions = data.predictions;

    if (!predictions || predictions.status === 'insufficient_data') {
        container.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.8;"><p>üìä Insufficient data for AI analysis. Add more employee records.</p></div>';
        return;
    }

    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">';

    // Summary cards
    html += `
        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Employees Analyzed</div>
            <div style="font-size: 32px; font-weight: bold;">${predictions.total_employees || 0}</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">High Risk Count</div>
            <div style="font-size: 32px; font-weight: bold; color: #ffeb3b;">${predictions.high_risk_count || 0}</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Model Accuracy</div>
            <div style="font-size: 32px; font-weight: bold;">${predictions.model_performance?.accuracy ? (predictions.model_performance.accuracy * 100).toFixed(1) + '%' : 'N/A'}</div>
        </div>
    `;
    html += '</div>';

    // At-risk employees list
    if (predictions.at_risk_employees && predictions.at_risk_employees.length > 0) {
        html += '<div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px);">';
        html += '<h3 style="margin: 0 0 15px 0; color: white;">‚ö†Ô∏è Employees at Risk of Churn</h3>';
        html += '<div style="max-height: 300px; overflow-y: auto;">';

        predictions.at_risk_employees.forEach(emp => {
            const riskColor = emp.risk_level === 'critical' ? '#ff5252' :
                            emp.risk_level === 'high' ? '#ff9800' : '#ffeb3b';
            html += `
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${riskColor};">
                    <div style="font-weight: bold; margin-bottom: 5px;">${emp.employee_name || 'Unknown'}</div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        <span style="background: ${riskColor}; color: #000; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 8px;">${emp.risk_level.toUpperCase()}</span>
                        Churn Probability: ${(emp.churn_probability * 100).toFixed(1)}%
                    </div>
                    <div style="font-size: 13px; opacity: 0.8; margin-top: 5px;">${emp.department || 'N/A'} ‚Ä¢ ${emp.employment_type || 'N/A'}</div>
                </div>
            `;
        });

        html += '</div></div>';
    }

    // Recommendations
    if (predictions.recommendations && predictions.recommendations.length > 0) {
        html += '<div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; backdrop-filter: blur(10px); margin-top: 15px;">';
        html += '<h3 style="margin: 0 0 15px 0; color: white;">üí° AI Recommendations</h3>';
        html += '<ul style="margin: 0; padding-left: 20px;">';
        predictions.recommendations.forEach(rec => {
            html += `<li style="margin-bottom: 10px; opacity: 0.95;">${rec}</li>`;
        });
        html += '</ul></div>';
    }

    container.innerHTML = html;
}

// Load AI insights on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAIInsights();
});

// Add small button styling
const style = document.createElement('style');
style.textContent = `
    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        margin: 0 3px;
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}

