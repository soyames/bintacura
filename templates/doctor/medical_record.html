{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossier M√©dical - Docteur BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/doctor.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/medical-record.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    {% include "components/top_nav.html" with user_type="doctor" page_title="Dossier M√©dical" %}

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_doctor.html" %}

    <div class="main-content">
        <div class="form-container">
                <form id="medicalRecordForm">
                    {% csrf_token %}
                    <div class="form-section">
                        <h3>Informations du Patient</h3>
                        {% if patient %}
                        <input type="hidden" id="patientId" value="{{ patient.uid }}">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom du Patient</label>
                                <input type="text" value="{{ patient.full_name }}" readonly class="readonly-input">
                            </div>
                            <div class="form-group">
                                <label>ID Patient</label>
                                <input type="text" value="{{ patient.uid }}" readonly class="readonly-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="text" value="{{ patient.email }}" readonly class="readonly-input">
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="text" value="{{ patient.phone_number|default:'-' }}" readonly class="readonly-input">
                            </div>
                        </div>
                        {% else %}
                        <div class="form-group">
                            <label for="patientSelect">S√©lectionner un Patient *</label>
                            <select id="patientSelect" required onchange="loadPatientRecords(this.value)">
                                <option value="">Choisir un patient...</option>
                            </select>
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-section {% if not patient %}hidden{% endif %}" id="existingRecordsSection">
                        <h3>Dossiers M√©dicaux Existants</h3>
                        <div id="existingRecords">
                            {% if medical_records %}
                            <div class="records-list">
                                {% for record in medical_records %}
                                <div class="record-item" onclick="editRecord('{{ record.id }}')">
                                    <div class="record-header">
                                        <span class="record-type">{{ record.get_type_display }}</span>
                                        <span class="record-date">{{ record.date_of_record|date:"d/m/Y" }}</span>
                                    </div>
                                    <div class="record-title">{{ record.title }}</div>
                                    {% if record.diagnosis %}
                                    <div class="record-diagnosis">Diagnostic: {{ record.diagnosis|truncatewords:10 }}</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="empty-records">Aucun dossier m√©dical existant</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>D√©tails de la Consultation</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recordDate">Date *</label>
                                <input type="date" id="recordDate" required>
                            </div>
                            <div class="form-group">
                                <label for="recordType">Type de Dossier *</label>
                                <select id="recordType" required>
                                    <option value="">S√©lectionner le type...</option>
                                    <option value="visit_summary">R√©sum√© de Visite</option>
                                    <option value="diagnosis">Diagnostic</option>
                                    <option value="prescription">Prescription</option>
                                    <option value="lab_result">R√©sultat de Laboratoire</option>
                                    <option value="imaging">Imagerie</option>
                                    <option value="vaccination">Vaccination</option>
                                    <option value="allergy">Allergie</option>
                                    <option value="surgery">Chirurgie</option>
                                    <option value="referral">R√©f√©rence</option>
                                    <option value="discharge_summary">R√©sum√© de Sortie</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="recordTitle">Titre *</label>
                            <input type="text" id="recordTitle" placeholder="Ex: Consultation de suivi" required>
                        </div>
                        <div class="form-group">
                            <label for="symptoms">Sympt√¥mes</label>
                            <textarea id="symptoms" placeholder="D√©crire les sympt√¥mes du patient..."></textarea>
                        </div>
                    </div>

                    <!-- Patient's Recent Wearable Vitals for Reference -->
                    <div class="form-section {% if not patient %}hidden{% endif %}" id="patientVitalsSection">
                        <h3>üì± Signes Vitaux du Patient (Appareils Connect√©s)</h3>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            Donn√©es r√©centes des appareils portables du patient (derniers 7 jours)
                        </p>
                        <div id="patientWearableVitals">
                            <p style="color: #999; text-align: center; padding: 20px;">
                                Chargement des donn√©es...
                            </p>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Signes Vitaux</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bloodPressure">Tension Art√©rielle</label>
                                <input type="text" id="bloodPressure" placeholder="Ex: 120/80 mmHg">
                            </div>
                            <div class="form-group">
                                <label for="heartRate">Fr√©quence Cardiaque</label>
                                <input type="text" id="heartRate" placeholder="Ex: 72 bpm">
                            </div>
                            <div class="form-group">
                                <label for="temperature">Temp√©rature</label>
                                <input type="text" id="temperature" placeholder="Ex: 37¬∞C">
                            </div>
                            <div class="form-group">
                                <label for="weight">Poids</label>
                                <input type="text" id="weight" placeholder="Ex: 70 kg">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Examen & √âvaluation</h3>
                        <div class="form-group">
                            <label for="diagnosis">Diagnostic *</label>
                            <textarea id="diagnosis" placeholder="Entrer le diagnostic..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="treatment">Traitement</label>
                            <textarea id="treatment" placeholder="Plan de traitement et recommandations..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="medications">M√©dicaments</label>
                            <textarea id="medications" placeholder="Liste des m√©dicaments prescrits..."></textarea>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Notes Additionnelles</h3>
                        <div class="form-group">
                            <label for="notes">Notes Cliniques</label>
                            <textarea id="notes" placeholder="Toute observation clinique suppl√©mentaire..."></textarea>
                        </div>
                    </div>

                    <input type="hidden" id="recordId" value="">

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="window.history.back()">Annuler</button>
                        <button type="submit" class="btn-save">Enregistrer le Dossier</button>
                    </div>
                </form>
            </div>
        </div>

    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        document.getElementById('recordDate').valueAsDate = new Date();

        {% if not patient %}
        async function loadPatients() {
            try {
                console.log('Fetching patients from /api/v1/doctor/patients/...');
                const response = await fetch('/api/v1/doctor/patients/', { credentials: 'same-origin' });
                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    console.error('API request failed:', response.status, response.statusText);
                    const text = await response.text();
                    console.error('Response body:', text);
                    return;
                }

                const data = await response.json();
                console.log('Patients API Response:', data);
                console.log('Data.success:', data.success);
                console.log('Data.patients:', data.patients);
                console.log('Patients length:', data.patients ? data.patients.length : 0);

                if (data.success && data.patients && data.patients.length > 0) {
                    const select = document.getElementById('patientSelect');
                    data.patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.uid;
                        option.textContent = `${patient.full_name} - ${patient.email}`;
                        select.appendChild(option);
                    });
                    console.log(`‚úì Successfully loaded ${data.patients.length} patients`);
                } else {
                    console.warn('‚ö† No patients found. This doctor may not have any appointments yet.');
                    console.warn('API Response:', data);
                }
            } catch (error) {
                console.error('‚ùå Error loading patients:', error);
            }
        }
        loadPatients();
        {% else %}
        // If patient is pre-selected (from URL), load their wearable vitals
        const patientId = document.getElementById('patientId').value;
        if (patientId) {
            loadPatientWearableVitals(patientId);
        }
        {% endif %}

        async function loadPatientRecords(patientId) {
            if (!patientId) {
                document.getElementById('existingRecordsSection').classList.add('hidden');
                document.getElementById('patientVitalsSection').classList.add('hidden');
                return;
            }
            try {
                console.log('Loading records for patient:', patientId);
                const response = await fetch(`/api/v1/health-records/records/?assigned_to=${patientId}`, { credentials: 'same-origin' });
                console.log('Response status:', response.status, response.statusText);

                const data = await response.json();
                console.log('Records data:', data);
                console.log('Data type:', typeof data, 'Is array:', Array.isArray(data));

                const container = document.getElementById('existingRecords');
                const section = document.getElementById('existingRecordsSection');

                section.classList.remove('hidden');

                const records = data.results || data;
                console.log('Records array:', records, 'Length:', records.length);

                if (records.length > 0) {
                    let html = '<div class="records-list">';
                    records.forEach(record => {
                        const createdByBadge = record.created_by_name ? `<span class="created-by-badge">Par: ${record.created_by_name}</span>` : '';
                        const diagnosisPreview = record.diagnosis ? `<div class="record-diagnosis">Diagnostic: ${record.diagnosis.substring(0, 50)}...</div>` : '';
                        html += `<div class="record-item" onclick="editRecord('${record.id}')">
                            <div class="record-header">
                                <span class="record-type">${record.type}</span>
                                <span class="record-date">${new Date(record.date_of_record).toLocaleDateString('fr-FR')}</span>
                            </div>
                            <div class="record-title">${record.title}</div>
                            ${diagnosisPreview}
                            ${createdByBadge}
                        </div>`;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="empty-records">Aucun dossier m√©dical existant</p>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
            
            // Load patient's wearable vitals
            loadPatientWearableVitals(patientId);
        }

        async function loadPatientWearableVitals(patientId) {
            try {
                const vitalsSection = document.getElementById('patientVitalsSection');
                const vitalsContainer = document.getElementById('patientWearableVitals');
                
                vitalsSection.classList.remove('hidden');
                
                // Get latest wearable vitals for the patient
                const response = await fetch(`/api/v1/wearable-devices/data/latest/?patient_id=${patientId}`, { 
                    credentials: 'same-origin' 
                });
                
                if (!response.ok) {
                    vitalsContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Aucun appareil connect√©</p>';
                    return;
                }
                
                const vitalsData = await response.json();
                
                if (!vitalsData || Object.keys(vitalsData).length === 0) {
                    vitalsContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Aucune donn√©e disponible</p>';
                    return;
                }
                
                // Display vitals in a grid
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">';
                
                const vitalLabels = {
                    'heart_rate': '‚ù§Ô∏è Fr√©quence Cardiaque',
                    'steps': 'üëü Pas',
                    'blood_pressure': 'ü©∫ Tension',
                    'blood_oxygen': 'ü´Å Oxyg√®ne',
                    'body_temperature': 'üå°Ô∏è Temp√©rature',
                    'weight': '‚öñÔ∏è Poids',
                    'sleep': 'üò¥ Sommeil',
                    'calories': 'üî• Calories',
                    'distance': 'üìè Distance'
                };
                
                for (const [type, data] of Object.entries(vitalsData)) {
                    const label = vitalLabels[type] || type;
                    const date = new Date(data.timestamp).toLocaleDateString('fr-FR', {
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    html += `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px;">
                            <div style="font-size: 10px; opacity: 0.9; margin-bottom: 4px;">${label}</div>
                            <div style="font-size: 18px; font-weight: 700;">
                                ${data.value} <span style="font-size: 11px; opacity: 0.8;">${data.unit}</span>
                            </div>
                            <div style="font-size: 9px; opacity: 0.7; margin-top: 4px;">${date}</div>
                        </div>
                    `;
                }
                
                html += '</div>';
                vitalsContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading wearable vitals:', error);
                document.getElementById('patientWearableVitals').innerHTML = 
                    '<p style="color: #999; text-align: center; padding: 20px;">Erreur de chargement</p>';
            }
        }

        async function editRecord(recordId) {
            try {
                const response = await fetch(`/api/v1/health-records/records/${recordId}/`, { credentials: 'same-origin' });
                const record = await response.json();

                if (record.can_view_details === false) {
                    // Show professional modal for restricted records
                    const contact = record.created_by_contact;
                    const contactInfo = contact ? `
                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Contact du m√©decin:</strong><br>
                            üìß ${contact.email}<br>
                            üìû ${contact.phone || 'Non disponible'}
                        </div>
                    ` : '';

                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                    modal.innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <span style="font-size: 48px; margin-right: 15px;">üîí</span>
                                <div>
                                    <h3 style="margin: 0; color: #2d3748;">Dossier Restreint</h3>
                                    <p style="margin: 5px 0 0 0; color: #718096;">Cr√©√© par ${record.created_by_name}</p>
                                </div>
                            </div>
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                                <strong>Informations visibles:</strong>
                                <div style="margin-top: 10px;">
                                    üìã Type: ${record.type}<br>
                                    üìù Titre: ${record.title}<br>
                                    üìÖ Date: ${new Date(record.date_of_record).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                            <p style="color: #718096; margin-bottom: 15px;">${record.message}</p>
                            ${contactInfo}
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Compris
                            </button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    return;
                }

                // Can edit - load into form
                document.getElementById('recordId').value = record.id;
                document.getElementById('recordDate').value = record.date_of_record;
                document.getElementById('recordType').value = record.type;
                document.getElementById('recordTitle').value = record.title;
                document.getElementById('symptoms').value = record.symptoms || '';
                document.getElementById('diagnosis').value = record.diagnosis || '';
                document.getElementById('treatment').value = record.treatment || '';
                document.getElementById('medications').value = record.medications || '';
                document.getElementById('notes').value = record.notes || '';
                document.getElementById('medicalRecordForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur lors du chargement du dossier');
            }
        }

        document.getElementById('medicalRecordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const patientId = {% if patient %}'{{ patient.uid }}'{% else %}document.getElementById('patientSelect').value{% endif %};
            if (!patientId) {
                alert('Veuillez s√©lectionner un patient');
                return;
            }
            const vitalSigns = [];
            const bp = document.getElementById('bloodPressure').value;
            const hr = document.getElementById('heartRate').value;
            const temp = document.getElementById('temperature').value;
            const weight = document.getElementById('weight').value;
            
            // Parse vital signs for text display
            if (bp) vitalSigns.push(`Tension: ${bp}`);
            if (hr) vitalSigns.push(`FC: ${hr}`);
            if (temp) vitalSigns.push(`Temp: ${temp}`);
            if (weight) vitalSigns.push(`Poids: ${weight}`);
            const vitalSignsText = vitalSigns.length > 0 ? `Signes Vitaux: ${vitalSigns.join(', ')}\n\n` : '';
            const notes = vitalSignsText + (document.getElementById('notes').value || '');
            
            // Parse vitals for structured storage
            let bloodPressureSystolic = null;
            let bloodPressureDiastolic = null;
            let heartRateValue = null;
            let temperatureValue = null;
            let weightValue = null;
            
            // Parse blood pressure (format: "120/80" or "120/80 mmHg")
            if (bp) {
                const bpMatch = bp.match(/(\d+)\s*\/\s*(\d+)/);
                if (bpMatch) {
                    bloodPressureSystolic = parseInt(bpMatch[1]);
                    bloodPressureDiastolic = parseInt(bpMatch[2]);
                }
            }
            
            // Parse heart rate (format: "72" or "72 bpm")
            if (hr) {
                const hrMatch = hr.match(/(\d+)/);
                if (hrMatch) {
                    heartRateValue = parseInt(hrMatch[1]);
                }
            }
            
            // Parse temperature (format: "37" or "37¬∞C" or "37.5¬∞C")
            if (temp) {
                const tempMatch = temp.match(/(\d+\.?\d*)/);
                if (tempMatch) {
                    temperatureValue = parseFloat(tempMatch[1]);
                }
            }
            
            // Parse weight (format: "70" or "70 kg" or "70.5kg")
            if (weight) {
                const weightMatch = weight.match(/(\d+\.?\d*)/);
                if (weightMatch) {
                    weightValue = parseFloat(weightMatch[1]);
                }
            }
            
            const formData = {
                assigned_to: patientId,
                type: document.getElementById('recordType').value,
                title: document.getElementById('recordTitle').value,
                date_of_record: document.getElementById('recordDate').value,
                symptoms: document.getElementById('symptoms').value,
                diagnosis: document.getElementById('diagnosis').value,
                treatment: document.getElementById('treatment').value,
                medications: document.getElementById('medications').value,
                notes: notes,
                participants: [patientId],
                // Add structured vital signs
                blood_pressure_systolic: bloodPressureSystolic,
                blood_pressure_diastolic: bloodPressureDiastolic,
                heart_rate: heartRateValue,
                temperature: temperatureValue,
                weight: weightValue
            };

            console.log('Submitting medical record:', formData);

            const recordId = document.getElementById('recordId').value;
            const url = recordId ? `/api/v1/health-records/records/${recordId}/` : '/api/v1/health-records/records/';
            const method = recordId ? 'PUT' : 'POST';

            console.log(`Making ${method} request to ${url}`);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status, response.statusText);

                if (response.ok) {
                    const successMessage = recordId ? 'Dossier mis √† jour avec succ√®s!' : 'Dossier m√©dical cr√©√© avec succ√®s!';

                    // Show success message
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600;';
                    notification.textContent = successMessage;
                    document.body.appendChild(notification);

                    // Redirect to queue after 1 second
                    setTimeout(() => {
                        window.location.href = '/doctor/queue/';
                    }, 1000);
                } else {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        console.error('API Error:', error);
                        alert('Erreur lors de l\'enregistrement: ' + JSON.stringify(error));
                    } else {
                        const text = await response.text();
                        console.error('Non-JSON response:', text);
                        alert('Erreur lors de l\'enregistrement: ' + response.status + ' ' + response.statusText);
                    }
                }
            } catch (error) {
                console.error('Fetch error:', error);
                console.error('Error details:', error.message, error.stack);
                alert('Erreur de connexion: ' + error.message);
            }
        });
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
