{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvelle Ordonnance - Docteur BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/doctor.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/new-prescription.css' %}">
    
    {% include "components/translation_script.html" %}
</head>

<body>
    {% include "components/top_nav.html" with user_type="doctor" page_title="Nouvelle Ordonnance" %}

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_doctor.html" %}

    <div class="main-content">
        <div class="form-container">
                <form id="prescriptionForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="patient">S√©lectionner un Patient *</label>
                        <select id="patient" required>
                            <option value="">Choisir un patient...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="diagnosis">Diagnostic *</label>
                        <textarea id="diagnosis" placeholder="Entrer le diagnostic" required></textarea>
                        <small>Le diagnostic le plus r√©cent du patient sera automatiquement charg√©</small>
                    </div>

                    <div class="form-group">
                        <label>M√©dicaments</label>
                        <div class="medication-actions">
                            <button type="button" class="btn-catalog" onclick="openPharmacyCatalogModal()">üì¶ Parcourir le catalogue</button>
                        </div>
                        <div class="medication-list" id="medicationList">
                            <div class="medication-item">
                                <input type="text" placeholder="Nom du m√©dicament" required>
                                <input type="text" placeholder="Dosage" required>
                                <input type="text" placeholder="Fr√©quence" required>
                                <input type="number" placeholder="Dur√©e (jours)" required>
                                <button type="button" class="btn-remove"
                                    onclick="this.parentElement.remove()">√ó</button>
                            </div>
                        </div>
                        <button type="button" class="btn-add-medication" onclick="addMedication()">+ Ajouter un
                            M√©dicament</button>
                    </div>

                    <div class="form-group">
                        <label for="instructions">Instructions Sp√©ciales</label>
                        <textarea id="instructions"
                            placeholder="Entrer les instructions sp√©ciales pour le patient..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes (Priv√©es)</label>
                        <textarea id="notes" placeholder="Notes priv√©es pour vos dossiers..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="window.history.back()">Annuler</button>
                        <button type="submit" class="btn-save">Enregistrer l'Ordonnance</button>
                    </div>
                </form>
            </div>
        </div>

    <!-- Pharmacy Catalog Modal -->
    <div class="modal" id="pharmacyCatalogModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>üì¶ Catalogue de M√©dicaments</h2>
                <button type="button" class="close-modal" onclick="closePharmacyCatalogModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="catalog-search-section">
                    <div class="search-bar">
                        <input type="text" id="catalogSearchInput" placeholder="Rechercher un m√©dicament..." class="search-input">
                        <button type="button" onclick="searchCatalog()">üîç Rechercher</button>
                    </div>
                    <div class="filter-section">
                        <select id="catalogPharmacyFilter" class="filter-select" onchange="filterCatalog()">
                            <option value="">Toutes les pharmacies</option>
                        </select>
                        <select id="catalogCategoryFilter" class="filter-select" onchange="filterCatalog()">
                            <option value="">Toutes les cat√©gories</option>
                        </select>
                    </div>
                </div>

                <div id="catalogLoadingState" class="loading-state">
                    <div class="spinner"></div>
                    <p>Chargement du catalogue...</p>
                </div>

                <div id="catalogGrid" class="catalog-grid" style="display: none;"></div>

                <div id="catalogEmptyState" class="empty-state" style="display: none;">
                    <div class="empty-icon">üíä</div>
                    <h3>Aucun m√©dicament trouv√©</h3>
                    <p>Essayez une autre recherche</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let catalogData = [];

        function addMedication() {
            const medicationList = document.getElementById('medicationList');
            const newMedication = document.createElement('div');
            newMedication.className = 'medication-item';
            newMedication.innerHTML = `
                <input type="text" placeholder="Medication name" required>
                <input type="text" placeholder="Dosage" required>
                <input type="text" placeholder="Frequency" required>
                <input type="number" placeholder="Duration (days)" required>
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            medicationList.appendChild(newMedication);
        }

        document.getElementById('prescriptionForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const patientId = document.getElementById('patient').value;
            if (!patientId) {
                alert('Veuillez s√©lectionner un patient');
                return;
            }

            // Collect medication items
            const medicationItems = [];
            const medItems = document.querySelectorAll('.medication-item');
            medItems.forEach(item => {
                const inputs = item.querySelectorAll('input');
                if (inputs.length >= 4 && inputs[0].value) {
                    medicationItems.push({
                        medication_name: inputs[0].value,
                        dosage: inputs[1].value,
                        frequency: inputs[2].value,
                        duration_days: parseInt(inputs[3].value) || 0
                    });
                }
            });

            if (medicationItems.length === 0) {
                alert('Veuillez ajouter au moins un m√©dicament');
                return;
            }

            // Prepare prescription data
            const today = new Date();
            const validUntil = new Date(today);
            validUntil.setMonth(validUntil.getMonth() + 3); // Valid for 3 months

            const prescriptionData = {
                patient_id: patientId,
                diagnosis: document.getElementById('diagnosis').value,
                special_instructions: document.getElementById('instructions').value,
                notes: document.getElementById('notes').value,
                issue_date: today.toISOString().split('T')[0],
                valid_until: validUntil.toISOString().split('T')[0],
                status: 'active',
                type: 'regular',
                medications: medicationItems
            };

            console.log('Submitting prescription:', prescriptionData);

            try {
                const response = await fetch('/api/v1/prescriptions/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(prescriptionData)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Success:', result);

                    // Show success notification
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600;';
                    notification.innerHTML = '‚úÖ Ordonnance cr√©√©e avec succ√®s!<br><small>Redirection vers le tableau de bord...</small>';
                    document.body.appendChild(notification);

                    // Redirect to dashboard after 1.5 seconds
                    setTimeout(() => {
                        window.location.href = '/doctor/dashboard/';
                    }, 1500);
                } else {
                    const error = await response.json();
                    console.error('Error:', error);
                    alert('Erreur lors de la cr√©ation: ' + (error.detail || error.message || JSON.stringify(error)));
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('Erreur de connexion: ' + error.message);
            }
        });

        // Get patient ID from URL parameter
        function getPatientIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('patient');
        }

        // Pharmacy Catalog Functions
        async function loadPatients() {
            try {
                const response = await fetch('/api/v1/doctor/patients/', { credentials: 'same-origin' });
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('patient');
                    select.innerHTML = '<option value="">Choisir un patient...</option>';
                    data.patients.forEach(patient => {
                        const option = document.createElement('option');
                        option.value = patient.uid;
                        option.textContent = `${patient.full_name} - ${patient.email}`;
                        select.appendChild(option);
                    });

                    // Auto-select patient if passed in URL
                    const preselectedPatientId = getPatientIdFromURL();
                    if (preselectedPatientId) {
                        select.value = preselectedPatientId;
                        // Trigger change event to load diagnosis
                        select.dispatchEvent(new Event('change'));

                        // Visual feedback - highlight the select field briefly
                        select.style.border = '2px solid #28a745';
                        setTimeout(() => {
                            select.style.border = '';
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        async function loadPatientDiagnosis(patientId) {
            try {
                const response = await fetch(`/api/v1/health-records/records/?assigned_to=${patientId}`, { credentials: 'same-origin' });
                const data = await response.json();
                const records = data.results || data;

                if (records.length > 0) {
                    const latestRecord = records.find(r => r.diagnosis && r.diagnosis.trim());
                    if (latestRecord && latestRecord.diagnosis) {
                        document.getElementById('diagnosis').value = latestRecord.diagnosis;
                    }
                }
            } catch (error) {
                console.error('Error loading diagnosis:', error);
            }
        }

        document.getElementById('patient').addEventListener('change', function() {
            const patientId = this.value;
            if (patientId) {
                loadPatientDiagnosis(patientId);
            } else {
                document.getElementById('diagnosis').value = '';
            }
        });

        loadPatients();

        function openPharmacyCatalogModal() {
            document.getElementById('pharmacyCatalogModal').style.display = 'block';
            if (catalogData.length === 0) {
                loadCatalog();
            }
        }

        function closePharmacyCatalogModal() {
            document.getElementById('pharmacyCatalogModal').style.display = 'none';
        }

        async function loadCatalog() {
            const loading = document.getElementById('catalogLoadingState');
            const grid = document.getElementById('catalogGrid');
            const empty = document.getElementById('catalogEmptyState');

            loading.style.display = 'block';
            grid.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Load medications from the medications API
                const response = await fetch('/api/v1/prescriptions/medications/', {
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Failed to load medications');
                }

                const medications = await response.json();
                console.log('Loaded medications:', medications);

                if (medications && medications.length > 0) {
                    catalogData = medications;

                    // Get unique categories
                    const categories = [...new Set(medications.map(m => m.category))].filter(Boolean);

                    const categorySelect = document.getElementById('catalogCategoryFilter');
                    categorySelect.innerHTML = '<option value="">Toutes les cat√©gories</option>';

                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });

                    // Hide pharmacy filter since we're showing all medications
                    const pharmacyFilterContainer = document.getElementById('catalogPharmacyFilter')?.parentElement;
                    if (pharmacyFilterContainer) {
                        pharmacyFilterContainer.style.display = 'none';
                    }

                    renderCatalog(medications);
                    loading.style.display = 'none';
                    grid.style.display = 'grid';
                } else {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading catalog:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                document.getElementById('catalogEmptyState').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                        <h3>Erreur de chargement</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderCatalog(items) {
            const grid = document.getElementById('catalogGrid');

            if (!items || items.length === 0) {
                grid.style.display = 'none';
                document.getElementById('catalogEmptyState').style.display = 'block';
                return;
            }

            grid.innerHTML = items.map(item => {
                // Format dosage forms and strengths
                const dosageForms = Array.isArray(item.dosage_forms) ? item.dosage_forms.join(', ') : (item.dosage_forms || 'N/A');
                const strengths = Array.isArray(item.strengths) ? item.strengths.join(', ') : (item.strengths || 'N/A');

                return `
                    <div class="catalog-card" onclick="selectMedicationFromCatalog('${escapeHtml(item.name)}', '${escapeHtml(dosageForms)}', '${escapeHtml(strengths)}')">
                        <div class="catalog-card-icon">üíä</div>
                        <h3 class="catalog-card-name">${escapeHtml(item.name || 'N/A')}</h3>
                        ${item.brand_name ? `<p class="catalog-card-brand">Marque: ${escapeHtml(item.brand_name)}</p>` : ''}
                        <p class="catalog-card-generic">G√©n√©rique: ${escapeHtml(item.generic_name || 'N/A')}</p>
                        <p class="catalog-card-category">Cat√©gorie: ${escapeHtml(item.category || '')}</p>
                        <div class="catalog-card-info">
                            ${item.manufacturer ? `
                            <div class="catalog-info-row">
                                <span class="catalog-info-label">Fabricant:</span>
                                <span class="catalog-info-value">${escapeHtml(item.manufacturer)}</span>
                            </div>
                            ` : ''}
                            ${item.description ? `<p class="catalog-description">${escapeHtml(item.description)}</p>` : ''}
                            <div class="catalog-info-row">
                                <span class="catalog-info-label">Formes:</span>
                                <span class="catalog-info-value">${escapeHtml(dosageForms)}</span>
                            </div>
                            <div class="catalog-info-row">
                                <span class="catalog-info-label">Dosages:</span>
                                <span class="catalog-info-value">${escapeHtml(strengths)}</span>
                            </div>
                            ${item.requires_prescription ? '<div class="catalog-prescription-badge">‚öïÔ∏è Ordonnance requise</div>' : '<div class="catalog-prescription-badge" style="background: #28a745;">Sans ordonnance</div>'}
                            ${item.side_effects ? `<p class="catalog-side-effects" style="font-size: 0.85rem; color: #666; margin-top: 8px;"><strong>Effets secondaires:</strong> ${escapeHtml(item.side_effects)}</p>` : ''}
                            <button type="button" class="btn-select-med" style="width: 100%; margin-top: 10px; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">S√©lectionner</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectMedicationFromCatalog(medicationName, dosageForms, strengths) {
            const medicationList = document.getElementById('medicationList');
            const newMedication = document.createElement('div');
            newMedication.className = 'medication-item';

            // Get first dosage form and strength as defaults
            const defaultForm = dosageForms.split(',')[0].trim();
            const defaultStrength = strengths.split(',')[0].trim();

            newMedication.innerHTML = `
                <input type="text" placeholder="Nom du m√©dicament" value="${medicationName}" required>
                <input type="text" placeholder="Dosage" value="${defaultStrength}" required>
                <input type="text" placeholder="Fr√©quence" value="once_daily" required>
                <input type="number" placeholder="Dur√©e (jours)" value="7" required>
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            medicationList.appendChild(newMedication);
            closePharmacyCatalogModal();

            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 12px 20px; border-radius: 6px; z-index: 10001; font-size: 14px;';
            notification.textContent = `‚úì ${medicationName} ajout√©`;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 2000);
        }

        function searchCatalog() {
            const query = document.getElementById('catalogSearchInput').value.toLowerCase();
            const filtered = catalogData.filter(item =>
                item.name?.toLowerCase().includes(query) ||
                item.generic_name?.toLowerCase().includes(query) ||
                item.brand_name?.toLowerCase().includes(query) ||
                item.category?.toLowerCase().includes(query)
            );
            renderCatalog(filtered);
        }

        function filterCatalog() {
            const pharmacyId = document.getElementById('catalogPharmacyFilter').value;
            const category = document.getElementById('catalogCategoryFilter').value;

            let filtered = catalogData;

            if (pharmacyId) {
                filtered = filtered.filter(item => item.pharmacy_id === pharmacyId);
            }

            if (category) {
                filtered = filtered.filter(item => item.category === category);
            }

            renderCatalog(filtered);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
        }

        document.getElementById('catalogSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchCatalog();
        });

        window.onclick = function(event) {
            const modal = document.getElementById('pharmacyCatalogModal');
            if (event.target === modal) {
                closePharmacyCatalogModal();
            }
        }
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
