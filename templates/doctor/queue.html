{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File d'attente - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/doctor.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/queue.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    {% include "components/top_nav.html" with user_type="doctor" page_title="File d'attente" %}

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_doctor.html" %}

    <div class="main-content">
        <div class="queue-container">
            <div class="queue-header">
                <h1>üìã File d'attente</h1>
                <p>G√©rez vos patients en attente</p>
                
                <div class="queue-stats" id="queueStats">
                    <div class="stat-card">
                        <div class="stat-value" id="waitingCount">-</div>
                        <div class="stat-label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedCount">-</div>
                        <div class="stat-label">Compl√©t√©s aujourd'hui</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">-</div>
                        <div class="stat-label">Total rendez-vous</div>
                    </div>
                </div>
            </div>

            <div class="current-patient" id="currentPatient">
                <h2>Patient actuel</h2>
                <div id="currentPatientContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Aucun patient en consultation</p>
                    </div>
                </div>
            </div>

            <div class="waiting-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Patients en attente</h2>
                    <button class="call-next-btn" id="callNextBtn" onclick="queueManager.callNextPatient()" style="width: auto; margin: 0;">
                        üì¢ Appeler le suivant
                    </button>
                </div>
                <div id="waitingListContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <p>Aucun patient en attente</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/dashboard.js' %}"></script>
    <script>
        class QueueManager {
            constructor() {
                this.currentAppointment = null;
                this.init();
            }

            async init() {
                await this.loadQueueStatus();
                // Auto-refresh every 30 seconds
                setInterval(() => this.loadQueueStatus(), 30000);
            }

            async loadQueueStatus() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const response = await fetch(`/api/v1/queue/status/?date=${today}`);
                    const data = await response.json();

                    this.updateStats(data);
                    this.updateCurrentPatient(data.current_patient);
                    this.updateWaitingList(data.waiting_list);
                    
                    const callBtn = document.getElementById('callNextBtn');
                    if (callBtn) {
                        callBtn.disabled = !data.waiting_list || data.waiting_list.length === 0;
                    }
                } catch (error) {
                    console.error('Error loading queue status:', error);
                }
            }

            updateStats(data) {
                document.getElementById('waitingCount').textContent = data.waiting_count || 0;
                document.getElementById('completedCount').textContent = data.completed_count || 0;
                document.getElementById('totalCount').textContent = data.total_appointments || 0;
            }

            updateCurrentPatient(patient) {
                const container = document.getElementById('currentPatientContent');
                const parentDiv = document.getElementById('currentPatient');
                
                if (patient) {
                    this.currentAppointment = patient;
                    parentDiv.classList.add('active');
                    container.innerHTML = `
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div class="queue-number-badge">${patient.queue_number || 'N/A'}</div>
                            <div style="flex: 1;">
                                <h3>${patient.patient?.full_name || patient.patient_name || 'Patient'}</h3>
                                <p><strong>Heure:</strong> ${patient.appointment_time || 'N/A'}</p>
                                <p><strong>Raison:</strong> ${patient.reason || 'Consultation'}</p>
                            </div>
                            <button class="complete-btn" onclick="queueManager.completeAppointment('${patient.id}')">
                                ‚úÖ Marquer comme termin√©
                            </button>
                        </div>
                    `;
                } else {
                    parentDiv.classList.remove('active');
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë§</div>
                            <p>Aucun patient en consultation</p>
                        </div>
                    `;
                }
            }

            updateWaitingList(waitingList) {
                const container = document.getElementById('waitingListContent');
                
                if (!waitingList || waitingList.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úÖ</div>
                            <p>Aucun patient en attente</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = waitingList.map(patient => `
                    <div class="patient-card">
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div class="queue-number-badge">${patient.queue_number}</div>
                            <div>
                                <h4>${patient.patient_name}</h4>
                                <p style="margin: 5px 0; color: #718096;">
                                    <strong>Heure:</strong> ${patient.appointment_time} | 
                                    <strong>Attente estim√©e:</strong> ${patient.estimated_wait} min
                                </p>
                                <p style="margin: 0; color: #718096;">${patient.reason || 'Consultation'}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async callNextPatient() {
                if (!confirm('Appeler le prochain patient?')) {
                    return;
                }

                try {
                    const btn = document.getElementById('callNextBtn');
                    if (btn) {
                        btn.disabled = true;
                        btn.textContent = '‚è≥ Appel en cours...';
                    }

                    const response = await fetch('/api/v1/queue/call-next/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            appointment_date: new Date().toISOString().split('T')[0]
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(`‚úÖ ${data.message}\n\nPatient: ${data.patient_name}\nNum√©ro: ${data.queue_number}`);
                        await this.loadQueueStatus();
                    } else {
                        alert(data.message || 'Aucun patient en attente');
                    }
                } catch (error) {
                    console.error('Error calling next patient:', error);
                    alert('Erreur lors de l\'appel du patient');
                } finally {
                    const btn = document.getElementById('callNextBtn');
                    if (btn) {
                        btn.textContent = 'üì¢ Appeler le suivant';
                    }
                }
            }

            async completeAppointment(appointmentId) {
                if (!confirm('Marquer cette consultation comme termin√©e?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/v1/queue/complete/${appointmentId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCookie('csrftoken')
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('‚úÖ Consultation termin√©e!');
                        await this.loadQueueStatus();
                    } else {
                        alert('Erreur: ' + (data.error || 'Impossible de terminer'));
                    }
                } catch (error) {
                    console.error('Error completing appointment:', error);
                    alert('Erreur lors de la finalisation');
                }
            }

            getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        }

        const queueManager = new QueueManager();
    </script>
</body>

</html>

