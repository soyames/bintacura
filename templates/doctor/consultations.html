{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultations - Docteur BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/doctor.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/consultations.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor-theme.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    {% include "components/top_nav.html" with user_type="doctor" page_title="Consultations" %}

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% include "layout/_sidebar_doctor.html" %}

    <div class="main-content">
        <div class="filter-tabs">
            <div class="filter-tab active" data-filter="waiting" onclick="filterConsultations('waiting')">
                <span>‚è≥ En Attente</span>
                <span class="tab-count" id="waitingCount">0</span>
            </div>
            <div class="filter-tab" data-filter="scheduled" onclick="filterConsultations('scheduled')">
                <span>üìÖ Programm√©es</span>
                <span class="tab-count" id="scheduledCount">0</span>
            </div>
            <div class="filter-tab" data-filter="in-progress" onclick="filterConsultations('in-progress')">
                <span>üîÑ En Cours</span>
                <span class="tab-count" id="inProgressCount">0</span>
            </div>
            <div class="filter-tab" data-filter="completed" onclick="filterConsultations('completed')">
                <span>‚úÖ Termin√©es</span>
                <span class="tab-count" id="completedCount">0</span>
            </div>
        </div>

        <div class="consultation-list" id="consultationList">
            <!-- Consultations will be loaded here -->
        </div>
    </div>

    <script>
        let allConsultations = [];
        let currentFilter = 'waiting';

        async function loadConsultations() {
            try {
                const response = await fetch('/doctor/api/consultations/');
                if (!response.ok) throw new Error('Failed to fetch consultations');
                
                const data = await response.json();
                allConsultations = data.consultations || [];
                
                updateCounts(data.counts);
                filterConsultations(currentFilter);
            } catch (error) {
                console.error('Error loading consultations:', error);
                showEmptyState('Erreur de chargement des consultations');
            }
        }

        function updateCounts(counts) {
            document.getElementById('waitingCount').textContent = counts?.waiting || 0;
            document.getElementById('scheduledCount').textContent = counts?.scheduled || 0;
            document.getElementById('inProgressCount').textContent = counts?.in_progress || 0;
            document.getElementById('completedCount').textContent = counts?.completed || 0;
        }

        function filterConsultations(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Filter consultations
            const filtered = allConsultations.filter(c => c.status === filter);
            renderConsultations(filtered, filter);
        }

        function renderConsultations(consultations, filter) {
            const container = document.getElementById('consultationList');
            
            if (!consultations || consultations.length === 0) {
                showEmptyState(getEmptyMessage(filter));
                return;
            }

            container.innerHTML = consultations.map((consultation, index) => `
                <div class="consultation-item ${consultation.status}" data-id="${consultation.id}">
                    ${filter === 'waiting' ? `
                    <div class="waiting-indicator">
                        <span class="pulse"></span>
                        <span>Patient en attente - Position ${index + 1}</span>
                    </div>
                    ` : ''}
                    
                    <div class="consultation-header">
                        <div class="patient-info-main">
                            <div class="patient-name-large">
                                ${filter === 'waiting' ? `<span class="queue-position">${index + 1}</span>` : ''}
                                ${consultation.patient_name}
                            </div>
                            <div class="consultation-details">
                                <div class="consultation-detail">
                                    <span>üìÖ</span>
                                    <span>${consultation.date}</span>
                                </div>
                                <div class="consultation-detail">
                                    <span>üïê</span>
                                    <span>${consultation.time}</span>
                                </div>
                                <div class="consultation-detail">
                                    <span>‚è±Ô∏è</span>
                                    <span>${consultation.duration} min</span>
                                </div>
                                ${consultation.type ? `
                                <div class="consultation-detail">
                                    <span>üè∑Ô∏è</span>
                                    <span>${consultation.type}</span>
                                </div>
                                ` : ''}
                            </div>
                            ${consultation.reason ? `
                            <div style="margin-top: 10px; color: #555; font-size: 14px;">
                                <strong>Motif:</strong> ${consultation.reason}
                            </div>
                            ` : ''}
                        </div>
                        <div class="status-badge ${consultation.status}">
                            ${getStatusIcon(consultation.status)} ${getStatusText(consultation.status)}
                        </div>
                    </div>
                    
                    <div class="consultation-actions">
                        ${filter === 'waiting' || filter === 'scheduled' ? `
                        <button class="btn btn-call" onclick="callPatient('${consultation.id}', '${consultation.patient_uid}')">
                            üìû Appeler
                        </button>
                        ` : ''}
                        <a href="/doctor/medical-record/${consultation.patient_uid}/" class="btn btn-dossier">
                            üìã Dossier M√©dical
                        </a>
                        ${filter === 'in-progress' ? `
                        <button class="btn btn-complete" onclick="completeConsultation('${consultation.id}')">
                            ‚úÖ Terminer
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getStatusIcon(status) {
            const icons = {
                'waiting': '‚è≥',
                'scheduled': 'üìÖ',
                'in-progress': 'üîÑ',
                'completed': '‚úÖ'
            };
            return icons[status] || 'üìã';
        }

        function getStatusText(status) {
            const texts = {
                'waiting': 'En attente',
                'scheduled': 'Programm√©e',
                'in-progress': 'En cours',
                'completed': 'Termin√©e'
            };
            return texts[status] || status;
        }

        function getEmptyMessage(filter) {
            const messages = {
                'waiting': 'Aucun patient en attente',
                'scheduled': 'Aucune consultation programm√©e',
                'in-progress': 'Aucune consultation en cours',
                'completed': 'Aucune consultation termin√©e'
            };
            return messages[filter] || 'Aucune consultation';
        }

        function showEmptyState(message) {
            const container = document.getElementById('consultationList');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">${message}</div>
                    <p>Les consultations appara√Ætront ici selon leur statut.</p>
                </div>
            `;
        }

        async function callPatient(consultationId, patientUid) {
            try {
                const response = await fetch('/doctor/api/consultations/call/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ consultation_id: consultationId })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Notification sent to patient
                    alert('Notification envoy√©e au patient');
                    
                    // Open medical record
                    window.location.href = `/doctor/medical-record/${patientUid}/`;
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Error calling patient:', error);
                alert('Erreur lors de l\'appel du patient');
            }
        }

        async function completeConsultation(consultationId) {
            if (!confirm('Marquer cette consultation comme termin√©e ?')) return;
            
            try {
                const response = await fetch('/doctor/api/consultations/complete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ consultation_id: consultationId })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Consultation termin√©e');
                    loadConsultations(); // Reload
                } else {
                    alert('Erreur: ' + result.message);
                }
            } catch (error) {
                console.error('Error completing consultation:', error);
                alert('Erreur lors de la finalisation');
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Load consultations on page load
        loadConsultations();

        // Auto-refresh every 30 seconds
        setInterval(loadConsultations, 30000);
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
