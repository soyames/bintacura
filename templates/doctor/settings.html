{% load static %}
<!DOCTYPE html>
<html lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres - Docteur BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/doctor.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctor/doctor_settings.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <img src="{% static 'img/logo.png' %}" alt="BINTACURA" class="logo-img">
                
            </div>
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">DR</div>
                <div class="sidebar-user-info">
                    <h3>Docteur</h3>
                    <p>doctor@BINTACURA.com</p>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="sidebar-section">
                <div class="sidebar-section-title">Navigation</div>
                <a href="/doctor/dashboard/" class="sidebar-menu-item">
                    <span class="sidebar-menu-item-icon">üìä</span>
                    <span class="sidebar-menu-item-text">Tableau de Bord</span>
                </a>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Compte</div>
                <a href="/doctor/profile/" class="sidebar-menu-item">
                    <span class="sidebar-menu-item-icon">üë§</span>
                    <span class="sidebar-menu-item-text">Profil</span>
                </a>
                <a href="/logout/" class="sidebar-menu-item">
                    <span class="sidebar-menu-item-icon">üö™</span>
                    <span class="sidebar-menu-item-text">D√©connexion</span>
                </a>
            </div>
        </nav>
    </aside>

    {% include "components/top_nav.html" with user_type="doctor" page_title="Param√®tres" %}

    <main class="main-content">
        <div class="content-section">
            <h2>üåê Pr√©f√©rences de Langue</h2>
            <p>Choisissez votre langue pr√©f√©r√©e</p>
            <div class="language-wrapper">
                {% include "components/language_switcher.html" %}
            </div>
        </div>

        <div class="content-section">
            <h2>üí∞ Tarifs et Services</h2>
            <p>D√©finissez vos tarifs et services disponibles</p>

            <form id="feesForm">
                {% csrf_token %}
                <div class="form-grid two-columns">
                    <div class="form-group">
                        <label>Frais de consultation (FCFA)</label>
                        <input type="number" id="consultation_fee" min="0" step="100" required>
                        <small>Montant que les patients devront payer pour une consultation</small>
                    </div>

                    <div class="form-group">
                        <label>Ann√©es d'exp√©rience</label>
                        <input type="number" id="years_of_experience" min="0" max="70">
                        <small>Votre nombre d'ann√©es de pratique m√©dicale</small>
                    </div>
                </div>

                <div class="form-group form-bio">
                    <label>Biographie professionnelle</label>
                    <textarea id="bio" placeholder="D√©crivez bri√®vement votre parcours et vos domaines d'expertise..."></textarea>
                    <small>Cette description sera visible par les patients</small>
                </div>

                <div class="checkbox-wrapper checkbox-section">
                    <input type="checkbox" id="telemedicine_available">
                    <label for="telemedicine_available">Disponible pour la t√©l√©m√©decine</label>
                </div>

                <button type="submit" class="btn-primary submit-btn">
                    Enregistrer les modifications
                </button>
            </form>

            <div class="current-settings-box" id="currentSettings">
                <h3>üìã Param√®tres actuels</h3>
                <div id="settingsDisplay">
                    <p>Chargement...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="{% static 'js/api.js' %}"></script>
    <script>
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const menuIcon = document.getElementById('menuIcon');

        function toggleSidebar() {
            const isOpen = sidebar.classList.contains('active');
            if (isOpen) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                menuIcon.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
                menuIcon.classList.add('active');
            }
        }

        menuIcon.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        async function loadSettings() {
            try {
                const response = await fetchApi('core/doctor-data/');
                const data = await response.json();
                const settings = data.results && data.results.length > 0 ? data.results[0] : data;

                if (settings) {
                    document.getElementById('consultation_fee').value = settings.consultation_fee || 0;
                    document.getElementById('telemedicine_available').checked = settings.is_available_for_telemedicine || false;
                    document.getElementById('years_of_experience').value = settings.years_of_experience || 0;
                    document.getElementById('bio').value = settings.bio || '';

                    document.getElementById('settingsDisplay').innerHTML = `
                        <div class="settings-grid">
                            <div class="setting-item">
                                <div class="setting-label">Frais de consultation</div>
                                <div class="setting-value" id="consultation-fee-display">${settings.consultation_fee || 0} USD</div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-label">T√©l√©m√©decine</div>
                                <div class="setting-value">
                                    <span class="status-badge ${settings.is_available_for_telemedicine ? 'active' : 'inactive'}">
                                        ${settings.is_available_for_telemedicine ? 'Activ√©e' : 'D√©sactiv√©e'}
                                    </span>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-label">Sp√©cialisation</div>
                                <div class="setting-value">${settings.specialization || 'Non d√©finie'}</div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-label">Ann√©es d'exp√©rience</div>
                                <div class="setting-value">${settings.years_of_experience || 0} ans</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('settingsDisplay').innerHTML = '<p class="error-text">Erreur de chargement</p>';
            }
        }

        document.getElementById('feesForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                consultation_fee: parseInt(document.getElementById('consultation_fee').value),
                is_available_for_telemedicine: document.getElementById('telemedicine_available').checked,
                years_of_experience: parseInt(document.getElementById('years_of_experience').value) || 0,
                bio: document.getElementById('bio').value
            };

            try {
                const listResponse = await fetchApi('core/doctor-data/');
                const listData = await listResponse.json();
                const doctorData = listData.results && listData.results.length > 0 ? listData.results[0] : listData;

                if (!doctorData || !doctorData.id) {
                    alert('Impossible de charger vos donn√©es. Veuillez r√©essayer.');
                    return;
                }

                const response = await fetchApi(`core/doctor-data/${doctorData.id}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Param√®tres mis √† jour avec succ√®s');
                    loadSettings();
                } else {
                    const error = await response.json();
                    alert('Erreur: ' + (error.detail || 'Une erreur est survenue'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Erreur de connexion');
            }
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        loadSettings();
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
