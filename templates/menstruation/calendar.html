{% load static %}
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Menstruel - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/menstruation.css' %}">
    <link rel="stylesheet" href="{% static 'css/patient-theme.css' %}">
    {% include "components/translation_script.html" %}
</head>

<body>
    <nav class="top-nav">
        <div class="nav-left">
            <button class="menu-toggle-btn" id="menuIcon">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <button class="nav-back-btn" onclick="window.location.href='{% url 'menstruation:tracker' %}'">‚Üê</button>
        </div>
        <div class="nav-center">
            <img src="{% static 'img/logo.png' %}" alt="BINTACURA" class="nav-logo-img">
            <span class="nav-page-title">Calendrier Menstruel</span>
        </div>
        <div class="nav-right">
            <div class="nav-user-avatar" onclick="window.location.href='/patient/profile/'">
                {% include "components/user_avatar.html" with user=request.user %}
            </div>
        </div>
    </nav>

    {% include "layout/_sidebar_patient.html" %}

    <div class="menstruation-container">
        <!-- Calendar Controls -->
        <div class="calendar-controls">
            <button class="btn btn-icon" onclick="previousMonth()">‚Üê</button>
            <div class="calendar-month-year">
                <h2 id="currentMonth">{{ current_month|date:"F Y" }}</h2>
            </div>
            <button class="btn btn-icon" onclick="nextMonth()">‚Üí</button>
            <button class="btn btn-secondary" onclick="goToToday()">Aujourd'hui</button>
        </div>

        <!-- Legend -->
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color period-day"></div>
                <span>R√®gles</span>
            </div>
            <div class="legend-item">
                <div class="legend-color ovulation-day"></div>
                <span>Ovulation</span>
            </div>
            <div class="legend-item">
                <div class="legend-color fertile-day"></div>
                <span>P√©riode Fertile</span>
            </div>
            <div class="legend-item">
                <div class="legend-color predicted-day"></div>
                <span>Pr√©diction</span>
            </div>
        </div>

        <!-- Full Calendar -->
        <div class="full-calendar">
            <div class="calendar-weekdays">
                <div class="weekday">Lun</div>
                <div class="weekday">Mar</div>
                <div class="weekday">Mer</div>
                <div class="weekday">Jeu</div>
                <div class="weekday">Ven</div>
                <div class="weekday">Sam</div>
                <div class="weekday">Dim</div>
            </div>
            <div class="calendar-days" id="calendarDays">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>

        <!-- Selected Day Details -->
        <div id="dayDetails" class="day-details-card" style="display: none;">
            <div class="day-details-header">
                <h3 id="selectedDate"></h3>
                <button class="btn btn-close" onclick="closeDayDetails()">√ó</button>
            </div>
            <div id="dayDetailsContent"></div>
        </div>

        <!-- Cycle Statistics -->
        <div class="calendar-stats">
            <div class="stat-card">
                <div class="stat-label">Cycle Actuel</div>
                <div class="stat-value">Jour {{ current_cycle_day|default:"‚Äî" }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Prochaines R√®gles</div>
                <div class="stat-value">{{ days_until_period|default:"‚Äî" }} jours</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Dur√©e Moyenne</div>
                <div class="stat-value">{{ avg_cycle_length|floatformat:0|default:"28" }} jours</div>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        const calendarData = {{ calendar_data|safe }};

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update header
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                              'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const numDays = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay() || 7; // Monday = 1
            
            // Clear existing days
            const calendarDaysEl = document.getElementById('calendarDays');
            calendarDaysEl.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 1; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarDaysEl.appendChild(emptyDay);
            }
            
            // Add days of month
            for (let day = 1; day <= numDays; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = calendarData[dateStr] || {};
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                // Add classes based on data
                if (dayData.is_period) dayEl.classList.add('period-day');
                if (dayData.is_ovulation) dayEl.classList.add('ovulation-day');
                if (dayData.is_fertile) dayEl.classList.add('fertile-day');
                if (dayData.is_predicted) dayEl.classList.add('predicted-day');
                if (dayData.is_today) dayEl.classList.add('today');
                
                dayEl.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${dayData.has_symptoms ? '<div class="day-indicator">üí≠</div>' : ''}
                `;
                
                dayEl.onclick = () => showDayDetails(dateStr, dayData);
                calendarDaysEl.appendChild(dayEl);
            }
        }

        function showDayDetails(dateStr, data) {
            const detailsEl = document.getElementById('dayDetails');
            const contentEl = document.getElementById('dayDetailsContent');
            const dateEl = document.getElementById('selectedDate');
            
            // Format date
            const date = new Date(dateStr + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.textContent = date.toLocaleDateString('fr-FR', options);
            
            // Build content
            let content = '';
            
            if (data.is_period) {
                content += '<div class="day-detail-item period"><strong>üî¥ Jour de r√®gles</strong></div>';
            }
            if (data.is_ovulation) {
                content += '<div class="day-detail-item ovulation"><strong>üü¢ Ovulation</strong></div>';
            }
            if (data.is_fertile) {
                content += '<div class="day-detail-item fertile"><strong>üü° P√©riode fertile</strong></div>';
            }
            if (data.is_predicted) {
                content += '<div class="day-detail-item predicted"><strong>üå∏ R√®gles pr√©dites</strong></div>';
            }
            
            if (data.symptoms && data.symptoms.length > 0) {
                content += '<div class="day-detail-symptoms"><strong>Sympt√¥mes :</strong><ul>';
                data.symptoms.forEach(symptom => {
                    content += `<li>${symptom}</li>`;
                });
                content += '</ul></div>';
            }
            
            if (content === '') {
                content = '<p class="text-muted">Aucune donn√©e enregistr√©e pour ce jour</p>';
            }
            
            content += `<button class="btn btn-sm btn-primary" onclick="window.location.href='/patient/menstruation/log-symptom/?date=${dateStr}'">Ajouter un sympt√¥me</button>`;
            
            contentEl.innerHTML = content;
            detailsEl.style.display = 'block';
        }

        function closeDayDetails() {
            document.getElementById('dayDetails').style.display = 'none';
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        // Initial render
        renderCalendar();
    </script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>

</html>
