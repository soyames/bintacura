{% load static %}
<link rel="stylesheet" href="{% static 'css/language_switcher.css' %}">

<div class="language-switcher">
    <select id="language-select" class="form-select form-select-sm">
        <option value="fr" {% if request.LANGUAGE_CODE == 'fr' %}selected{% endif %}>ğŸ‡«ğŸ‡· FranÃ§ais</option>
        <option value="en" {% if request.LANGUAGE_CODE == 'en' %}selected{% endif %}>ğŸ‡¬ğŸ‡§ English</option>
    </select>
</div>

<script>
// Set language data attribute on HTML tag for JavaScript detection
const currentLang = '{{ request.LANGUAGE_CODE|default:"fr" }}';
console.log('ğŸŒ Language Switcher: Current language =', currentLang);
document.documentElement.setAttribute('data-language', currentLang);
document.documentElement.lang = currentLang;

(function() {
    const languageSelect = document.getElementById('language-select');
    if (!languageSelect) {
        console.error('âŒ Language select element not found!');
        return;
    }
    
    console.log('âœ“ Language switcher initialized');

    languageSelect.addEventListener('change', function(e) {
        const language = e.target.value;
        console.log('ğŸ”„ Language change requested:', language);
        
        const formData = new FormData();
        formData.append('language', language);
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            console.error('âŒ CSRF token not found!');
            alert('Erreur: Token de sÃ©curitÃ© non trouvÃ©');
            return;
        }

        console.log('ğŸ“¡ Sending POST request to set_language...');
        fetch('{% url "set_language" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('ğŸ“¡ Response status:', response.status);
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('ğŸ“¡ Response data:', data);
            if (data.status === 'success') {
                console.log('âœ… Language changed successfully to:', data.language);
                // Update data attribute before reload
                document.documentElement.setAttribute('data-language', language);
                document.documentElement.lang = language;
                console.log('ğŸ”„ Reloading page...');
                window.location.reload();
            } else {
                console.error('âŒ Server returned error:', data.message);
                alert('Erreur: ' + (data.message || 'Impossible de changer la langue'));
            }
        })
        .catch(error => {
            console.error('âŒ Error changing language:', error);
            alert('Erreur de connexion. Veuillez rÃ©essayer.\n' + error.message);
        });
    });

    function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === 'csrftoken=') {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }
})();
</script>
