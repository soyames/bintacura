{% load static %}
{% load currency_filters %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture {{ receipt.invoice_number|default:receipt.receipt_number }} - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/payments/receipt.css' %}">
    {% include "components/translation_script.html" %}
</head>
<body>
    <nav class="top-nav">
        <div class="nav-left">
            <button class="menu-toggle-btn" id="menuIcon">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <button class="nav-back-btn" onclick="window.location.href='/{{ portal }}/invoices/'">←</button>
        </div>
        <div class="nav-center">
            <img src="{% static 'img/logo.png' %}" alt="BINTACURA" class="nav-logo-img">
            <span class="nav-page-title">Facture {{ receipt.invoice_number|default:receipt.receipt_number }}</span>
        </div>
        <div class="nav-right">
            <div class="nav-user-avatar" onclick="window.location.href='/{{ portal }}/profile/'">
                {% include "components/user_avatar.html" with user=request.user %}
            </div>
        </div>
    </nav>
    
    {% if portal == 'patient' %}
        {% include "layout/_sidebar_patient.html" %}
    {% elif portal == 'doctor' %}
        {% include "layout/_sidebar_doctor.html" %}
    {% elif portal == 'hospital' %}
        {% include "layout/_sidebar_hospital.html" %}
    {% elif portal == 'pharmacy' %}
        {% include "layout/_sidebar_pharmacy.html" %}
    {% elif portal == 'insurance' %}
        {% include "layout/_sidebar_insurance.html" %}
    {% endif %}
    
<div class="receipt-container">
    <div class="receipt-wrapper">
        <!-- Header Section -->
        <div class="receipt-header">
            <div class="company-logo">
                <img src="{% static 'img/logo.png' %}" alt="BINTACURA Logo" class="logo-image">
            </div>
             <!-- Company Details Below Logo -->
             <div>
                <p><strong>BINTACURA</strong></p>
                <p>Healthcare Platform</p>
                <p>RCCM: VTC/BJ/2024</p>
                <p>IFU: {{ company_ifu }}</p>
                <p>Tel: {{ company_phone }}</p>
                <p>{{ company_address }}</p>
             </div>
            <div class="invoice-details">
                <p class="status-badge status-{{ receipt.payment_status|lower }}">
                    {{ receipt.get_payment_status_display }}
                </p>
                <div class="qr-code-header">
                    <h2>Facture #{{ receipt.invoice_number|default:receipt.receipt_number }}</h2>
                    {% if receipt.qr_code %}
                    <img src="{{ receipt.qr_code }}" alt="QR Code" class="qr-code-image-header">
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Currency Conversion Notice -->
        {% if receipt.original_currency and receipt.display_currency and receipt.original_currency != receipt.display_currency %}
        <div class="currency-notice" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin: 15px 0; border-radius: 4px;">
            <p style="margin: 0; color: #1976d2; font-size: 14px;">
                ℹ️ <strong>Conversion de devise:</strong> Les montants d'origine en {{ receipt.original_currency }} ont été convertis en {{ receipt.display_currency }} selon le taux de change actuel.
            </p>
        </div>
        {% endif %}

        <!-- Billing Information -->
        <div class="billing-section">
            <div class="billing-party">
                <h3>Payer à</h3>
                <div class="party-details">
                    <p><strong>BINTACURA</strong></p>
                    <p>Healthcare Platform</p>
                    <p>RCCM: VTC/BJ/2024</p>
                    <p>IFU: {{ company_ifu }}</p>
                    <p>Tel: {{ company_phone }}</p>
                    <p>{{ company_address }}</p>
                </div>
            </div>
            <div class="billing-party">
                <h3>Facturé à</h3>
                <div class="party-details">
                    <p><strong>{{ receipt.issued_to_name|default:receipt.issued_to.full_name }}</strong></p>
                    <p>{{ receipt.issued_to.email }}</p>
                    {% if receipt.issued_to_address %}
                    <p>{{ receipt.issued_to_address }}</p>
                    {% endif %}
                    {% if receipt.issued_to_city %}
                    <p>{{ receipt.issued_to_city }}{% if receipt.issued_to_country %}, {{ receipt.issued_to_country }}{% endif %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Payment and Date Information -->
        <div class="payment-info-section">
            <div class="info-block">
                <h4>Mode de paiement</h4>
                <p>
                    {% if receipt.service_transaction %}
                        {{ receipt.service_transaction.get_payment_method_display }}
                    {% elif receipt.payment_method == 'cash' or receipt.payment_method == 'onsite_cash' %}
                        Paiement sur place (Espèces)
                    {% elif receipt.payment_gateway %}
                        {{ receipt.payment_gateway }} - {{ receipt.payment_method|title }}
                    {% else %}
                        {{ receipt.payment_method|default:"Non spécifié" }}
                    {% endif %}
                </p>
            </div>
            <div class="info-block">
                <h4>Date de facturation</h4>
                <p>{{ receipt.billing_date|date:"d/m/Y"|default:receipt.issued_at|date:"d/m/Y" }}</p>
            </div>
        </div>

        <!-- Line Items -->
        <div class="line-items-section">
            <h3>Items de la facture</h3>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Descriptif</th>
                        <th>Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% if receipt.converted_line_items %}
                        {% for item in receipt.converted_line_items %}
                        <tr>
                            <td>{{ item.description }}{% if item.taxable %} *{% endif %}</td>
                            <td class="amount-cell">{{ item.amount|format_currency:participant_currency }}</td>
                        </tr>
                        {% endfor %}
                    {% elif receipt.line_items %}
                        {% for item in receipt.line_items %}
                        <tr>
                            <td>{{ item.description }}{% if item.taxable %} *{% endif %}</td>
                            <td class="amount-cell">{{ item.amount|format_currency:participant_currency }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td>{{ receipt.service_details.description|default:"Service de santé" }} *</td>
                        <td class="amount-cell">{{ receipt.converted_subtotal|default:receipt.subtotal|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    {% if receipt.platform_fee and receipt.platform_fee > 0 %}
                    <tr>
                        <td>Frais de transaction (Plateforme)</td>
                        <td class="amount-cell">{{ receipt.converted_platform_fee|default:receipt.platform_fee|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    <tr class="subtotal-row">
                        <td><strong>Sous-total</strong></td>
                        <td class="amount-cell"><strong>{{ receipt.converted_subtotal|default:receipt.subtotal|format_currency:participant_currency }}</strong></td>
                    </tr>

                    {% if receipt.tax_amount and receipt.tax_amount > 0 %}
                    <tr>
                        <td>{{ receipt.tax_rate }}% TVA</td>
                        <td class="amount-cell">{{ receipt.converted_tax_amount|default:receipt.tax_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    {% if receipt.discount_amount and receipt.discount_amount > 0 %}
                    <tr>
                        <td>Crédit</td>
                        <td class="amount-cell">-{{ receipt.converted_discount_amount|default:receipt.discount_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    <tr class="total-row">
                        <td><strong>Total</strong></td>
                        <td class="amount-cell"><strong>{{ receipt.converted_total_amount|default:receipt.total_amount|format_currency:participant_currency }}</strong></td>
                    </tr>
                </tbody>
            </table>
            <p class="tax-note">* Indique un article taxable.</p>
        </div>

        <!-- Transaction Details -->
        {% if receipt.transaction_reference or receipt.gateway_transaction_id %}
        <div class="transactions-section">
            <h3>Transactions</h3>
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Date de la transaction</th>
                        <th>Passerelle</th>
                        <th>Transaction #</th>
                        <th>Montant</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ receipt.payment_date|date:"d/m/Y"|default:receipt.issued_at|date:"d/m/Y" }}</td>
                        <td>{{ receipt.payment_gateway|default:"-" }}</td>
                        <td>{{ receipt.gateway_transaction_id|default:receipt.transaction_reference|default:"-" }}</td>
                        <td class="amount-cell">{{ receipt.converted_total_amount|default:receipt.total_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% if receipt.discount_amount and receipt.discount_amount > 0 %}
                    <tr>
                        <td>{{ receipt.issued_at|date:"d/m/Y" }}</td>
                        <td>-</td>
                        <td></td>
                        <td class="amount-cell">-{{ receipt.converted_discount_amount|default:receipt.discount_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}
                    <tr class="balance-row">
                        <td colspan="3"><strong>Solde</strong></td>
                        <td class="amount-cell"><strong>{{ receipt.converted_total_amount|default:receipt.total_amount|format_currency:participant_currency }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="receipt-actions">
            <button onclick="printReceipt()" class="btn btn-primary btn-print">
                <i class="fas fa-print"></i> Imprimer
            </button>
            <a href="{% url portal|add:':download-invoice' receipt.id %}" class="btn btn-secondary btn-download">
                <i class="fas fa-download"></i> Télécharger
            </a>
        </div>

        <!-- Footer -->
        <div class="receipt-footer">
            <p>Ce reçu a été généré automatiquement.</p>
            <p>Pour toute question, contactez support@BINTACURA.com</p>
            <p><strong>Merci d'utiliser BINTACURA!</strong></p>
        </div>
    </div>
</div>

<script src="{% static 'js/payments/receipt.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
</body>
</html>

