{% load static %}
{% load currency_filters %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facture {{ receipt.invoice_number|default:receipt.receipt_number }} - BINTACURA</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'css/top-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/payments/receipt.css' %}">
    {% include "components/translation_script.html" %}
</head>
<body>
    {% include "components/top_nav.html" with user_type=portal page_title=invoice_title %}
    
    {% if portal == 'patient' %}
        {% include "layout/_sidebar_patient.html" %}
    {% elif portal == 'doctor' %}
        {% include "layout/_sidebar_doctor.html" %}
    {% elif portal == 'hospital' %}
        {% include "layout/_sidebar_hospital.html" %}
    {% elif portal == 'pharmacy' %}
        {% include "layout/_sidebar_pharmacy.html" %}
    {% elif portal == 'insurance' %}
        {% include "layout/_sidebar_insurance.html" %}
    {% endif %}
    
<div class="receipt-container">
    <div class="receipt-wrapper">
        <!-- Header Section -->
        <div class="receipt-header">
            <div class="company-logo">
                <img src="{% static 'img/logo.png' %}" alt="BINTACURA Logo" class="logo-image">
            </div>
             <!-- Company Details Below Logo -->
             <div>
                <p><strong>BINTACURA</strong></p>
                <p>Healthcare Platform</p>
                <p>RCCM: VTC/BJ/2024</p>
                <p>IFU: {{ company_ifu }}</p>
                <p>Tel: {{ company_phone }}</p>
                <p>{{ company_address }}</p>
             </div>
            <div class="invoice-details">
                <p class="status-badge status-{{ receipt.payment_status|lower }}">
                    {{ receipt.get_payment_status_display }}
                </p>
                <div class="qr-code-header">
                    <h2>Facture #{{ receipt.invoice_number|default:receipt.receipt_number }}</h2>
                    {% if receipt.qr_code %}
                    <img src="{{ receipt.qr_code }}" alt="QR Code" class="qr-code-image-header">
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Currency Conversion Notice -->
        {% if receipt.original_currency and receipt.display_currency and receipt.original_currency != receipt.display_currency %}
        <div class="currency-notice" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; margin: 15px 0; border-radius: 4px;">
            <p style="margin: 0; color: #1976d2; font-size: 14px;">
                ℹ️ <strong>Conversion de devise:</strong> Les montants d'origine en {{ receipt.original_currency }} ont été convertis en {{ receipt.display_currency }} selon le taux de change actuel.
            </p>
        </div>
        {% endif %}

        <!-- Billing Information -->
        <div class="billing-section">
            <div class="billing-party">
                <h3>Payer à</h3>
                <div class="party-details">
                    {% if receipt.issued_by %}
                        <p><strong>{{ receipt.issued_by.full_name|upper }}</strong></p>
                        {% if receipt.issued_by.role == 'doctor' %}
                            <p>Médecin</p>
                        {% elif receipt.issued_by.role == 'hospital' %}
                            <p>Établissement Hospitalier</p>
                        {% elif receipt.issued_by.role == 'pharmacy' %}
                            <p>Pharmacie</p>
                        {% elif receipt.issued_by.role == 'insurance_company' %}
                            <p>Compagnie d'Assurance</p>
                        {% else %}
                            <p>Prestataire de Services</p>
                        {% endif %}
                        {% if receipt.issued_by.professional_id %}
                            <p>N° Prof: {{ receipt.issued_by.professional_id }}</p>
                        {% endif %}
                        <p>Tel: {{ receipt.issued_by.phone_number|default:"N/A" }}</p>
                        {% if receipt.issued_by.address %}
                            <p>{{ receipt.issued_by.address }}</p>
                        {% endif %}
                        <p>{{ receipt.issued_by.city|default:"Cotonou" }}, {{ receipt.issued_by.country|default:"BENIN" }}</p>
                    {% else %}
                        <p><strong>BINTACURA</strong></p>
                        <p>Healthcare Platform</p>
                        <p>RCCM: VTC/BJ/2024</p>
                        <p>IFU: {{ company_ifu }}</p>
                        <p>Tel: {{ company_phone }}</p>
                        <p>{{ company_address }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="billing-party">
                <h3>Facturé à</h3>
                <div class="party-details">
                    <p><strong>{{ receipt.issued_to_name|default:receipt.issued_to.full_name }}</strong></p>
                    <p>{{ receipt.issued_to.email }}</p>
                    {% if receipt.issued_to_address %}
                    <p>{{ receipt.issued_to_address }}</p>
                    {% endif %}
                    {% if receipt.issued_to_city %}
                    <p>{{ receipt.issued_to_city }}{% if receipt.issued_to_country %}, {{ receipt.issued_to_country }}{% endif %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Payment and Date Information -->
        <div class="payment-info-section">
            <div class="info-block">
                <h4>Mode de paiement</h4>
                <p>
                    {% if receipt.service_transaction %}
                        {{ receipt.service_transaction.get_payment_method_display }}
                    {% elif receipt.payment_method == 'cash' or receipt.payment_method == 'onsite_cash' %}
                        Paiement sur place (Espèces)
                    {% elif receipt.payment_gateway %}
                        {{ receipt.payment_gateway }} - {{ receipt.payment_method|title }}
                    {% else %}
                        {{ receipt.payment_method|default:"Non spécifié" }}
                    {% endif %}
                </p>
            </div>
            <div class="info-block">
                <h4>Date de facturation</h4>
                <p>{{ receipt.billing_date|date:"d/m/Y"|default:receipt.issued_at|date:"d/m/Y" }}</p>
            </div>
        </div>

        <!-- Line Items -->
        <div class="line-items-section">
            <h3>Items de la facture</h3>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Descriptif</th>
                        <th>Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% if receipt.converted_line_items %}
                        {% for item in receipt.converted_line_items %}
                        <tr>
                            <td>{{ item.description }}{% if item.taxable %} *{% endif %}</td>
                            <td class="amount-cell">{{ item.amount|format_currency:participant_currency }}</td>
                        </tr>
                        {% endfor %}
                    {% elif receipt.line_items %}
                        {% for item in receipt.line_items %}
                        <tr>
                            <td>{{ item.description }}{% if item.taxable %} *{% endif %}</td>
                            <td class="amount-cell">{{ item.amount|format_currency:participant_currency }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td>{{ receipt.service_details.description|default:"Service de santé" }} *</td>
                        <td class="amount-cell">{{ receipt.converted_subtotal|default:receipt.subtotal|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    {% if receipt.platform_fee and receipt.platform_fee > 0 %}
                    <tr>
                        <td>Frais de transaction (Plateforme)</td>
                        <td class="amount-cell">{{ receipt.converted_platform_fee|default:receipt.platform_fee|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    <tr class="subtotal-row">
                        <td><strong>Sous-total</strong></td>
                        <td class="amount-cell"><strong>{{ receipt.converted_subtotal|default:receipt.subtotal|format_currency:participant_currency }}</strong></td>
                    </tr>

                    {% if receipt.tax_amount and receipt.tax_amount > 0 %}
                    <tr>
                        <td>{{ receipt.tax_rate }}% TVA</td>
                        <td class="amount-cell">{{ receipt.converted_tax_amount|default:receipt.tax_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    {% if receipt.discount_amount and receipt.discount_amount > 0 %}
                    <tr>
                        <td>Crédit</td>
                        <td class="amount-cell">-{{ receipt.converted_discount_amount|default:receipt.discount_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}

                    <tr class="total-row">
                        <td><strong>Total</strong></td>
                        <td class="amount-cell"><strong>{{ receipt.converted_total_amount|default:receipt.total_amount|format_currency:participant_currency }}</strong></td>
                    </tr>
                </tbody>
            </table>
            <p class="tax-note">* Indique un article taxable.</p>
        </div>

        <!-- Transaction Details -->
        {% if receipt.transaction_reference or receipt.gateway_transaction_id %}
        <div class="transactions-section">
            <h3>Transactions</h3>
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Date de la transaction</th>
                        <th>Passerelle</th>
                        <th>Transaction #</th>
                        <th>Montant</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ receipt.payment_date|date:"d/m/Y"|default:receipt.issued_at|date:"d/m/Y" }}</td>
                        <td>{{ receipt.payment_gateway|default:"-" }}</td>
                        <td>{{ receipt.gateway_transaction_id|default:receipt.transaction_reference|default:"-" }}</td>
                        <td class="amount-cell">{{ receipt.converted_total_amount|default:receipt.total_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% if receipt.discount_amount and receipt.discount_amount > 0 %}
                    <tr>
                        <td>{{ receipt.issued_at|date:"d/m/Y" }}</td>
                        <td>-</td>
                        <td></td>
                        <td class="amount-cell">-{{ receipt.converted_discount_amount|default:receipt.discount_amount|format_currency:participant_currency }}</td>
                    </tr>
                    {% endif %}
                    <tr class="balance-row">
                        <td colspan="3"><strong>Solde</strong></td>
                        <td class="amount-cell"><strong>{{ receipt.converted_total_amount|default:receipt.total_amount|format_currency:participant_currency }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="receipt-actions">
            {% if portal == 'patient' and receipt.payment_status in 'pending,overdue' %}
            <button onclick="showPaymentModal('{{ receipt.id }}', '{{ receipt.converted_total_amount|default:receipt.total_amount|floatformat:0 }} {{ participant_currency }}', '{{ receipt.invoice_number|default:receipt.receipt_number }}', 'service')" class="btn btn-success btn-pay">
                <i class="fas fa-credit-card"></i> Payer
            </button>
            {% endif %}
            <button onclick="printReceipt()" class="btn btn-primary btn-print">
                <i class="fas fa-print"></i> Imprimer
            </button>
            <a href="{% url portal|add:':download-invoice' receipt.id %}" class="btn btn-secondary btn-download">
                <i class="fas fa-download"></i> Télécharger
            </a>
        </div>

        <!-- Footer -->
        <div class="receipt-footer">
            <p>Ce reçu a été généré automatiquement.</p>
            <p>Pour toute question, contactez {{ CONTACT_EMAIL }}</p>
            <p><strong>Merci d'utiliser BINTACURA!</strong></p>
        </div>
    </div>
</div>

<!-- Payment Method Selection Modal -->
<div id="paymentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closePaymentModal()">&times;</span>
        <h2>Choisissez votre mode de paiement</h2>
        <p class="invoice-amount">Montant à payer: <span id="modalAmount"></span></p>
        <p class="invoice-ref">Facture: <span id="modalInvoiceNumber"></span></p>
        
        <div class="payment-methods">
            <button class="payment-method-btn" onclick="initiateOnlinePayment()">
                <i class="fas fa-credit-card"></i>
                <div>
                    <strong>Payer en ligne</strong>
                    <small>Via FedaPay (Carte bancaire, Mobile Money)</small>
                </div>
            </button>
            
            <button class="payment-method-btn" onclick="requestCashPayment()">
                <i class="fas fa-money-bill-wave"></i>
                <div>
                    <strong>Payer en espèces</strong>
                    <small>Sur place - nécessite une approbation</small>
                </div>
            </button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.invoice-amount {
    font-size: 1.3em;
    font-weight: bold;
    color: #2c3e50;
    margin: 15px 0;
}

.invoice-ref {
    color: #7f8c8d;
    margin-bottom: 25px;
}

.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.payment-method-btn {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-method-btn:hover {
    border-color: #4CAF50;
    background: #f0f8f0;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.payment-method-btn i {
    font-size: 2em;
    color: #4CAF50;
}

.payment-method-btn strong {
    display: block;
    font-size: 1.1em;
    margin-bottom: 5px;
}

.payment-method-btn small {
    color: #666;
}

.btn-pay {
    background: #4CAF50;
    color: white;
    border: none;
}

.btn-pay:hover {
    background: #45a049;
}
</style>

<script>
let currentInvoiceId = null;
let currentInvoiceAmount = null;
let currentInvoiceNumber = null;
let currentInvoiceType = null;

function showPaymentModal(invoiceId, amount, invoiceNumber, invoiceType) {
    currentInvoiceId = invoiceId;
    currentInvoiceAmount = amount;
    currentInvoiceNumber = invoiceNumber;
    currentInvoiceType = invoiceType;
    
    document.getElementById('modalAmount').textContent = amount;
    document.getElementById('modalInvoiceNumber').textContent = invoiceNumber;
    document.getElementById('paymentModal').style.display = 'block';
}

function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    currentInvoiceId = null;
    currentInvoiceAmount = null;
    currentInvoiceNumber = null;
    currentInvoiceType = null;
}

async function initiateOnlinePayment() {
    closePaymentModal();
    
    // Redirect to FedaPay payment page
    try {
        const response = await fetch(`/api/v1/payments/initiate-invoice-payment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({
                invoice_id: currentInvoiceId,
                payment_method: 'online'
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.payment_url) {
            window.location.href = data.payment_url;
        } else {
            alert('Erreur lors de l\'initialisation du paiement: ' + (data.error || 'Erreur inconnue'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion. Veuillez réessayer.');
    }
}

async function requestCashPayment() {
    closePaymentModal();
    
    if (!confirm('Vous allez demander un paiement en espèces. Le fournisseur de service devra approuver ce paiement sur place.\n\nConfirmer?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/payments/request-cash-payment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({
                receipt_id: currentInvoiceId,
                payment_method: 'cash'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✓ Demande de paiement envoyée!\n\nLe fournisseur de service recevra votre demande et pourra approuver le paiement une fois sur place.');
            window.location.reload();
        } else {
            alert('Erreur: ' + (data.error || 'La demande a échoué'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur de connexion. Veuillez réessayer.');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<script src="{% static 'js/payments/receipt.js' %}"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
</body>
</html>

